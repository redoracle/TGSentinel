{% extends "base.html" %}
{% block title %}Feeds ¬∑ TG Sentinel{% endblock %}

{% block content %}
<section class="row g-4 mb-4">
    <div class="col-12">
        <article class="card" aria-labelledby="feeds-heading">
            <div class="card-header">
                <button class="text-start p-0 d-flex align-items-center gap-2 border-0 bg-transparent text-decoration-none text-reset" type="button" data-bs-toggle="collapse" data-bs-target="#feeds-body" aria-expanded="true" aria-controls="feeds-body">
                    <i class="bi bi-chevron-right collapse-icon fs-7"></i>
                    <div>
                        <h1 class="card-title mb-0" id="feeds-heading">Message Feeds</h1>
                        <small class="text-muted">View triggered alerts and interest profile matches</small>
                    </div>
                </button>
            </div>
            <div class="collapse show card-body p-0" id="feeds-body">
                <!-- Tabs Navigation -->
                <ul class="nav nav-tabs px-3 pt-3" id="feedsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts-panel" type="button" role="tab" aria-controls="alerts-panel" aria-selected="true">
                            <i class="bi bi-bell-fill me-2"></i>Alerts Feed
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="interests-tab" data-bs-toggle="tab" data-bs-target="#interests-panel" type="button" role="tab" aria-controls="interests-panel" aria-selected="false">
                            <i class="bi bi-lightbulb-fill me-2"></i>Interests Feed
                        </button>
                    </li>
                </ul>

                <!-- Tabs Content -->
                <div class="tab-content" id="feedsTabsContent">
                    <!-- Alerts Panel -->
                    <div class="tab-pane fade show active" id="alerts-panel" role="tabpanel" aria-labelledby="alerts-tab">
                        <div class="d-flex justify-content-between align-items-center gap-3 px-3 pt-3 pb-2 border-bottom">
                            <div>
                                <h2 class="h6 mb-0">Alert Profile Triggers</h2>
                                <small class="text-muted">High-priority notifications from Alert Profiles</small>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="/docs#alerts-api" class="btn btn-outline-primary btn-sm" title="View alerts documentation" target="_blank" rel="noopener">
                                    <i class="bi bi-info-circle"></i>
                                </a>
                                <button class="btn btn-outline-primary btn-sm" type="button" id="btn-export-alerts">Export CSV</button>
                                <button class="btn btn-outline-primary btn-sm" type="button" id="btn-refresh-alerts">Refresh</button>
                            </div>
                        </div>
                        <div class="alerts-list-container" id="alerts-list-container">
                            <div class="list-group list-group-flush" id="alerts-list">
                                {%- for alert in alerts %}
                                <div class="list-group-item list-group-item-action alert-list-item" data-alert-id="{{ alert.msg_id }}">
                                    <div class="d-flex w-100 justify-content-between align-items-start gap-3">
                                        <div class="flex-grow-1 min-w-0">
                                            <!-- Channel and Sender -->
                                            <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                                                <a href="#" class="text-decoration-none channel-link fw-semibold" 
                                                   data-chat-id="{{ alert.chat_id }}" 
                                                   data-chat-name="{{ alert.chat_name | e }}" 
                                                   data-bs-toggle="modal" 
                                                   data-bs-target="#channelActionsModal"
                                                   title="Click to manage channel">
                                                    {{ alert.chat_name }}
                                                </a>
                                                <span class="text-muted">‚Ä¢</span>
                                                <small class="text-muted">{{ alert.sender | default("Unknown") }}</small>
                                                <span class="badge bg-danger ms-auto">{{ '%.2f'|format(alert.score) }}</span>
                                            </div>
                                            
                                            <!-- Message Excerpt -->
                                            <p class="mb-2 text-truncate" 
                                               data-bs-toggle="tooltip"
                                               data-bs-placement="auto"
                                               data-bs-custom-class="excerpt-tooltip"
                                               data-bs-title="{{ (alert.message_text or alert.excerpt) | e }}">
                                                {{ alert.excerpt }}
                                            </p>
                                            
                                            <!-- Metadata Row -->
                                            <div class="d-flex gap-2 flex-wrap align-items-center">
                                                {% if alert.trigger and alert.trigger != 'N/A' %}
                                                <small class="text-muted">üîî {{ alert.trigger|e }}</small>
                                                {% endif %}
                                                {% if alert.matched_profiles %}
                                                <small class="text-primary">
                                                    üìã Profiles: 
                                                    {% for profile_id in alert.matched_profiles %}
                                                        <span class="badge bg-primary">{{ profile_id }}</span>{% if not loop.last %}, {% endif %}
                                                    {% endfor %}
                                                </small>
                                                {% endif %}
                                                {% if alert.semantic_scores %}
                                                <small class="text-info" data-bs-toggle="tooltip" data-bs-html="true" 
                                                       data-bs-title="Semantic scores: {% for pid, score in alert.semantic_scores.items() %}{{ pid }}={{ '%.3f'|format(score) }}{% if not loop.last %}, {% endif %}{% endfor %}">
                                                    üß† {{ alert.semantic_scores|length }} semantic
                                                </small>
                                                {% endif %}
                                                {% set _date = alert.created_at.split(' ')[0] if alert.created_at else '' %}
                                                {% set _time = alert.created_at.split(' ')[1] if alert.created_at and alert.created_at.split(' ')|length > 1 else '' %}
                                                {% if alert.created_at %}
                                                <small class="text-muted" 
                                                       data-bs-toggle="tooltip"
                                                       data-bs-html="true"
                                                       data-bs-placement="top"
                                                       data-bs-title='<div><div><strong>Date:</strong> {{ _date }}</div><div><strong>Time:</strong> {{ _time }}</div><div><strong>Destination:</strong> {{ alert.sent_to }}</div></div>'>
                                                    ‚è∞ {{ _date }} {{ _time }}
                                                </small>
                                                {% endif %}
                                                {% set webhook_payload = {
                                                    "event": "alert_triggered",
                                                    "chat_id": alert.chat_id,
                                                    "chat_name": alert.chat_name,
                                                    "message_id": alert.msg_id | default(0),
                                                    "sender": alert.sender,
                                                    "score": alert.score,
                                                    "matched_profiles": alert.matched_profiles or [],
                                                    "triggers": alert.trigger,
                                                    "text_preview": alert.excerpt,
                                                    "sent_to": alert.sent_to
                                                } %}
                                                <span class="text-info badge-raised"
                                                      role="img"
                                                      aria-label="Webhook payload"
                                                      data-bs-toggle="tooltip"
                                                      data-bs-placement="top"
                                                      data-bs-html="true"
                                                      data-bs-title="{{ webhook_payload | tojson | e }}">
                                                    <i class="bi bi-webhook"></i>
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <!-- Feedback Actions -->
                                        <div class="d-flex flex-column gap-2">
                                            <div class="btn-group btn-group-sm" role="group" aria-label="Feedback controls">
                                                {% set alert_profiles_json = (alert.matched_profiles or []) | tojson | e %}
                                                <button class="btn btn-outline-warning btn-feedback"
                                                        data-score="up"
                                                        data-chat-id="{{ alert.chat_id }}"
                                                        data-msg-id="{{ alert.msg_id | default(0) }}"
                                                        data-feed-type="alert"
                                                        data-semantic-type="alert_keyword"
                                                        data-profiles='{{ alert_profiles_json }}'
                                                        type="button"
                                                        aria-label="Give positive feedback"
                                                        title="Helpful">üëç</button>
                                                <button class="btn btn-outline-warning btn-feedback"
                                                        data-score="down"
                                                        data-chat-id="{{ alert.chat_id }}"
                                                        data-msg-id="{{ alert.msg_id | default(0) }}"
                                                        data-feed-type="alert"
                                                        data-semantic-type="alert_keyword"
                                                        data-profiles='{{ alert_profiles_json }}'
                                                        type="button"
                                                        aria-label="Give negative feedback"
                                                        title="Not helpful">üëé</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {%- else %}
                                <div class="alert-profiles-empty">
                                    <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                                    </svg>
                                    <p class="mb-2">No Alerts Yet</p>
                                    <small>Alerts will appear here once heuristics fire.</small>
                                </div>
                                {%- endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Interests Panel -->
                    <div class="tab-pane fade" id="interests-panel" role="tabpanel" aria-labelledby="interests-tab">
                        <div class="d-flex justify-content-between align-items-center gap-3 px-3 pt-3 pb-2 border-bottom">
                            <div>
                                <h2 class="h6 mb-0">Interest Profile Matches</h2>
                                <small class="text-muted">Semantically relevant content from Interest Profiles</small>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="/docs#interests-api" class="btn btn-outline-primary btn-sm" title="View interests documentation" target="_blank" rel="noopener">
                                    <i class="bi bi-info-circle"></i>
                                </a>
                                <button class="btn btn-outline-primary btn-sm" type="button" id="btn-export-interests">Export CSV</button>
                                <button class="btn btn-outline-primary btn-sm" type="button" id="btn-refresh-interests">Refresh</button>
                            </div>
                        </div>
                        <div class="interests-list-container" id="interests-list-container">
                            <div class="list-group list-group-flush" id="interests-list">
                                {%- for interest in interests %}
                                <div class="list-group-item list-group-item-action alert-list-item" data-interest-id="{{ interest.msg_id }}">
                                    <div class="d-flex w-100 justify-content-between align-items-start gap-3">
                                        <div class="flex-grow-1 min-w-0">
                                            <!-- Channel and Sender -->
                                            <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                                                <a href="#" class="text-decoration-none channel-link fw-semibold" 
                                                   data-chat-id="{{ interest.chat_id }}" 
                                                   data-chat-name="{{ interest.chat_name | e }}" 
                                                   data-bs-toggle="modal" 
                                                   data-bs-target="#channelActionsModal"
                                                   title="Click to manage channel">
                                                    {{ interest.chat_name }}
                                                </a>
                                                <span class="text-muted">‚Ä¢</span>
                                                <small class="text-muted">{{ interest.sender | default("Unknown") }}</small>
                                                <span class="badge bg-info ms-auto" title="{{ interest.profile_name }}">{{ '%.2f'|format(interest.score) }}</span>
                                            </div>
                                            
                                            <!-- Message Excerpt -->
                                            <p class="mb-2 text-truncate" 
                                               data-bs-toggle="tooltip"
                                               data-bs-placement="auto"
                                               data-bs-custom-class="excerpt-tooltip"
                                               data-bs-title="{{ (interest.message_text or interest.excerpt) | e }}">
                                                {{ interest.excerpt }}
                                            </p>
                                            
                                            <!-- Metadata Row -->
                                            <div class="d-flex gap-2 flex-wrap align-items-center">
                                                {% if interest.matched_profiles and interest.matched_profiles|length > 0 %}
                                                <small class="text-info">
                                                    üí° Profiles: 
                                                    {% for mp in interest.matched_profiles %}
                                                        <span class="badge bg-info" title="{{ mp.profile_name }}: {{ '%.3f'|format(mp.semantic_score) }} (threshold: {{ mp.threshold }})">{{ mp.profile_name }}</span>{% if not loop.last %} {% endif %}
                                                    {% endfor %}
                                                </small>
                                                {% endif %}
                                                {% set _date = interest.created_at.split(' ')[0] if interest.created_at else '' %}
                                                {% set _time = interest.created_at.split(' ')[1] if interest.created_at and interest.created_at.split(' ')|length > 1 else '' %}
                                                {% if interest.created_at %}
                                                <small class="text-muted" 
                                                       data-bs-toggle="tooltip"
                                                       data-bs-html="true"
                                                       data-bs-placement="top"
                                                       data-bs-title='<div><div><strong>Date:</strong> {{ _date }}</div><div><strong>Time:</strong> {{ _time }}</div></div>'>
                                                    ‚è∞ {{ _date }} {{ _time }}
                                                </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Feedback Actions -->
                                        <div class="d-flex flex-column gap-2">
                                            <div class="btn-group btn-group-sm" role="group" aria-label="Feedback controls">
                                                {% set interest_profiles_json = (interest.matched_profiles or []) | tojson | e %}
                                                <button class="btn btn-outline-warning btn-feedback"
                                                        data-score="up"
                                                        data-chat-id="{{ interest.chat_id }}"
                                                        data-msg-id="{{ interest.msg_id | default(0) }}"
                                                        data-feed-type="interest"
                                                        data-semantic-type="interest_semantic"
                                                        data-profiles='{{ interest_profiles_json }}'
                                                        type="button"
                                                        aria-label="Give positive feedback"
                                                        title="Helpful">üëç</button>
                                                <button class="btn btn-outline-warning btn-feedback"
                                                        data-score="down"
                                                        data-chat-id="{{ interest.chat_id }}"
                                                        data-msg-id="{{ interest.msg_id | default(0) }}"
                                                        data-feed-type="interest"
                                                        data-semantic-type="interest_semantic"
                                                        data-profiles='{{ interest_profiles_json }}'
                                                        type="button"
                                                        aria-label="Give negative feedback"
                                                        title="Not helpful">üëé</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {%- else %}
                                <div class="alert-profiles-empty">
                                    <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                                    </svg>
                                    <p class="mb-2">No Interest Matches Yet</p>
                                    <small>Interest Profile matches will appear here once semantic scoring identifies relevant content.</small>
                                </div>
                                {%- endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </article>
    </div>
</section>

<section class="row g-4 mb-4">
    <div class="col-12">
        <article class="card" aria-labelledby="digest-timeline-heading">
            <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-3">
                <button class="text-start p-0 d-flex align-items-center gap-2 border-0 bg-transparent text-decoration-none text-reset" type="button" data-bs-toggle="collapse" data-bs-target="#digest-timeline-body" aria-expanded="true" aria-controls="digest-timeline-body">
                    <i class="bi bi-chevron-right collapse-icon fs-7"></i>
                    <div>
                        <h2 class="card-title mb-0" id="digest-timeline-heading">Digest Timeline</h2>
                        <small class="text-muted">Aggregated message batches</small>
                    </div>
                </button>
                <div class="d-flex gap-2">
                    <a href="/docs#digest-api" class="btn btn-outline-primary btn-sm" title="View digest documentation" target="_blank" rel="noopener">
                        <i class="bi bi-info-circle"></i>
                    </a>
                    <button class="btn btn-outline-primary btn-sm" type="button" id="btn-download-digest">Download JSON</button>
                    <button class="btn btn-outline-success btn-sm" type="button" id="btn-trigger-alerts-digest" title="Send manual alerts digest">Alerts Digest</button>
                    <button class="btn btn-outline-success btn-sm" type="button" id="btn-trigger-interests-digest" title="Send manual interests digest">Interests Digest</button>
                </div>
            </div>
            <div class="collapse show card-body" id="digest-timeline-body">
                <h5 class="mb-3">Sent Digest Batches</h5>
                <div id="digest-timeline">
                    <div class="text-center text-muted">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        Loading digest history...
                    </div>
                </div>
            </div>
        </article>
    </div>
</section>

<!-- Channel Quick Actions Modal (shared by both feeds) -->
<div class="modal fade" id="channelActionsModal" tabindex="-1" aria-labelledby="channelActionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="channelActionsModalLabel">
                    <i class="bi bi-gear-fill me-2"></i>
                    <span id="modal-channel-name">Channel Actions</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Channel/User Information Display -->
                <div class="row g-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="bi bi-info-circle-fill me-2"></i>Information
                                </h6>
                                <dl class="row mb-0">
                                    <dt class="col-sm-4">Name:</dt>
                                    <dd class="col-sm-8" id="modal-info-chat-name">‚Äî</dd>
                                    
                                    <dt class="col-sm-4">Chat ID:</dt>
                                    <dd class="col-sm-8">
                                        <code id="modal-info-chat-id">‚Äî</code>
                                        <button class="btn btn-sm btn-outline-secondary ms-2" id="copy-chat-id-btn" type="button" title="Copy to clipboard">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </dd>
                                    
                                    <dt class="col-sm-4">Status:</dt>
                                    <dd class="col-sm-8">
                                        <span class="badge" id="modal-info-monitoring-status">‚Äî</span>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="bi bi-envelope-fill me-2"></i>Latest Message Context
                                </h6>
                                <dl class="row mb-0">
                                    <dt class="col-sm-4">Sender:</dt>
                                    <dd class="col-sm-8" id="modal-info-sender">‚Äî</dd>
                                    
                                    <dt class="col-sm-4">Message ID:</dt>
                                    <dd class="col-sm-8"><code id="modal-info-msg-id">‚Äî</code></dd>
                                    
                                    <dt class="col-sm-4">Timestamp:</dt>
                                    <dd class="col-sm-8" id="modal-info-created-at">‚Äî</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-3 text-muted">
                                    <i class="bi bi-bar-chart-fill me-2"></i>Scoring & Profiles
                                </h6>
                                <dl class="row mb-0">
                                    <dt class="col-sm-4">Score:</dt>
                                    <dd class="col-sm-8">
                                        <span class="badge bg-primary" id="modal-info-score">‚Äî</span>
                                    </dd>
                                    
                                    <dt class="col-sm-4">Feed Type:</dt>
                                    <dd class="col-sm-8" id="modal-info-feed-type">‚Äî</dd>
                                    
                                    <dt class="col-sm-4">Trigger:</dt>
                                    <dd class="col-sm-8" id="modal-info-trigger">‚Äî</dd>
                                    
                                    <dt class="col-sm-4">Matched Profiles:</dt>
                                    <dd class="col-sm-8" id="modal-info-profiles">‚Äî</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="alert alert-light mb-0">
                            <small class="text-muted">
                                <i class="bi bi-lightbulb me-1"></i>
                                <strong>Tip:</strong> To manage this channel's monitoring settings, visit the 
                                <a href="/config" class="alert-link">Configuration</a> page.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="close-channel-modal-btn">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/feed-renderer.js') }}"></script>
<script src="{{ url_for('static', filename='js/feeds.js') }}"></script>
{% endblock %}
