{% extends "base.html" %}
{% block title %}Message Formats ¬∑ TG Sentinel{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.min.css" />
{% endblock %}

{% block content %}
<!-- Header Card with Tabs -->
<section class="card mb-4">
    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div>
            <h1 class="card-title mb-0">Message Formats</h1>
            <small class="text-muted">Customize alert and digest message templates</small>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#variablesModal" title="View all available variables">
                <i class="bi bi-code-slash"></i> All Variables
            </button>
            <button class="btn btn-outline-secondary btn-sm" type="button" id="btn-export-formats" title="Export formats as YAML">
                <i class="bi bi-download"></i> Export
            </button>
            <button class="btn btn-outline-secondary btn-sm" type="button" id="btn-import-formats" title="Import formats from YAML">
                <i class="bi bi-upload"></i> Import
            </button>
            <button class="btn btn-outline-warning btn-sm" type="button" id="btn-reset-formats" title="Reset to defaults">
                <i class="bi bi-arrow-counterclockwise"></i> Reset
            </button>
            <button class="btn btn-primary btn-sm" type="button" id="btn-save-formats">
                <i class="bi bi-save"></i> Save All
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <ul class="nav nav-tabs nav-fill border-bottom-0" id="format-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dm-alerts-tab" data-bs-toggle="tab" data-bs-target="#dm-alerts-content" type="button" role="tab" aria-controls="dm-alerts-content" aria-selected="true">
                    <i class="bi bi-bell me-2"></i>DM Notification
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="saved-messages-tab" data-bs-toggle="tab" data-bs-target="#saved-messages-content" type="button" role="tab" aria-controls="saved-messages-content" aria-selected="false">
                    <i class="bi bi-bookmark me-2"></i>Saved Messages
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="digest-tab" data-bs-toggle="tab" data-bs-target="#digest-content" type="button" role="tab" aria-controls="digest-content" aria-selected="false">
                    <i class="bi bi-newspaper me-2"></i>Digest
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="webhook-tab" data-bs-toggle="tab" data-bs-target="#webhook-content" type="button" role="tab" aria-controls="webhook-content" aria-selected="false">
                    <i class="bi bi-plug me-2"></i>Webhooks
                </button>
            </li>
        </ul>
    </div>
</section>

<!-- Tab Contents -->
<div class="tab-content" id="format-tabs-content">
    <!-- DM Notification Tab -->
    <div class="tab-pane fade show active" id="dm-alerts-content" role="tabpanel" aria-labelledby="dm-alerts-tab">
        <div class="format-section">
            <!-- Section Header -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h5 class="card-title mb-1">DM Notification Template</h5>
                    <p class="text-muted small mb-0">Format for instant alerts sent to you or a target channel</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" type="button" data-format-type="dm_alerts" data-action="preview">
                        <i class="bi bi-eye"></i> Preview
                    </button>
                    <button class="btn btn-outline-success btn-sm" type="button" data-format-type="dm_alerts" data-action="test">
                        <i class="bi bi-send"></i> Test
                    </button>
                </div>
            </div>
            <div class="row g-4">
                <!-- Editor Column -->
                <div class="col-12 col-xl-6">
                    <div id="editor-dm-alerts" class="format-editor-container format-editor-height-280"></div>
                </div>
                <!-- Preview Column -->
                <div class="col-12 col-xl-6">
                    <div id="preview-dm-alerts" class="preview-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Saved Messages Tab -->
    <div class="tab-pane fade" id="saved-messages-content" role="tabpanel" aria-labelledby="saved-messages-tab">
        <div class="format-section">
            <!-- Section Header -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h5 class="card-title mb-1">Saved Messages Template</h5>
                    <p class="text-muted small mb-0">Format for messages saved to Telegram's Saved Messages</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" type="button" data-format-type="saved_messages" data-action="preview">
                        <i class="bi bi-eye"></i> Preview
                    </button>
                    <button class="btn btn-outline-success btn-sm" type="button" data-format-type="saved_messages" data-action="test">
                        <i class="bi bi-send"></i> Test
                    </button>
                </div>
            </div>
            <div class="row g-4">
                <!-- Editor Column -->
                <div class="col-12 col-xl-6">
                    <div id="editor-saved-messages" class="format-editor-container format-editor-height-280"></div>
                </div>
                <!-- Preview Column -->
                <div class="col-12 col-xl-6">
                    <div id="preview-saved-messages" class="preview-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Digest Tab -->
    <div class="tab-pane fade" id="digest-content" role="tabpanel" aria-labelledby="digest-tab">
        <!-- Digest Header Section -->
        <div class="format-section mb-4">
            <!-- Section Header -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h5 class="card-title mb-1">Digest Header</h5>
                    <p class="text-muted small mb-0">Header shown at the top of digest messages</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" type="button" data-format-type="digest.header" data-action="preview">
                        <i class="bi bi-eye"></i> Preview
                    </button>
                </div>
            </div>
            <div class="row g-4">
                <!-- Editor Column -->
                <div class="col-12 col-xl-6">
                    <div id="editor-digest-header" class="format-editor-container format-editor-height-180"></div>
                </div>
                <!-- Preview Column -->
                <div class="col-12 col-xl-6">
                    <div id="preview-digest-header" class="preview-container preview-min-height-100"></div>
                </div>
            </div>
        </div>
        
        <!-- Digest Entry Section -->
        <div class="format-section mb-4">
            <!-- Section Header -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h5 class="card-title mb-1">Digest Entry</h5>
                    <p class="text-muted small mb-0">Format for each message in the digest</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" type="button" data-format-type="digest.entry" data-action="preview">
                        <i class="bi bi-eye"></i> Preview
                    </button>
                    <button class="btn btn-outline-success btn-sm" type="button" data-format-type="digest.entry" data-action="test">
                        <i class="bi bi-send"></i> Test
                    </button>
                </div>
            </div>
            <div class="row g-4">
                <!-- Editor Column -->
                <div class="col-12 col-xl-6">
                    <div id="editor-digest-entry" class="format-editor-container format-editor-height-280"></div>
                </div>
                <!-- Preview Column -->
                <div class="col-12 col-xl-6">
                    <div id="preview-digest-entry" class="preview-container"></div>
                </div>
            </div>
        </div>
        
        <!-- Recent Messages Section -->
        <div class="format-section">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h5 class="card-title mb-1"><i class="bi bi-clock-history me-2"></i>Recent Messages</h5>
                    <p class="text-muted small mb-0">Latest stored messages that would appear in digests</p>
                </div>
                <button class="btn btn-outline-primary btn-sm" type="button" id="btn-refresh-messages">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div id="recent-messages-container" class="border rounded p-3 recent-messages-scroll">
                <div class="text-center text-muted py-4" id="messages-loading">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Loading messages...
                </div>
                <div id="messages-list" class="d-none"></div>
                <div id="messages-empty" class="text-center text-muted py-4 d-none">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    No messages found. Messages will appear here once alerts are triggered.
                </div>
            </div>
        </div>
    </div>

    <!-- Webhook Tab -->
    <div class="tab-pane fade" id="webhook-content" role="tabpanel" aria-labelledby="webhook-tab">
        <div class="format-section">
            <!-- Section Header -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h5 class="card-title mb-1">JSON Payload Template</h5>
                    <p class="text-muted small mb-0">JSON structure sent to webhook endpoints</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm" type="button" data-format-type="webhook_payload" data-action="preview">
                        <i class="bi bi-eye"></i> Preview
                    </button>
                </div>
            </div>
            <div class="row g-4">
                <!-- Editor Column -->
                <div class="col-12 col-xl-6">
                    <div id="editor-webhook" class="format-editor-container format-editor-height-400"></div>
                </div>
                <!-- Preview Column -->
                <div class="col-12 col-xl-6">
                    <div id="preview-webhook" class="preview-container preview-webhook-monospace"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden file input for import -->
<label for="import-file-input" class="visually-hidden">Import message format configuration file</label>
<input type="file" id="import-file-input" accept=".yml,.yaml" class="d-none" aria-label="Import message format configuration file">

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetModalLabel">Reset Message Formats</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to reset all message formats to defaults?</p>
                <p class="text-muted small">This will overwrite any customizations you've made. A backup will be created automatically.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="btn-confirm-reset">Reset to Defaults</button>
            </div>
        </div>
    </div>
</div>

<!-- Unified Variables Reference Modal -->
<div class="modal fade" id="variablesModal" tabindex="-1" aria-labelledby="variablesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="variablesModalLabel">
                    <i class="bi bi-code-slash me-2"></i>Available Variables - Quick Reference
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Template Syntax Guide -->
                <div class="alert alert-info mb-4">
                    <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Template Syntax</h6>
                    <dl class="row mb-0 small">
                        <dt class="col-sm-4"><code>{var}</code></dt>
                        <dd class="col-sm-8">Required variable</dd>
                        
                        <dt class="col-sm-4"><code>{?var}</code></dt>
                        <dd class="col-sm-8">Optional (empty if missing)</dd>
                        
                        <dt class="col-sm-4"><code>{var:.2f}</code></dt>
                        <dd class="col-sm-8">Format specifier (2 decimals)</dd>
                        
                        <dt class="col-sm-4"><code>{var|filter}</code></dt>
                        <dd class="col-sm-8">Apply filter (date, time, relative, link)</dd>
                        
                        <dt class="col-sm-4"><code>{?var|filter:.2f}</code></dt>
                        <dd class="col-sm-8">Combine all features</dd>
                    </dl>
                </div>

                <!-- Available Filters -->
                <div class="card mb-4">
                    <div class="card-header">
                        <strong><i class="bi bi-funnel me-2"></i>Available Filters</strong>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0 small">
                            <dt class="col-sm-3"><code>|date</code></dt>
                            <dd class="col-sm-9">"Jan 15, 2024"</dd>
                            
                            <dt class="col-sm-3"><code>|time</code></dt>
                            <dd class="col-sm-9">"14:30"</dd>
                            
                            <dt class="col-sm-3"><code>|datetime</code></dt>
                            <dd class="col-sm-9">"Jan 15, 2024 14:30"</dd>
                            
                            <dt class="col-sm-3"><code>|relative</code></dt>
                            <dd class="col-sm-9">"2h ago", "3d ago"</dd>
                            
                            <dt class="col-sm-3"><code>|link</code></dt>
                            <dd class="col-sm-9">[View](url) - Markdown clickable link</dd>
                        </dl>
                    </div>
                </div>

                <div id="variablesModalContent" class="accordion" aria-live="polite"></div>

                <!-- Examples Section -->
                <div class="card mt-4">
                    <div class="card-header">
                        <strong><i class="bi bi-lightbulb me-2"></i>Common Examples</strong>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Show optional scores:</strong>
                            <pre class="bg-dark text-light p-2 rounded small mb-1"><code>üß† {?semantic_score:.2f} üîë {?keyword_score:.2f}</code></pre>
                            <small class="text-muted">Only displays scores if available</small>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Format timestamps:</strong>
                            <pre class="bg-dark text-light p-2 rounded small mb-1"><code>üìÖ {timestamp|relative} üïê {timestamp|time}</code></pre>
                            <small class="text-muted">Shows "2h ago" and "14:30"</small>
                        </div>
                        
                        <div class="mb-3">
                            <strong>Clickable message link:</strong>
                            <pre class="bg-dark text-light p-2 rounded small mb-1"><code>üîó {message_link|link}</code></pre>
                            <small class="text-muted">Renders as Telegram Markdown link [View](url)</small>
                        </div>
                        
                        <div>
                            <strong>Combine features:</strong>
                            <pre class="bg-dark text-light p-2 rounded small mb-1"><code>{rank}. üí¨ **{chat_title}** ({?semantic_score|label:"AI":.2f})</code></pre>
                            <small class="text-muted">Message rank, bold title, optional AI score</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Monaco Editor loader (only load once globally) -->
<script>
if (!window.__monacoLoaderPromise) {
    window.__monacoLoaderPromise = new Promise((resolve, reject) => {
        const loaderScript = document.createElement('script');
        loaderScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js';
        loaderScript.async = true;
        loaderScript.onload = () => resolve();
        loaderScript.onerror = (err) => {
            console.error('[TG Sentinel] Failed to load Monaco loader', err);
            reject(err);
        };
        document.head.appendChild(loaderScript);
    });
}
</script>
<script src="{{ url_for('static', filename='js/developer/message_formats.js') }}"></script>
{% endblock %}
