{% extends "base.html" %}
{% block title %}Profiles Â· TG Sentinel{% endblock %}

{% block content %}
<!-- Two-Tab Navigation -->
<section class="card mb-4">
    <div class="card-header">
        <h1 class="card-title mb-0">Profile Management</h1>
        <small class="text-muted">Configure keyword-based and semantic interest profiles</small>
    </div>
    <div class="card-body p-0">
        <ul class="nav nav-tabs nav-fill border-bottom-0" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="alert-profiles-tab" data-bs-toggle="tab" data-bs-target="#alert-profiles" type="button" role="tab" aria-controls="alert-profiles" aria-selected="true">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-bell me-2" viewBox="0 0 16 16">
                        <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                    </svg>
                    Alert Profiles
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="global-profiles-tab" data-bs-toggle="tab" data-bs-target="#global-profiles" type="button" role="tab" aria-controls="global-profiles" aria-selected="false">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-collection me-2" viewBox="0 0 16 16">
                        <path d="M2.5 3.5a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1h-11zm2-2a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1h-7zM0 13a1.5 1.5 0 0 0 1.5 1.5h13A1.5 1.5 0 0 0 16 13V6a1.5 1.5 0 0 0-1.5-1.5h-13A1.5 1.5 0 0 0 0 6v7zm1.5.5A.5.5 0 0 1 1 13V6a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13z"/>
                    </svg>
                    Global Profiles
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="interest-profiles-tab" data-bs-toggle="tab" data-bs-target="#interest-profiles" type="button" role="tab" aria-controls="interest-profiles" aria-selected="false">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-brain me-2" viewBox="0 0 16 16">
                        <path d="M5.5 2a.5.5 0 0 0-1 0v11a.5.5 0 0 0 1 0v-11zm5 0a.5.5 0 0 0-1 0v11a.5.5 0 0 0 1 0v-11zm-4 1.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5zm3 0a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5z"/>
                    </svg>
                    Interest Profiles
                </button>
            </li>
        </ul>
    </div>
</section>

<div class="tab-content" id="profileTabsContent">
    <!-- Alert Profiles Tab -->
    <div class="tab-pane fade show active" id="alert-profiles" role="tabpanel" aria-labelledby="alert-profiles-tab">
        <section class="row g-4 mb-4">
            <div class="col-12 col-xl-4">
                <article class="card alert-profiles-list-card" aria-labelledby="alert-profiles-list-heading">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="card-title mb-0" id="alert-profiles-list-heading">Alert Profiles</h2>
                            <small class="text-muted"><span id="alert-profiles-count">0</span> profiles</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" type="button" id="btn-alert-bulk-actions" title="Bulk actions">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                                </svg>
                            </button>
                            <button class="btn btn-sm btn-primary" type="button" id="btn-new-alert-profile">
                                <svg width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                                </svg>
                                New
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Search/Filter Bar -->
                        <div class="p-3 border-bottom">
                            <input type="text" class="form-control form-control-sm" id="alert-profiles-search" placeholder="ðŸ” Search profiles...">
                        </div>
                        <!-- Profiles List with virtualized scrolling -->
                        <div class="alert-profiles-list-container" id="alert-profiles-list-container">
                            <div class="list-group list-group-flush" id="alert-profiles-list">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                    </div>
                </article>
            </div>
            <div class="col-12 col-xl-8">
                <article class="card h-100" aria-labelledby="alert-profile-editor-heading">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title mb-0" id="alert-profile-editor-heading">Alert Profile Editor</h2>
                            <small class="text-muted">Configure keyword detection rules</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="alert-profile-form" class="d-grid gap-3" novalidate>
                            <input type="hidden" id="alert-profile-id" value="">
                            
                            <div class="alert alert-info" role="alert">
                                <strong>Select a profile</strong> from the list or create a new one to configure keyword-based detection.
                            </div>
                            
                            <!-- Basic Info -->
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label" for="alert-name">Profile Name <span class="text-danger">*</span></label>
                                    <input class="form-control" id="alert-name" name="name" type="text" placeholder="e.g., Security Alerts" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="alert-enabled">Status</label>
                                    <select class="form-select" id="alert-enabled" name="enabled">
                                        <option value="true" selected>Enabled</option>
                                        <option value="false">Disabled</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="form-label" for="alert-description">Description</label>
                                <input class="form-control" id="alert-description" name="description" type="text" placeholder="Brief description">
                            </div>
                            
                            <!-- Keywords Section -->
                            <div class="border-top pt-3">
                                <h3 class="h6 mb-3">Keyword Detection</h3>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-critical-keywords">Critical Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-critical-keywords" name="critical_keywords" rows="3" placeholder="exploit, breach, hack"></textarea>
                                        <small class="text-muted">Comma-separated. Highest priority.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-security-keywords">Security Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-security-keywords" name="security_keywords" rows="3" placeholder="vulnerability, attack, malicious"></textarea>
                                        <small class="text-muted">Security-related terms.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-urgency-keywords">Urgency Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-urgency-keywords" name="urgency_keywords" rows="3" placeholder="urgent, asap, critical"></textarea>
                                        <small class="text-muted">Time-sensitive indicators.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-financial-keywords">Financial Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-financial-keywords" name="financial_keywords" rows="3" placeholder="price, market, trading"></textarea>
                                        <small class="text-muted">Market and financial terms.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-technical-keywords">Technical Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-technical-keywords" name="technical_keywords" rows="3" placeholder="update, upgrade, release"></textarea>
                                        <small class="text-muted">Development and tech terms.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-project-keywords">Project Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-project-keywords" name="project_keywords" rows="3" placeholder="algorand, algo, governance"></textarea>
                                        <small class="text-muted">Project-specific terms.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-community-keywords">Community Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-community-keywords" name="community_keywords" rows="3" placeholder="announcement, airdrop, vote"></textarea>
                                        <small class="text-muted">Community engagement terms.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-general-keywords">General Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-general-keywords" name="general_keywords" rows="3" placeholder="news, update, important"></textarea>
                                        <small class="text-muted">General interest terms.</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detection Settings -->
                            <div class="border-top pt-3">
                                <h3 class="h6 mb-3">Detection Settings</h3>
                                
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label" for="alert-min-score">Minimum Score</label>
                                        <input class="form-control" id="alert-min-score" name="min_score" type="number" min="0" max="10" step="0.1" value="1.0">
                                        <small class="text-muted">Threshold for alerts (0-10)</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="alert-vip-senders">VIP Senders</label>
                                        <input class="form-control font-monospace" id="alert-vip-senders" name="vip_senders" type="text" placeholder="@username1, @username2">
                                        <small class="text-muted">Always alert from these</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="alert-excluded-users">Excluded Users</label>
                                        <input class="form-control font-monospace" id="alert-excluded-users" name="excluded_users" type="text" placeholder="@spammer, @bot">
                                        <small class="text-muted">Never alert from these</small>
                                    </div>
                                </div>
                                
                                <div class="row g-3 mt-2">
                                    <div class="col-md-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="alert-detect-questions" name="detect_questions">
                                            <label class="form-check-label" for="alert-detect-questions">Detect Questions</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="alert-detect-mentions" name="detect_mentions">
                                            <label class="form-check-label" for="alert-detect-mentions">Detect Mentions</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="alert-detect-links" name="detect_links">
                                            <label class="form-check-label" for="alert-detect-links">Detect Links</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="alert-require-forwarded" name="require_forwarded">
                                            <label class="form-check-label" for="alert-require-forwarded">Only Forwards</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex gap-3 border-top pt-3">
                                <button class="btn btn-primary" type="submit" id="btn-save-alert-profile">
                                    <span id="alert-save-btn-text">Save Profile</span>
                                </button>
                                <button class="btn btn-outline-primary" type="button" id="btn-backtest-alert-profile">
                                    <svg width="16" height="16" fill="currentColor" class="bi bi-speedometer me-1" viewBox="0 0 16 16">
                                        <path d="M8 2a.5.5 0 0 1 .5.5V4a.5.5 0 0 1-1 0V2.5A.5.5 0 0 1 8 2zM3.732 3.732a.5.5 0 0 1 .707 0l.915.914a.5.5 0 1 1-.708.708l-.914-.915a.5.5 0 0 1 0-.707zM2 8a.5.5 0 0 1 .5-.5h1.586a.5.5 0 0 1 0 1H2.5A.5.5 0 0 1 2 8zm9.5 0a.5.5 0 0 1 .5-.5h1.5a.5.5 0 0 1 0 1H12a.5.5 0 0 1-.5-.5zm.754-4.246a.389.389 0 0 0-.527-.02L7.547 7.31A.91.91 0 1 0 8.85 8.569l3.434-4.297a.389.389 0 0 0-.029-.518z"/>
                                        <path fill-rule="evenodd" d="M6.664 15.889A8 8 0 1 1 9.336.11a8 8 0 0 1-2.672 15.78zm-4.665-4.283A11.945 11.945 0 0 1 8 10c2.186 0 4.236.585 6.001 1.606a7 7 0 1 0-12.002 0z"/>
                                    </svg>
                                    Backtest
                                </button>
                                <button class="btn btn-outline-secondary" type="button" id="btn-reset-alert-profile">Clear</button>
                                <button class="btn btn-outline-danger d-none" type="button" id="btn-delete-alert-profile">Delete</button>
                            </div>
                        </form>
                    </div>
                </article>
            </div>
        </section>
    </div>
    
    <!-- Global Profiles Tab (Two-Layer Architecture) -->
    <div class="tab-pane fade" id="global-profiles" role="tabpanel" aria-labelledby="global-profiles-tab">
        <section class="row g-4 mb-4">
            <div class="col-12 col-xl-4">
                <article class="card global-profiles-list-card" aria-labelledby="global-profiles-list-heading">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="card-title mb-0" id="global-profiles-list-heading">Global Profiles</h2>
                            <small class="text-muted"><span id="global-profiles-count">0</span> profiles</small>
                        </div>
                        <button class="btn btn-sm btn-primary" type="button" id="btn-new-global-profile">
                            <svg width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                            </svg>
                            New Profile
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <!-- Search Bar -->
                        <div class="p-3 border-bottom">
                            <input type="text" class="form-control form-control-sm" id="global-profiles-search" placeholder="ðŸ” Search profiles...">
                        </div>
                        <!-- Profiles List -->
                        <div class="global-profiles-list-container" style="max-height: 600px; overflow-y: auto;">
                            <div class="list-group list-group-flush" id="global-profiles-list">
                                <!-- Populated dynamically -->
                                <div class="text-center text-muted p-4">
                                    <svg width="48" height="48" fill="currentColor" class="bi bi-collection mb-2" viewBox="0 0 16 16">
                                        <path d="M2.5 3.5a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1h-11zm2-2a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1h-7zM0 13a1.5 1.5 0 0 0 1.5 1.5h13A1.5 1.5 0 0 0 16 13V6a1.5 1.5 0 0 0-1.5-1.5h-13A1.5 1.5 0 0 0 0 6v7zm1.5.5A.5.5 0 0 1 1 13V6a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13z"/>
                                    </svg>
                                    <p>Loading profiles...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </article>
            </div>
            <div class="col-12 col-xl-8">
                <article class="card h-100" aria-labelledby="global-profile-editor-heading">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title mb-0" id="global-profile-editor-heading">Global Profile Editor</h2>
                            <small class="text-muted">Define reusable keyword profiles</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="global-profile-form" class="d-grid gap-3" novalidate>
                            <input type="hidden" id="global-profile-id" value="">
                            <input type="hidden" id="global-profile-mode" value="create">
                            
                            <div class="alert alert-info" role="alert" id="global-profile-empty-state">
                                <strong>Select a profile</strong> from the list or create a new one to configure global keyword profiles.
                            </div>
                            
                            <!-- Basic Info -->
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label" for="global-profile-id-input">Profile ID <span class="text-danger">*</span></label>
                                    <input class="form-control" id="global-profile-id-input" name="id" type="text" placeholder="e.g., security" required pattern="[a-z0-9_-]+">
                                    <small class="form-text">Lowercase alphanumeric, dashes, underscores only</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="global-profile-name">Profile Name <span class="text-danger">*</span></label>
                                    <input class="form-control" id="global-profile-name" name="name" type="text" placeholder="e.g., Security & Vulnerabilities" required>
                                </div>
                            </div>
                            
                            <!-- Keyword Categories -->
                            <div class="border rounded p-3 bg-dark">
                                <h3 class="h6 mb-3">Keyword Categories</h3>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label" for="global-keywords">
                                            <svg width="14" height="14" fill="currentColor" class="bi bi-search me-1" viewBox="0 0 16 16">
                                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                            </svg>
                                            General Keywords
                                        </label>
                                        <textarea class="form-control" id="global-keywords" name="keywords" rows="3" placeholder="vulnerability&#10;security&#10;exploit"></textarea>
                                        <small class="form-text">One keyword per line</small>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label" for="global-action-keywords">
                                            <svg width="14" height="14" fill="currentColor" class="bi bi-check-circle me-1" viewBox="0 0 16 16">
                                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                                <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                                            </svg>
                                            Action Keywords
                                        </label>
                                        <textarea class="form-control" id="global-action-keywords" name="action_keywords" rows="3" placeholder="download&#10;upgrade&#10;install"></textarea>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label" for="global-urgency-keywords">
                                            <svg width="14" height="14" fill="currentColor" class="bi bi-lightning me-1" viewBox="0 0 16 16">
                                                <path d="M5.52.359A.5.5 0 0 1 6 0h4a.5.5 0 0 1 .474.658L8.694 6H12.5a.5.5 0 0 1 .395.807l-7 9a.5.5 0 0 1-.873-.454L6.823 9.5H3.5a.5.5 0 0 1-.48-.641l2.5-8.5z"/>
                                            </svg>
                                            Urgency Keywords
                                        </label>
                                        <textarea class="form-control" id="global-urgency-keywords" name="urgency_keywords" rows="3" placeholder="urgent&#10;critical&#10;emergency"></textarea>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label" for="global-security-keywords">
                                            <svg width="14" height="14" fill="currentColor" class="bi bi-shield-lock me-1" viewBox="0 0 16 16">
                                                <path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 0 0 .101.025.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.159 7.159 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z"/>
                                                <path d="M9.5 6.5a1.5 1.5 0 0 1-1 1.415l.385 1.99a.5.5 0 0 1-.491.595h-.788a.5.5 0 0 1-.49-.595l.384-1.99a1.5 1.5 0 1 1 2-1.415z"/>
                                            </svg>
                                            Security Keywords
                                        </label>
                                        <textarea class="form-control" id="global-security-keywords" name="security_keywords" rows="3" placeholder="CVE&#10;zero-day&#10;patch"></textarea>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label" for="global-release-keywords">
                                            <svg width="14" height="14" fill="currentColor" class="bi bi-box-seam me-1" viewBox="0 0 16 16">
                                                <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2l-2.218-.887zm3.564 1.426L5.596 5 8 5.961 14.154 3.5l-2.404-.961zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
                                            </svg>
                                            Release Keywords
                                        </label>
                                        <textarea class="form-control" id="global-release-keywords" name="release_keywords" rows="3" placeholder="v1.0&#10;beta&#10;stable"></textarea>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label" for="global-decision-keywords">
                                            <svg width="14" height="14" fill="currentColor" class="bi bi-diagram-3 me-1" viewBox="0 0 16 16">
                                                <path fill-rule="evenodd" d="M6 3.5A1.5 1.5 0 0 1 7.5 2h1A1.5 1.5 0 0 1 10 3.5v1A1.5 1.5 0 0 1 8.5 6v1H14a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0v-1A.5.5 0 0 1 2 7h5.5V6A1.5 1.5 0 0 1 6 4.5v-1zM8.5 5a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1zM0 11.5A1.5 1.5 0 0 1 1.5 10h1A1.5 1.5 0 0 1 4 11.5v1A1.5 1.5 0 0 1 2.5 14h-1A1.5 1.5 0 0 1 0 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zm4.5.5A1.5 1.5 0 0 1 7.5 10h1a1.5 1.5 0 0 1 1.5 1.5v1A1.5 1.5 0 0 1 8.5 14h-1A1.5 1.5 0 0 1 6 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zm4.5.5a1.5 1.5 0 0 1 1.5-1.5h1a1.5 1.5 0 0 1 1.5 1.5v1a1.5 1.5 0 0 1-1.5 1.5h-1a1.5 1.5 0 0 1-1.5-1.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1z"/>
                                            </svg>
                                            Decision Keywords
                                        </label>
                                        <textarea class="form-control" id="global-decision-keywords" name="decision_keywords" rows="3" placeholder="vote&#10;proposal&#10;deadline"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Scoring Weights -->
                            <div class="border rounded p-3 bg-dark">
                                <h3 class="h6 mb-3">Scoring Weights</h3>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label" for="weight-keywords">Keywords: <span id="weight-keywords-value">0.8</span></label>
                                        <input type="range" class="form-range" id="weight-keywords" name="weight_keywords" min="0" max="3" step="0.1" value="0.8">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="weight-action">Action: <span id="weight-action-value">1.0</span></label>
                                        <input type="range" class="form-range" id="weight-action" name="weight_action" min="0" max="3" step="0.1" value="1.0">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="weight-urgency">Urgency: <span id="weight-urgency-value">1.5</span></label>
                                        <input type="range" class="form-range" id="weight-urgency" name="weight_urgency" min="0" max="3" step="0.1" value="1.5">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="weight-security">Security: <span id="weight-security-value">1.2</span></label>
                                        <input type="range" class="form-range" id="weight-security" name="weight_security" min="0" max="3" step="0.1" value="1.2">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="weight-release">Release: <span id="weight-release-value">0.8</span></label>
                                        <input type="range" class="form-range" id="weight-release" name="weight_release" min="0" max="3" step="0.1" value="0.8">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="weight-decision">Decision: <span id="weight-decision-value">1.1</span></label>
                                        <input type="range" class="form-range" id="weight-decision" name="weight_decision" min="0" max="3" step="0.1" value="1.1">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detection Flags -->
                            <div class="border rounded p-3 bg-dark">
                                <h3 class="h6 mb-3">Detection Flags</h3>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="global-detect-codes" name="detect_codes" checked>
                                            <label class="form-check-label" for="global-detect-codes">Detect code blocks</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="global-detect-documents" name="detect_documents" checked>
                                            <label class="form-check-label" for="global-detect-documents">Detect documents</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="global-prioritize-pinned" name="prioritize_pinned" checked>
                                            <label class="form-check-label" for="global-prioritize-pinned">Prioritize pinned</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Usage Info -->
                            <div class="alert alert-secondary d-none" role="alert" id="global-profile-usage">
                                <strong>Profile Usage:</strong>
                                <div id="global-profile-usage-content"></div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex justify-content-end gap-2">
                                <button class="btn btn-primary" type="submit" id="btn-save-global-profile">
                                    <svg width="16" height="16" fill="currentColor" class="bi bi-check-lg me-1" viewBox="0 0 16 16">
                                        <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/>
                                    </svg>
                                    Save Profile
                                </button>
                                <button class="btn btn-outline-secondary" type="button" id="btn-reset-global-profile">Clear</button>
                                <button class="btn btn-outline-danger d-none" type="button" id="btn-delete-global-profile">Delete</button>
                            </div>
                        </form>
                    </div>
                </article>
            </div>
        </section>
    </div>
    
    <!-- Interest Profiles Tab -->
    <div class="tab-pane fade" id="interest-profiles" role="tabpanel" aria-labelledby="interest-profiles-tab">
        <section class="row g-4 mb-4">
            <div class="col-12 col-xl-6">
                <article class="card h-100" aria-labelledby="profile-editor-heading">
                    <div class="card-header">
                        <div>
                            <h1 class="card-title mb-0" id="profile-editor-heading">Interest Profile Editor</h1>
                            <small class="text-muted">Create and refine semantic interest profiles</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="profile-form" class="d-grid gap-3" novalidate>
                    <input type="hidden" id="profile-mode" value="create">
                    <input type="hidden" id="original-name" value="">
                    
                    <!-- Basic Fields -->
                    <div>
                        <label class="form-label" for="topic-name">Topic name <span class="text-danger">*</span></label>
                        <input class="form-control" id="topic-name" name="topic" type="text" placeholder="e.g., algorand core development" required>
                        <small class="form-text">A unique identifier for this interest profile</small>
                    </div>
                    
                    <div>
                        <label class="form-label" for="topic-description">Description</label>
                        <input class="form-control" id="topic-description" name="description" type="text" placeholder="Brief description of this profile">
                        <small class="form-text">Optional: helps document the profile's purpose</small>
                    </div>
                    
                    <div>
                        <label class="form-label" for="positive-samples">Positive examples</label>
                        <textarea class="form-control" id="positive-samples" name="positive" rows="6" placeholder="Paste messages that should match this profile&#10;One example per line"></textarea>
                        <small class="form-text">Messages that represent the interest</small>
                    </div>
                    
                    <div>
                        <label class="form-label" for="negative-samples">Negative examples</label>
                        <textarea class="form-control" id="negative-samples" name="negative" rows="4" placeholder="Paste noise or unrelated content&#10;One example per line"></textarea>
                        <small class="form-text">Messages that should NOT match (helps refine the profile)</small>
                    </div>
                    
                    <!-- Advanced Section (Collapsible) -->
                    <div class="border-top pt-3">
                        <button class="btn btn-link p-0 text-decoration-none d-flex align-items-center gap-2" type="button" data-bs-toggle="collapse" data-bs-target="#advanced-config" aria-expanded="false" aria-controls="advanced-config">
                            <svg width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16" id="collapse-icon">
                                <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                            </svg>
                            <strong>Advanced Configuration</strong>
                        </button>
                    </div>
                    
                    <div class="collapse" id="advanced-config">
                        <div class="card card-body bg-dark border-secondary">
                            <div class="d-grid gap-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label" for="similarity-threshold">Similarity Threshold</label>
                                        <input class="form-control" id="similarity-threshold" name="threshold" type="number" min="0" max="1" step="0.01" value="0.42" placeholder="0.42">
                                        <small class="form-text">Score threshold (0.0 - 1.0) for matches</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="profile-weight">Profile Weight</label>
                                        <input class="form-control" id="profile-weight" name="weight" type="number" min="0" max="10" step="0.1" value="1.0" placeholder="1.0">
                                        <small class="form-text">Importance multiplier for this profile</small>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label" for="profile-enabled">Status</label>
                                        <select class="form-select" id="profile-enabled" name="enabled">
                                            <option value="true" selected>Enabled</option>
                                            <option value="false">Disabled</option>
                                        </select>
                                        <small class="form-text">Active/inactive state</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="profile-priority">Priority</label>
                                        <select class="form-select" id="profile-priority" name="priority">
                                            <option value="low">Low</option>
                                            <option value="normal" selected>Normal</option>
                                            <option value="high">High</option>
                                            <option value="critical">Critical</option>
                                        </select>
                                        <small class="form-text">Alert priority level</small>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="form-label" for="profile-keywords">Keywords (comma-separated)</label>
                                    <input class="form-control" id="profile-keywords" name="keywords" type="text" placeholder="keyword1, keyword2, keyword3">
                                    <small class="form-text">Boost scoring for messages containing these keywords</small>
                                </div>
                                
                                <div>
                                    <label class="form-label" for="profile-channels">Restrict to Channels (comma-separated IDs)</label>
                                    <input class="form-control" id="profile-channels" name="channels" type="text" placeholder="-1001234567890, -1009876543210">
                                    <small class="form-text">Only apply this profile to specific channels (leave empty for all)</small>
                                </div>
                                
                                <div>
                                    <label class="form-label" for="profile-tags">Tags (comma-separated)</label>
                                    <input class="form-control" id="profile-tags" name="tags" type="text" placeholder="security, urgent, technical">
                                    <small class="form-text">Organizational tags for filtering and grouping</small>
                                </div>
                                
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="profile-notify-always" name="notify_always">
                                    <label class="form-check-label" for="profile-notify-always">
                                        Always notify (bypass other filters)
                                    </label>
                                </div>
                                
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="profile-include-in-digest" name="include_digest" checked>
                                    <label class="form-check-label" for="profile-include-in-digest">
                                        Include matches in digests
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-3">
                        <button class="btn btn-primary" type="submit" id="btn-save-profile">
                            <span id="save-btn-text">Save Profile</span>
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="btn-reset-profile">Clear form</button>
                        <button class="btn btn-outline-danger d-none" type="button" id="btn-delete-profile">Delete Profile</button>
                    </div>
                </form>
            </div>
        </article>
    </div>
    <div class="col-12 col-xl-6">
        <article class="card h-100" aria-labelledby="profile-tester-heading">
            <div class="card-header">
                <div>
                    <h2 class="card-title mb-0" id="profile-tester-heading">Similarity Tester</h2>
                    <small class="text-muted">Compare phrases against saved profiles</small>
                </div>
            </div>
            <div class="card-body d-grid gap-3">
                <div>
                    <label class="form-label" for="test-phrase">Test phrase</label>
                    <input class="form-control max-w-100" id="test-phrase" type="text" placeholder="Exploit in governance contract">
                </div>
                <div>
                    <label class="form-label" for="profile-select">Compare against</label>
                    <select class="form-select max-w-100" id="profile-select">
                        {%- for interest in interests %}
                        <option value="{{ interest }}">{{ interest }}</option>
                        {%- else %}
                        <option value="default">Default profile</option>
                        {%- endfor %}
                    </select>
                </div>
                <div class="d-flex gap-2 align-items-center flex-wrap">
                    <button class="btn btn-outline-primary btn-sm" type="button" id="btn-run-test">Run Test</button>
                    <p class="mb-0" id="test-result" aria-live="polite">Score: --</p>
                </div>
                <div class="logs-viewer overflow-x-auto" aria-live="polite" id="profile-log">
                    <pre class="mb-0 text-muted white-space-pre-wrap">Build focused profiles for semantic scoring.</pre>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-secondary btn-sm font-size-sm" type="button" id="btn-import-profiles">
                        <svg width="14" height="14" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                        </svg>
                        Import
                    </button>
                    <button class="btn btn-outline-secondary btn-sm font-size-sm" type="button" id="btn-export-profiles">
                        <svg width="14" height="14" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Export
                    </button>
                </div>
            </div>
        </article>
    </div>
</section>

<section class="card" aria-labelledby="existing-profiles-heading">
    <div class="card-header">
        <div>
            <h2 class="card-title mb-0" id="existing-profiles-heading">Existing Profiles</h2>
            <small class="text-muted">Manage, enable/disable, and edit profiles</small>
        </div>
    </div>
    <div class="card-body">
        <div class="row g-3" id="profile-list">
            {%- for interest in interests %}
            {%- set profile = profiles.get(interest, {}) %}
            {%- set is_enabled = profile.get('enabled', True) %}
            {%- set description = profile.get('description', 'Tracked interest focus') %}
            <div class="col-12 col-md-6 col-xl-3">
                <article class="card h-100 glass-effect profile-card{{ ' disabled' if not is_enabled else '' }}" data-profile="{{ interest }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h3 class="h5 mb-0 flex-grow-1 profile-name-clickable" role="button" tabindex="0">{{ interest }}</h3>
                            <div class="form-check form-switch ms-2">
                                <input class="form-check-input profile-toggle" type="checkbox" role="switch" 
                                       id="toggle-{{ loop.index }}" 
                                       data-profile="{{ interest }}" 
                                       {{ 'checked' if is_enabled else '' }}
                                       title="Enable/Disable profile"
                                       aria-label="Toggle {{ interest }} profile">
                            </div>
                        </div>
                        <p class="text-muted mb-0 small profile-desc-clickable" role="button" tabindex="-1">{{ description }}</p>
                        <div class="mt-2 profile-badge-clickable" role="button" tabindex="-1">
                            <span class="badge {{ 'bg-primary' if is_enabled else 'bg-secondary' }} profile-status-badge">{{ 'Active' if is_enabled else 'Disabled' }}</span>
                        </div>
                    </div>
                </article>
            </div>
            {%- else %}
            <p class="text-muted">No custom profiles yet. Create one using the editor above.</p>
            {%- endfor %}
        </div>
    </div>
</section>
</div> <!-- End tab-content -->

<!-- Backtest Results Modal -->
<div class="modal fade" id="backtestModal" tabindex="-1" aria-labelledby="backtestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backtestModalLabel">Backtest Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="backtest-loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Running backtest...</span>
                    </div>
                    <p class="mt-3 text-muted">Analyzing historical messages...</p>
                </div>
                
                <div id="backtest-results" class="d-none">
                    <!-- Statistics Cards -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card bg-dark">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Total Messages</h6>
                                    <p class="card-text h3 mb-0" id="stat-total-messages">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Matched</h6>
                                    <p class="card-text h3 mb-0" id="stat-matched">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Match Rate</h6>
                                    <p class="card-text h3 mb-0" id="stat-match-rate">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Avg Score</h6>
                                    <p class="card-text h3 mb-0" id="stat-avg-score">--</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recommendations -->
                    <div class="alert alert-info" id="backtest-recommendations" role="alert">
                        <h6 class="alert-heading">Recommendations</h6>
                        <ul id="recommendations-list" class="mb-0"></ul>
                    </div>
                    
                    <!-- Matched Messages Table -->
                    <h6 class="mb-3">Matched Messages</h6>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th class="w-15">Channel</th>
                                    <th class="w-10">Message ID</th>
                                    <th class="w-10">Score</th>
                                    <th class="w-20">Triggers</th>
                                    <th class="w-10">Would Alert</th>
                                    <th class="w-35">Preview</th>
                                </tr>
                            </thead>
                            <tbody id="backtest-matches-tbody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="backtest-error" class="alert alert-danger d-none" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // API Endpoints
    const alertProfileEndpoints = {
        list: "{{ url_for('profiles.list_alert_profiles') }}",
        get: "{{ url_for('profiles.get_alert_profile') }}",
        upsert: "{{ url_for('profiles.upsert_alert_profile') }}",
        delete: "{{ url_for('profiles.delete_alert_profile') }}",
        toggle: "{{ url_for('profiles.toggle_alert_profile') }}",
        backtest: "{{ url_for('profiles.backtest_alert_profile') }}"
    };
    
    const interestProfileEndpoints = {
        train: "{{ url_for('profiles.train_profile') }}",
        test: "{{ url_for('profiles.test_profile') }}",
        export: "{{ url_for('profiles.export_profiles') }}",
        save: "{{ url_for('profiles.save_profile') }}",
        load: "{{ url_for('profiles.get_profile') }}",
        delete: "{{ url_for('profiles.delete_profile') }}",
        toggle: "{{ url_for('profiles.toggle_profile') }}",
        backtest: "{{ url_for('profiles.backtest_interest_profile') }}"
    };
    
    let currentAlertProfile = null;
    let currentInterestProfile = null;
    let allAlertProfiles = [];
    let filteredAlertProfiles = [];

    // ============= ALERT PROFILES FUNCTIONS =============
    
    async function loadAlertProfiles() {
        try {
            const response = await fetch(alertProfileEndpoints.list);
            if (!response.ok) throw new Error("Failed to load alert profiles");
            const data = await response.json();
            
            allAlertProfiles = data.profiles || [];
            filteredAlertProfiles = [...allAlertProfiles];
            
            // Update profile count
            const countEl = document.getElementById("alert-profiles-count");
            if (countEl) {
                countEl.textContent = allAlertProfiles.length;
            }
            
            renderAlertProfiles(filteredAlertProfiles);
        } catch (error) {
            console.error("Failed to load alert profiles:", error);
            showToast("Failed to load alert profiles", "error");
        }
    }
    
    function renderAlertProfiles(profiles) {
        const listEl = document.getElementById("alert-profiles-list");
        if (!listEl) return;
        
        if (!profiles || profiles.length === 0) {
            listEl.innerHTML = `
                <div class="alert-profiles-empty">
                    <svg fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                    </svg>
                    <p class="mb-2">No alert profiles yet</p>
                    <small>Create your first profile to get started</small>
                </div>
            `;
            return;
        }
        
        listEl.innerHTML = profiles.map(profile => {
            // Calculate metadata
            const keywordCount = (profile.critical_keywords || []).length + 
                               (profile.security_keywords || []).length +
                               (profile.urgency_keywords || []).length +
                               (profile.financial_keywords || []).length +
                               (profile.technical_keywords || []).length +
                               (profile.project_keywords || []).length +
                               (profile.community_keywords || []).length +
                               (profile.general_keywords || []).length;
            
            const hasActivity = profile.last_triggered_at; // Will be implemented in backend
            const activityIndicator = hasActivity ? '<span class="alert-profile-activity" title="Recently triggered"></span>' : '';
            
            const lastUpdated = profile.updated_at ? 
                new Date(profile.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 
                'Never';
            
            return `
                <a href="#" class="list-group-item list-group-item-action alert-profile-item" 
                   data-profile-id="${profile.id}"
                   data-profile-name="${escapeHtml(profile.name)}"
                   data-enabled="${profile.enabled}">
                    ${activityIndicator}
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1 pe-2">
                            <h6 class="mb-1">${escapeHtml(profile.name)}</h6>
                            ${profile.description ? `<small class="text-muted d-block mb-2">${escapeHtml(profile.description)}</small>` : ''}
                            <div class="alert-profile-metadata">
                                ${keywordCount > 0 ? `
                                    <span class="alert-profile-meta-badge">
                                        <svg fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                                        </svg>
                                        ${keywordCount} rules
                                    </span>
                                ` : ''}
                                <span class="alert-profile-meta-badge">
                                    <svg fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                                    </svg>
                                    ${lastUpdated}
                                </span>
                            </div>
                        </div>
                        <div class="d-flex flex-column align-items-end gap-2">
                            <div class="alert-profile-toggle-wrapper">
                                <div class="form-check form-switch mb-0">
                                    <input class="form-check-input alert-profile-toggle" type="checkbox" 
                                           data-profile-id="${profile.id}" 
                                           ${profile.enabled ? 'checked' : ''}
                                           onclick="event.stopPropagation()"
                                           title="${profile.enabled ? 'Disable' : 'Enable'} profile">
                                </div>
                            </div>
                            <div class="alert-profile-actions">
                                <button class="alert-profile-action-btn" 
                                        data-action="export" 
                                        data-profile-id="${profile.id}"
                                        onclick="event.stopPropagation(); exportAlertProfile('${profile.id}')"
                                        title="Export profile">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                    </svg>
                                </button>
                                <button class="alert-profile-action-btn" 
                                        data-action="duplicate" 
                                        data-profile-id="${profile.id}"
                                        onclick="event.stopPropagation(); duplicateAlertProfile('${profile.id}')"
                                        title="Duplicate profile">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </a>
            `;
        }).join('');
        
        // Attach click handlers
        listEl.querySelectorAll('.alert-profile-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                loadAlertProfile(item.dataset.profileId);
            });
        });
        
        listEl.querySelectorAll('.alert-profile-toggle').forEach(toggle => {
            toggle.addEventListener('change', async (e) => {
                e.stopPropagation();
                
                // Store previous state for revert on error
                const previousState = !toggle.checked;
                
                // Disable checkbox to prevent rapid repeated clicks
                toggle.disabled = true;
                
                try {
                    await toggleAlertProfile(toggle.dataset.profileId, toggle.checked);
                } catch (error) {
                    // Revert checkbox to previous state on error
                    toggle.checked = previousState;
                    console.error('Failed to toggle alert profile:', error);
                    showToast('Failed to toggle profile. Please try again.', 'error');
                } finally {
                    // Re-enable checkbox after request completes
                    toggle.disabled = false;
                }
            });
        });
    }
    
    function filterAlertProfiles(searchTerm) {
        const term = searchTerm.toLowerCase().trim();
        
        if (!term) {
            filteredAlertProfiles = [...allAlertProfiles];
        } else {
            filteredAlertProfiles = allAlertProfiles.filter(profile => {
                const name = (profile.name || '').toLowerCase();
                const desc = (profile.description || '').toLowerCase();
                const keywords = [
                    ...(profile.critical_keywords || []),
                    ...(profile.security_keywords || []),
                    ...(profile.urgency_keywords || []),
                    ...(profile.financial_keywords || []),
                    ...(profile.technical_keywords || []),
                    ...(profile.project_keywords || []),
                    ...(profile.community_keywords || []),
                    ...(profile.general_keywords || [])
                ].join(' ').toLowerCase();
                
                return name.includes(term) || desc.includes(term) || keywords.includes(term);
            });
        }
        
        renderAlertProfiles(filteredAlertProfiles);
    }
    
    function exportAlertProfile(profileId) {
        const profile = allAlertProfiles.find(p => p.id === profileId);
        if (!profile) return;
        
        const dataStr = JSON.stringify(profile, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `alert-profile-${profile.name.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showToast('Profile exported', 'success');
    }
    
    async function duplicateAlertProfile(profileId) {
        const profile = allAlertProfiles.find(p => p.id === profileId);
        if (!profile) return;
        
        const duplicatedProfile = {
            ...profile,
            id: `${profile.id}-copy-${Date.now()}`,
            name: `${profile.name} (Copy)`,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };
        
        try {
            const response = await fetch(alertProfileEndpoints.upsert, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(duplicatedProfile)
            });
            
            if (!response.ok) throw new Error('Failed to duplicate profile');
            
            showToast('Profile duplicated', 'success');
            await loadAlertProfiles();
        } catch (error) {
            console.error('Failed to duplicate profile:', error);
            showToast('Failed to duplicate profile', 'error');
        }
    }
    
    async function loadAlertProfile(profileId) {
        try {
            const response = await fetch(`${alertProfileEndpoints.get}?id=${encodeURIComponent(profileId)}`);
            if (!response.ok) throw new Error("Failed to load alert profile");
            const data = await response.json();
            
            currentAlertProfile = data.profile;
            
            // Populate form
            document.getElementById("alert-profile-id").value = data.profile.id;
            document.getElementById("alert-name").value = data.profile.name || "";
            document.getElementById("alert-description").value = data.profile.description || "";
            document.getElementById("alert-enabled").value = data.profile.enabled !== false ? "true" : "false";
            
            // Keywords
            document.getElementById("alert-critical-keywords").value = (data.profile.critical_keywords || []).join(", ");
            document.getElementById("alert-security-keywords").value = (data.profile.security_keywords || []).join(", ");
            document.getElementById("alert-urgency-keywords").value = (data.profile.urgency_keywords || []).join(", ");
            document.getElementById("alert-financial-keywords").value = (data.profile.financial_keywords || []).join(", ");
            document.getElementById("alert-technical-keywords").value = (data.profile.technical_keywords || []).join(", ");
            document.getElementById("alert-project-keywords").value = (data.profile.project_keywords || []).join(", ");
            document.getElementById("alert-community-keywords").value = (data.profile.community_keywords || []).join(", ");
            document.getElementById("alert-general-keywords").value = (data.profile.general_keywords || []).join(", ");
            
            // Detection settings
            document.getElementById("alert-min-score").value = data.profile.min_score || 1.0;
            document.getElementById("alert-vip-senders").value = (data.profile.vip_senders || []).join(", ");
            document.getElementById("alert-excluded-users").value = (data.profile.excluded_users || []).join(", ");
            document.getElementById("alert-detect-questions").checked = data.profile.detect_questions || false;
            document.getElementById("alert-detect-mentions").checked = data.profile.detect_mentions || false;
            document.getElementById("alert-detect-links").checked = data.profile.detect_links || false;
            document.getElementById("alert-require-forwarded").checked = data.profile.require_forwarded || false;
            
            // Update buttons
            document.getElementById("alert-save-btn-text").textContent = "Update Profile";
            document.getElementById("btn-delete-alert-profile").classList.remove("d-none");
            
            // Highlight active item
            document.querySelectorAll(".alert-profile-item").forEach(item => {
                item.classList.remove("active");
            });
            document.querySelector(`[data-profile-id="${profileId}"]`)?.closest('.alert-profile-item')?.classList.add('active');
            
            showToast(`Loaded: ${data.profile.name}`, "info");
        } catch (error) {
            console.error("Failed to load alert profile:", error);
            showToast("Failed to load alert profile", "error");
        }
    }
    
    async function saveAlertProfile(event) {
        event.preventDefault();
        
        const profileData = {
            id: document.getElementById("alert-profile-id").value || null,
            name: document.getElementById("alert-name").value.trim(),
            description: document.getElementById("alert-description").value.trim(),
            enabled: document.getElementById("alert-enabled").value === "true",
            critical_keywords: parseCSV(document.getElementById("alert-critical-keywords").value),
            security_keywords: parseCSV(document.getElementById("alert-security-keywords").value),
            urgency_keywords: parseCSV(document.getElementById("alert-urgency-keywords").value),
            financial_keywords: parseCSV(document.getElementById("alert-financial-keywords").value),
            technical_keywords: parseCSV(document.getElementById("alert-technical-keywords").value),
            project_keywords: parseCSV(document.getElementById("alert-project-keywords").value),
            community_keywords: parseCSV(document.getElementById("alert-community-keywords").value),
            general_keywords: parseCSV(document.getElementById("alert-general-keywords").value),
            min_score: parseFloat(document.getElementById("alert-min-score").value) || 1.0,
            vip_senders: parseCSV(document.getElementById("alert-vip-senders").value),
            excluded_users: parseCSV(document.getElementById("alert-excluded-users").value),
            detect_questions: document.getElementById("alert-detect-questions").checked,
            detect_mentions: document.getElementById("alert-detect-mentions").checked,
            detect_links: document.getElementById("alert-detect-links").checked,
            require_forwarded: document.getElementById("alert-require-forwarded").checked
        };
        
        if (!profileData.name) {
            showToast("Profile name is required", "warning");
            return;
        }
        
        try {
            const response = await fetch(alertProfileEndpoints.upsert, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(profileData)
            });
            
            if (!response.ok) throw new Error("Failed to save alert profile");
            
            showToast(profileData.id ? "Profile updated" : "Profile created", "success");
            await loadAlertProfiles();
            
            if (!profileData.id) {
                resetAlertProfileForm();
            }
        } catch (error) {
            console.error("Failed to save alert profile:", error);
            showToast("Failed to save alert profile", "error");
        }
    }
    
    async function deleteAlertProfile() {
        const profileId = document.getElementById("alert-profile-id").value;
        if (!profileId) return;
        
        const profileName = document.getElementById("alert-name").value;
        if (!confirm(`Delete profile "${profileName}"?`)) return;
        
        try {
            const response = await fetch(`${alertProfileEndpoints.delete}?id=${encodeURIComponent(profileId)}`, {
                method: "DELETE"
            });
            
            if (!response.ok) throw new Error("Failed to delete alert profile");
            
            showToast("Profile deleted", "success");
            resetAlertProfileForm();
            await loadAlertProfiles();
        } catch (error) {
            console.error("Failed to delete alert profile:", error);
            showToast("Failed to delete alert profile", "error");
        }
    }
    
    async function toggleAlertProfile(profileId, enabled) {
        try {
            const response = await fetch(alertProfileEndpoints.toggle, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: profileId, enabled })
            });
            
            if (!response.ok) throw new Error("Failed to toggle alert profile");
            
            showToast(`Profile ${enabled ? 'enabled' : 'disabled'}`, "info");
            await loadAlertProfiles();
        } catch (error) {
            console.error("Failed to toggle alert profile:", error);
            showToast("Failed to toggle alert profile", "error");
        }
    }
    
    async function backtestAlertProfile() {
        const profileId = document.getElementById("alert-profile-id").value;
        if (!profileId) {
            showToast("Please select a profile first", "warning");
            return;
        }
        
        const modalEl = document.getElementById('backtestModal');
        const modal = new bootstrap.Modal(modalEl);
        
        // Apply glass backdrop effect
        const addGlassClass = () => {
            setTimeout(() => {
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop && !backdrop.classList.contains('glass-backdrop')) {
                    backdrop.classList.add('glass-backdrop');
                }
            }, 50);
        };
        
        modalEl.addEventListener('shown.bs.modal', addGlassClass, { once: true });
        modalEl.addEventListener('show.bs.modal', addGlassClass, { once: true });
        
        modal.show();
        
        document.getElementById('backtest-loading').classList.remove('d-none');
        document.getElementById('backtest-results').classList.add('d-none');
        document.getElementById('backtest-error').classList.add('d-none');
        
        try {
            const response = await fetch(alertProfileEndpoints.backtest, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id: profileId,
                    hours_back: 24,
                    max_messages: 100
                })
            });
            
            if (!response.ok) throw new Error("Backtest failed");
            const data = await response.json();
            
            // Display results
            document.getElementById('backtest-loading').classList.add('d-none');
            document.getElementById('backtest-results').classList.remove('d-none');
            
            // Statistics
            document.getElementById('stat-total-messages').textContent = data.stats.total_messages || 0;
            document.getElementById('stat-matched').textContent = data.stats.matched_messages || 0;
            document.getElementById('stat-match-rate').textContent = (data.stats.match_rate || 0).toFixed(1) + '%';
            document.getElementById('stat-avg-score').textContent = (data.stats.average_score || 0).toFixed(2);
            
            // Recommendations
            const recsList = document.getElementById('recommendations-list');
            if (data.recommendations && data.recommendations.length > 0) {
                recsList.innerHTML = data.recommendations.map(r => `<li>${escapeHtml(r)}</li>`).join('');
            } else {
                recsList.innerHTML = '<li>Profile is working well!</li>';
            }
            
            // Matches table
            const tbody = document.getElementById('backtest-matches-tbody');
            if (data.matches && data.matches.length > 0) {
                tbody.innerHTML = data.matches.map(match => `
                    <tr>
                        <td>${escapeHtml(match.chat_title || 'Unknown')}</td>
                        <td>${match.message_id}</td>
                        <td><span class="badge bg-primary">${match.score.toFixed(2)}</span></td>
                        <td><small>${escapeHtml((match.triggers || []).join(', '))}</small></td>
                        <td>${match.would_alert ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
                        <td><small>${escapeHtml((match.text_preview || '').substring(0, 100))}</small></td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No matches found</td></tr>';
            }
        } catch (error) {
            console.error("Backtest failed:", error);
            document.getElementById('backtest-loading').classList.add('d-none');
            document.getElementById('backtest-error').textContent = `Backtest failed: ${error.message}`;
            document.getElementById('backtest-error').classList.remove('d-none');
        }
    }
    
    function resetAlertProfileForm() {
        document.getElementById("alert-profile-form").reset();
        document.getElementById("alert-profile-id").value = "";
        document.getElementById("alert-save-btn-text").textContent = "Save Profile";
        document.getElementById("btn-delete-alert-profile").classList.add("d-none");
        document.getElementById("alert-min-score").value = "1.0";
        document.getElementById("alert-enabled").value = "true";
        
        document.querySelectorAll(".alert-profile-item").forEach(item => {
            item.classList.remove("active");
        });
        
        currentAlertProfile = null;
    }
    
    function newAlertProfile() {
        resetAlertProfileForm();
        showToast("Create a new alert profile", "info");
    }

    // ============= INTEREST PROFILES FUNCTIONS =============
    
    async function loadInterestProfile(profileName) {
        try {
            const response = await fetch(`${interestProfileEndpoints.load}?name=${encodeURIComponent(profileName)}`);
            if (!response.ok) {
                throw new Error("Failed to load profile");
            }
            const data = await response.json();
            
            // Set form mode to edit
            document.getElementById("profile-mode").value = "edit";
            document.getElementById("original-name").value = profileName;
            currentProfile = profileName;
            
            // Populate form fields
            document.getElementById("topic-name").value = data.name || profileName;
            document.getElementById("topic-description").value = data.description || "";
            document.getElementById("positive-samples").value = (data.positive_samples || []).join("\n");
            document.getElementById("negative-samples").value = (data.negative_samples || []).join("\n");
            
            // Advanced fields
            document.getElementById("similarity-threshold").value = data.threshold || 0.42;
            document.getElementById("profile-weight").value = data.weight || 1.0;
            document.getElementById("profile-enabled").value = data.enabled !== false ? "true" : "false";
            document.getElementById("profile-priority").value = data.priority || "normal";
            document.getElementById("profile-keywords").value = (data.keywords || []).join(", ");
            document.getElementById("profile-channels").value = (data.channels || []).join(", ");
            document.getElementById("profile-tags").value = (data.tags || []).join(", ");
            document.getElementById("profile-notify-always").checked = data.notify_always || false;
            document.getElementById("profile-include-in-digest").checked = data.include_digest !== false;
            
            // Update UI
            document.getElementById("save-btn-text").textContent = "Update Profile";
            document.getElementById("btn-delete-profile").classList.remove("d-none");
            
            // Highlight active profile card
            document.querySelectorAll(".profile-card").forEach(card => {
                card.classList.remove("active");
            });
            const activeCard = document.querySelector(`.profile-card[data-profile="${profileName}"]`);
            if (activeCard) {
                activeCard.classList.add("active");
            }
            
            // Scroll to form
            document.getElementById("profile-editor-heading").scrollIntoView({ behavior: "smooth", block: "start" });
            
            appendLog(`Loaded profile: ${profileName}`);
            showToast(`Editing: ${profileName}`, "info");
        } catch (error) {
            console.error("Failed to load profile:", error);
            showToast("Failed to load profile", "error");
        }
    }

    // Save profile (create or update)
    async function saveProfile(event) {
        event.preventDefault();
        
        const submitBtn = document.getElementById("btn-save-profile");
        const submitText = document.getElementById("save-btn-text");
        
        // Guard against duplicate submissions
        if (submitBtn.disabled) {
            return;
        }
        
        const mode = document.getElementById("profile-mode").value;
        const topicName = document.getElementById("topic-name").value.trim();
        
        if (!topicName) {
            showToast("Topic name is required", "warning");
            return;
        }
        
        const profileData = {
            name: topicName,
            description: document.getElementById("topic-description").value.trim(),
            positive_samples: document.getElementById("positive-samples").value
                .split("\n")
                .map(s => s.trim())
                .filter(s => s),
            negative_samples: document.getElementById("negative-samples").value
                .split("\n")
                .map(s => s.trim())
                .filter(s => s),
            threshold: parseFloat(document.getElementById("similarity-threshold").value) || 0.42,
            weight: parseFloat(document.getElementById("profile-weight").value) || 1.0,
            enabled: document.getElementById("profile-enabled").value === "true",
            priority: document.getElementById("profile-priority").value,
            keywords: document.getElementById("profile-keywords").value
                .split(",")
                .map(s => s.trim())
                .filter(s => s),
            channels: document.getElementById("profile-channels").value
                .split(",")
                .map(s => s.trim())
                .filter(s => s),
            tags: document.getElementById("profile-tags").value
                .split(",")
                .map(s => s.trim())
                .filter(s => s),
            notify_always: document.getElementById("profile-notify-always").checked,
            include_digest: document.getElementById("profile-include-in-digest").checked
        };
        
        if (mode === "edit") {
            profileData.original_name = document.getElementById("original-name").value;
        }
        
        // Disable button and show loading state
        submitBtn.disabled = true;
        const originalText = submitText.textContent;
        submitText.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
        
        try {
            const response = await fetch(interestProfileEndpoints.save, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(profileData)
            });
            
            if (!response.ok) {
                throw new Error("Failed to save profile");
            }
            
            await response.json();
            appendLog(`Profile saved: ${topicName}`);
            showToast(mode === "edit" ? "Profile updated" : "Profile created", "success");
            
            // Re-enable button before reload
            submitBtn.disabled = false;
            submitText.textContent = originalText;
            
            // Reload page to show updated profile
            setTimeout(() => window.location.reload(), 1000);
        } catch (error) {
            console.error("Failed to save profile:", error);
            showToast("Failed to save profile", "error");
        } finally {
            // Always re-enable button in error path
            submitBtn.disabled = false;
            submitText.textContent = originalText;
        }
    }

    // Delete profile
    async function deleteProfile() {
        const profileName = document.getElementById("original-name").value;
        
        if (!profileName) {
            showToast("No profile selected", "warning");
            return;
        }
        
        if (!confirm(`Are you sure you want to delete the profile "${profileName}"?`)) {
            return;
        }
        
        try {
            const response = await fetch(interestProfileEndpoints.delete, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: profileName })
            });
            
            if (!response.ok) {
                throw new Error("Failed to delete profile");
            }
            
            appendLog(`Profile deleted: ${profileName}`);
            showToast("Profile deleted", "success");
            
            // Reload page
            setTimeout(() => window.location.reload(), 1000);
        } catch (error) {
            console.error("Failed to delete profile:", error);
            showToast("Failed to delete profile", "error");
        }
    }

    // Reset form to create mode
    function resetForm() {
        document.getElementById("profile-form").reset();
        document.getElementById("profile-mode").value = "create";
        document.getElementById("original-name").value = "";
        document.getElementById("save-btn-text").textContent = "Save Profile";
        document.getElementById("btn-delete-profile").classList.add("d-none");
        currentInterestProfile = null;
        
        // Remove active state from cards
        document.querySelectorAll(".profile-card").forEach(card => {
            card.classList.remove("active");
        });
        
        // Reset advanced fields to defaults
        document.getElementById("similarity-threshold").value = 0.42;
        document.getElementById("profile-weight").value = 1.0;
        document.getElementById("profile-enabled").value = "true";
        document.getElementById("profile-priority").value = "normal";
        document.getElementById("profile-notify-always").checked = false;
        document.getElementById("profile-include-in-digest").checked = true;
        
        appendLog("Form reset to create new profile");
    }

    async function runSimilarityTest() {
        const sample = document.getElementById("test-phrase").value.trim();
        if (!sample) {
            showToast("Enter a phrase to test", "warning");
            return;
        }
        
        const selectEl = document.getElementById("profile-select");
        if (!selectEl) {
            console.error("Profile select element not found");
            showToast("Profile selector unavailable", "error");
            return;
        }
        
        const interest = selectEl.value?.trim();
        if (!interest) {
            showToast("Select an interest profile", "warning");
            return;
        }
        
        try {
            const response = await fetch(interestProfileEndpoints.test, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sample, interest }),
            });
            if (!response.ok) {
                throw new Error("Test failed");
            }
            const payload = await response.json();
            if (typeof payload !== "object" || payload === null) {
                console.warn("Unexpected similarity payload", payload);
                throw new Error("Malformed response");
            }
            const score = Number(payload.score);
            if (!Number.isFinite(score)) {
                console.warn("Similarity score missing or invalid", payload);
                throw new Error("Invalid score");
            }
            
            if (score < 0 || score > 1) {
                console.warn(
                    `Similarity score out of range [0,1]: ${score} for sample "${sample}" against interest "${interest}"`
                );
            }
            
            const clamped = Math.max(0, Math.min(score, 1));
            const formatted = clamped.toFixed(2);
            const resultEl = document.getElementById("test-result");
            if (resultEl) {
                resultEl.textContent = `Score: ${formatted}`;
            }
            appendLog(`Similarity test for "${sample}" â†’ ${formatted}`);
        } catch (error) {
            console.error(error);
            showToast("Unable to compute similarity", "error");
        }
    }

    function appendLog(message) {
        const log = document.getElementById("profile-log");
        if (!log) return;
        
        const entry = document.createElement("div");
        entry.className = "log-entry";
        const time = document.createElement("span");
        time.className = "log-time";
        time.textContent = new Date().toLocaleTimeString();

        const spacer = document.createTextNode(" ");

        const msg = document.createElement("span");
        msg.className = "log-message";
        msg.textContent = String(message ?? "");

        entry.appendChild(time);
        entry.appendChild(spacer);
        entry.appendChild(msg);
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }

    // ============= UTILITY FUNCTIONS =============
    
    function parseCSV(str) {
        return str.split(",").map(s => s.trim()).filter(s => s);
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    async function bulkToggleAlertProfiles(enabled) {
        if (!confirm(`Are you sure you want to ${enabled ? 'enable' : 'disable'} all profiles?`)) {
            return;
        }
        
        // Create AbortController with timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        try {
            // Build array of fetch promises
            const togglePromises = allAlertProfiles.map(profile =>
                fetch(alertProfileEndpoints.toggle, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: profile.id, enabled }),
                    signal: controller.signal
                })
                .then(response => ({ profile, response, success: response.ok }))
                .catch(error => ({ profile, error, success: false }))
            );
            
            // Wait for all requests to complete
            const results = await Promise.allSettled(togglePromises);
            
            // Process results and count successes/failures
            let successCount = 0;
            let failCount = 0;
            
            results.forEach(result => {
                if (result.status === 'fulfilled') {
                    const { profile, success, error } = result.value;
                    if (success) {
                        successCount++;
                    } else {
                        failCount++;
                        console.error(`Failed to toggle profile ${profile.id}:`, error || 'Request failed');
                    }
                } else {
                    // Promise was rejected
                    failCount++;
                    console.error('Toggle request failed:', result.reason);
                }
            });
            
            // Show consolidated toast
            showToast(
                `${successCount} profiles ${enabled ? 'enabled' : 'disabled'}${failCount > 0 ? `, ${failCount} failed` : ''}`, 
                failCount > 0 ? 'warning' : 'success'
            );
            
        } catch (error) {
            console.error('Bulk toggle operation failed:', error);
            showToast('Bulk toggle operation failed', 'error');
        } finally {
            clearTimeout(timeoutId);
        }
        
        // Reload profiles after all requests complete
        await loadAlertProfiles();
    }
    
    function exportAllAlertProfiles() {
        const dataStr = JSON.stringify(allAlertProfiles, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `alert-profiles-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showToast(`Exported ${allAlertProfiles.length} profiles`, 'success');
    }

    // ============= INITIALIZATION =============
    
    document.addEventListener("DOMContentLoaded", () => {
        // Load alert profiles on page load
        loadAlertProfiles();
        
        // Alert Profile handlers
        document.getElementById("alert-profile-form")?.addEventListener("submit", saveAlertProfile);
        document.getElementById("btn-new-alert-profile")?.addEventListener("click", newAlertProfile);
        document.getElementById("btn-reset-alert-profile")?.addEventListener("click", resetAlertProfileForm);
        document.getElementById("btn-delete-alert-profile")?.addEventListener("click", deleteAlertProfile);
        document.getElementById("btn-backtest-alert-profile")?.addEventListener("click", backtestAlertProfile);
        
        // Search functionality
        const searchInput = document.getElementById("alert-profiles-search");
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener("input", (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterAlertProfiles(e.target.value);
                }, 300);
            });
        }
        
        // Bulk actions dropdown
        const bulkActionsBtn = document.getElementById("btn-alert-bulk-actions");
        if (bulkActionsBtn) {
            // Create dropdown once during initialization
            let dropdown = document.querySelector(".alert-bulk-dropdown");
            if (!dropdown) {
                dropdown = document.createElement("div");
                dropdown.className = "alert-bulk-dropdown";
                dropdown.innerHTML = `
                    <button class="alert-bulk-dropdown-item" data-action="enable-all">Enable All</button>
                    <button class="alert-bulk-dropdown-item" data-action="disable-all">Disable All</button>
                    <button class="alert-bulk-dropdown-item" data-action="export-all">Export All</button>
                `;
                bulkActionsBtn.parentElement.style.position = "relative";
                bulkActionsBtn.parentElement.appendChild(dropdown);
                
                // Add click handlers to dropdown items
                dropdown.querySelectorAll(".alert-bulk-dropdown-item").forEach(item => {
                    item.addEventListener("click", async (e) => {
                        e.stopPropagation();
                        const action = item.dataset.action;
                        dropdown.classList.remove("show");
                        
                        if (action === "enable-all") {
                            await bulkToggleAlertProfiles(true);
                        } else if (action === "disable-all") {
                            await bulkToggleAlertProfiles(false);
                        } else if (action === "export-all") {
                            exportAllAlertProfiles();
                        }
                    });
                });
            }
            
            // Button click handler - just toggle dropdown
            bulkActionsBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                dropdown.classList.toggle("show");
            });
            
            // Document-level click handler (registered once during initialization)
            const closeDropdownHandler = (e) => {
                const dropdown = document.querySelector(".alert-bulk-dropdown");
                if (dropdown && dropdown.classList.contains("show")) {
                    // Only close if clicking outside both the dropdown and the button
                    if (!dropdown.contains(e.target) && !bulkActionsBtn.contains(e.target)) {
                        dropdown.classList.remove("show");
                    }
                }
            };
            
            document.addEventListener("click", closeDropdownHandler);
        }
        
        // Interest Profile form submission
        document.getElementById("profile-form")?.addEventListener("submit", saveProfile);
        
        // Interest Profile button handlers
        document.getElementById("btn-reset-profile")?.addEventListener("click", resetForm);
        document.getElementById("btn-delete-profile")?.addEventListener("click", deleteProfile);
        document.getElementById("btn-run-test")?.addEventListener("click", runSimilarityTest);
        
        // Profile card click handlers
        document.querySelectorAll(".profile-name-clickable, .profile-desc-clickable, .profile-badge-clickable").forEach(element => {
            element.addEventListener("click", () => {
                const card = element.closest(".profile-card");
                const profileName = card?.getAttribute("data-profile");
                if (profileName) {
                    loadInterestProfile(profileName);
                }
            });
            
            element.addEventListener("keypress", (e) => {
                if (e.key === "Enter" || e.key === " ") {
                    e.preventDefault();
                    const card = element.closest(".profile-card");
                    const profileName = card?.getAttribute("data-profile");
                    if (profileName) {
                        loadInterestProfile(profileName);
                    }
                }
            });
        });
        
        // Profile toggle handlers
        document.querySelectorAll(".profile-toggle").forEach(toggle => {
            toggle.addEventListener("change", async (e) => {
                e.stopPropagation();
                const profileName = toggle.getAttribute("data-profile");
                const isEnabled = toggle.checked;
                const card = toggle.closest(".profile-card");
                const badge = card?.querySelector(".profile-status-badge");
                
                toggle.disabled = true;
                
                let spinner = null;
                if (card) {
                    spinner = document.createElement("span");
                    spinner.className = "spinner-border spinner-border-sm position-absolute top-0 end-0 m-2";
                    spinner.setAttribute("role", "status");
                    spinner.innerHTML = '<span class="visually-hidden">Loading...</span>';
                    card.style.position = "relative";
                    card.appendChild(spinner);
                }
                
                try {
                    const response = await fetch(interestProfileEndpoints.toggle, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            name: profileName, 
                            enabled: isEnabled 
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error("Failed to toggle profile");
                    }
                    
                    if (card) {
                        if (isEnabled) {
                            card.classList.remove("disabled");
                            if (badge) {
                                badge.textContent = "Active";
                                badge.classList.remove("bg-secondary");
                                badge.classList.add("bg-primary");
                            }
                        } else {
                            card.classList.add("disabled");
                            if (badge) {
                                badge.textContent = "Disabled";
                                badge.classList.remove("bg-primary");
                                badge.classList.add("bg-secondary");
                            }
                        }
                    }
                    
                    appendLog(`Profile "${profileName}" ${isEnabled ? "enabled" : "disabled"}`);
                    showToast(`Profile ${isEnabled ? "enabled" : "disabled"}`, "info");
                } catch (error) {
                    console.error("Failed to toggle profile:", error);
                    showToast("Failed to toggle profile", "error");
                    toggle.checked = !isEnabled;
                } finally {
                    toggle.disabled = false;
                    if (spinner && spinner.parentNode) {
                        spinner.parentNode.removeChild(spinner);
                    }
                }
            });
        });
        
        // Stop propagation on toggle container clicks
        document.querySelectorAll(".form-check.form-switch").forEach(container => {
            container.addEventListener("click", (e) => {
                e.stopPropagation();
            });
        });
        
        // Advanced section toggle icon rotation
        const advancedCollapse = document.getElementById("advanced-config");
        const collapseIcon = document.getElementById("collapse-icon");
        
        if (advancedCollapse && collapseIcon) {
            if (advancedCollapse.classList.contains("show")) {
                collapseIcon.style.transform = "rotate(90deg)";
                collapseIcon.style.transition = "transform 0.2s ease";
            }
            
            advancedCollapse.addEventListener("show.bs.collapse", () => {
                collapseIcon.style.transform = "rotate(90deg)";
                collapseIcon.style.transition = "transform 0.2s ease";
            });
            
            advancedCollapse.addEventListener("hide.bs.collapse", () => {
                collapseIcon.style.transform = "";
                collapseIcon.style.transition = "transform 0.2s ease";
            });
        }
        
        // Export handler
        document.getElementById("btn-export-profiles")?.addEventListener("click", async () => {
            try {
                appendLog("Exporting interests...");
                const response = await fetch(interestProfileEndpoints.export);
                if (!response.ok) {
                    throw new Error("Export failed");
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `interests_${new Date().toISOString().replace(/[:.]/g, '-')}.yml`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                appendLog("Interests exported successfully");
                showToast("Interests exported", "success");
            } catch (error) {
                console.error(error);
                appendLog("Export failed");
                showToast("Export failed. Check console for details.", "error");
            }
        });
        
        // Import handler placeholder
        document.getElementById("btn-import-profiles")?.addEventListener("click", () => {
            showToast("Import not yet implemented", "info");
        });
    });
</script>

<!-- Global Profiles Management JavaScript -->
<script src="{{ url_for('static', filename='js/global_profiles.js') }}"></script>

{% endblock %}
