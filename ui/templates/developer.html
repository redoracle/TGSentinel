{% extends "base.html" %}
{% block title %}Developer · TG Sentinel{% endblock %}

{% block content %}
<section class="row g-4 mb-4">
    <div class="col-12 col-xl-6">
        <article class="card h-100" aria-labelledby="integration-heading">
            <div class="card-header">
                <h1 class="card-title mb-0" id="integration-heading">Integration Settings</h1>
            </div>
            <div class="card-body d-grid gap-3">
                <div>
                    <label class="form-label" for="prometheus-port">Prometheus port</label>
                    <input class="form-control" id="prometheus-port" type="number" value="9100" min="1" max="65535">
                </div>
                <div>
                    <label class="form-label" for="api-key">API key</label>
                    <div class="input-group">
                        <input class="form-control" id="api-key" type="text" value="" placeholder="Generate secure key" autocomplete="off" readonly>
                        <button class="btn btn-outline-primary" type="button" id="btn-generate-key">Generate</button>
                        <button class="btn btn-outline-secondary" type="button" id="btn-copy-key" aria-label="Copy generated API key" disabled>Copy</button>
                    </div>
                    <small class="text-muted">Keys are only shown once—copy immediately after generation.</small>
                </div>
                <div class="d-flex gap-3">
                    <button class="btn btn-outline-primary" type="button" id="btn-open-docs">Open local API docs</button>
                    <button class="btn btn-outline-primary" type="button" id="btn-save-developer">Save</button>
                </div>
            </div>
        </article>
    </div>
    <div class="col-12 col-xl-6">
        <article class="card h-100" aria-labelledby="webhook-table-heading">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="card-title mb-0" id="webhook-table-heading">Webhooks</h2>
                <button class="btn btn-primary btn-sm" type="button" id="btn-add-webhook">
                    <i class="bi bi-plus-circle"></i> Add Webhook
                </button>
            </div>
            <div class="card-body">
                <div id="webhook-form" class="d-none mb-3">
                    <form id="form-webhook">
                        <div class="mb-3">
                            <label class="form-label" for="webhook-service">Service Name</label>
                            <input class="form-control form-control-sm" id="webhook-service" type="text" placeholder="e.g., Pushover, Discord, Slack" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label" for="webhook-url">Webhook URL</label>
                            <input class="form-control form-control-sm" id="webhook-url" type="url" placeholder="https://" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="webhook-secret">Secret/Token (optional)</label>
                            <input class="form-control form-control-sm" id="webhook-secret" type="password" placeholder="Authentication token">
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary btn-sm" type="submit">Create</button>
                            <button class="btn btn-outline-secondary btn-sm" type="button" id="btn-cancel-webhook">Cancel</button>
                        </div>
                    </form>
                    <hr class="my-3">
                </div>
                <div class="table-responsive">
                    <table class="table align-middle mb-0" id="webhook-table">
                        <thead>
                            <tr>
                                <th scope="col">Service</th>
                                <th scope="col">URL</th>
                                <th scope="col">Secret</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="webhook-table-body">
                            <tr id="webhook-loading">
                                <td colspan="4" class="text-center text-muted">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    Loading webhooks...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </article>
    </div>
</section>

<section class="card" aria-labelledby="developer-console-heading">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="card-title mb-0" id="developer-console-heading">Integration Console</h2>
        <button class="btn btn-outline-primary btn-sm" type="button" id="btn-webhook-test">Send sample alert</button>
    </div>
    <div class="card-body">
        <div class="logs-viewer" id="developer-log" aria-live="polite">
            <pre class="mb-0">Awaiting integration events...</pre>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    function appendDeveloperLog(message) {
        const log = document.getElementById("developer-log");
        if (!log) {
            return;
        }
        const entry = document.createElement("div");
        entry.className = "log-entry";
        const time = document.createElement("span");
        time.className = "log-time";
        time.textContent = new Date().toLocaleTimeString();

        const spacer = document.createTextNode(" ");

        const logMessage = document.createElement("span");
        logMessage.className = "log-message";
        logMessage.textContent = String(message ?? "");

        entry.appendChild(time);
        entry.appendChild(spacer);
        entry.appendChild(logMessage);
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }

    function randomKey() {
        // Require Web Crypto API for secure key generation
        if (!window.crypto || !window.crypto.getRandomValues) {
            const errorMsg = "Secure random number generation unavailable. " +
                           "Web Crypto API is required for API key generation. " +
                           "Please use a modern browser (Chrome 11+, Firefox 21+, Safari 6.1+, Edge 12+).";
            console.error("[Security] " + errorMsg);
            showToast(errorMsg, "error");
            throw new Error("Web Crypto API unavailable - cannot generate secure API keys");
        }
        
        // Generate cryptographically secure random key
        const array = window.crypto.getRandomValues(new Uint8Array(32));
        return Array.from(array, (byte) => byte.toString(16).padStart(2, "0")).join("");
    }

    let pendingApiKey = null;
    const API_KEY_MASK = "•".repeat(16);

    function clearPendingApiKey() {
        pendingApiKey = null;
        const input = document.getElementById("api-key");
        const copyBtn = document.getElementById("btn-copy-key");
        if (input) {
            input.value = "";
        }
        if (copyBtn) {
            copyBtn.disabled = true;
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        const apiKeyInput = document.getElementById("api-key");
        const copyButton = document.getElementById("btn-copy-key");

        // Load webhooks on page load
        loadWebhooks();

        // Add webhook button
        document.getElementById("btn-add-webhook")?.addEventListener("click", () => {
            const webhookForm = document.getElementById("webhook-form");
            webhookForm?.classList.remove("d-none");
            document.getElementById("webhook-service")?.focus();
        });

        // Cancel webhook button
        document.getElementById("btn-cancel-webhook")?.addEventListener("click", () => {
            const webhookForm = document.getElementById("webhook-form");
            webhookForm?.classList.add("d-none");
            document.getElementById("form-webhook")?.reset();
        });

        // Submit webhook form
        document.getElementById("form-webhook")?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const service = document.getElementById("webhook-service").value.trim();
            const url = document.getElementById("webhook-url").value.trim();
            const secret = document.getElementById("webhook-secret").value.trim();

            if (!service || !url) {
                showToast("Service name and URL are required", "error");
                return;
            }

            try {
                const response = await fetch("/api/webhooks", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ service, url, secret }),
                });

                const data = await response.json();

                if (response.ok) {
                    showToast(`Webhook '${service}' created successfully`, "success");
                    appendDeveloperLog(`Created webhook: ${service}`);
                    const webhookForm = document.getElementById("webhook-form");
                    webhookForm?.classList.add("d-none");
                    document.getElementById("form-webhook")?.reset();
                    loadWebhooks(); // Reload the table
                } else {
                    showToast(data.message || "Failed to create webhook", "error");
                }
            } catch (error) {
                console.error("Error creating webhook:", error);
                showToast("Failed to create webhook", "error");
            }
        });

        document.getElementById("btn-generate-key")?.addEventListener("click", () => {
            try {
                pendingApiKey = randomKey();
                if (apiKeyInput) {
                    apiKeyInput.value = API_KEY_MASK;
                }
                if (copyButton) {
                    copyButton.disabled = false;
                }
                appendDeveloperLog("Generated new API key");
            } catch (error) {
                console.error("Failed to generate API key:", error);
                appendDeveloperLog("ERROR: " + error.message);
                if (apiKeyInput) {
                    apiKeyInput.value = "";
                }
                if (copyButton) {
                    copyButton.disabled = true;
                }
            }
        });
        document.getElementById("btn-open-docs")?.addEventListener("click", () => {
            window.open("/docs", "_blank");
        });
        copyButton?.addEventListener("click", async () => {
            if (!pendingApiKey) {
                showToast("Generate an API key first", "warning");
                return;
            }
            let secret = pendingApiKey;
            clearPendingApiKey();
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(secret);
                } else {
                    const helper = document.createElement("textarea");
                    helper.value = secret;
                    helper.setAttribute("readonly", "");
                    helper.style.position = "absolute";
                    helper.style.left = "-9999px";
                    document.body.appendChild(helper);
                    helper.select();
                    helper.setSelectionRange(0, helper.value.length);
                    document.execCommand("copy");
                    helper.remove();
                }
                showToast("API key copied to clipboard", "success");
            } catch (error) {
                console.error("Failed to copy API key", error);
                showToast("Unable to copy API key. Generate a new one.", "error");
            } finally {
                secret = "";
            }
        });
        document.getElementById("btn-save-developer")?.addEventListener("click", () => showToast("Developer settings saved", "success"));
        document.getElementById("btn-webhook-test")?.addEventListener("click", () => {
            appendDeveloperLog("Webhook test dispatched");
            showToast("Webhook test queued", "success");
        });
    });

    async function loadWebhooks() {
        const tbody = document.getElementById("webhook-table-body");
        if (!tbody) return;

        try {
            const response = await fetch("/api/webhooks");
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.message || "Failed to load webhooks");
            }

            tbody.innerHTML = "";

            if (data.webhooks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-3">
                            No webhooks configured. Click "Add Webhook" to create one.
                        </td>
                    </tr>
                `;
                return;
            }

            data.webhooks.forEach((webhook) => {
                const row = document.createElement("tr");
                
                // Service column
                const serviceCell = document.createElement("td");
                serviceCell.textContent = webhook.service || "Unknown";
                row.appendChild(serviceCell);

                // URL column with copy button and tooltip
                const urlCell = document.createElement("td");
                const urlContainer = document.createElement("div");
                urlContainer.className = "d-flex align-items-center gap-2";
                
                const urlSpan = document.createElement("span");
                urlSpan.className = "text-truncate";
                urlSpan.style.maxWidth = "200px";
                urlSpan.textContent = webhook.url || "";
                urlSpan.title = webhook.url || ""; // Full URL on hover
                
                const copyBtn = document.createElement("button");
                copyBtn.className = "btn btn-outline-secondary btn-sm";
                copyBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
                copyBtn.title = "Copy URL";
                copyBtn.setAttribute("data-url", webhook.url);
                copyBtn.addEventListener("click", async function() {
                    const url = this.getAttribute("data-url");
                    try {
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            await navigator.clipboard.writeText(url);
                        } else {
                            // Fallback for browsers without Clipboard API
                            const textarea = document.createElement("textarea");
                            textarea.value = url;
                            textarea.setAttribute("readonly", "");
                            textarea.style.position = "absolute";
                            textarea.style.left = "-9999px";
                            document.body.appendChild(textarea);
                            textarea.select();
                            textarea.setSelectionRange(0, textarea.value.length);
                            const success = document.execCommand("copy");
                            document.body.removeChild(textarea);
                            if (!success) {
                                throw new Error("execCommand failed");
                            }
                        }
                        showToast("URL copied to clipboard", "success");
                    } catch (err) {
                        console.error("Failed to copy:", err);
                        showToast("Failed to copy URL", "error");
                    }
                });
                
                urlContainer.appendChild(urlSpan);
                urlContainer.appendChild(copyBtn);
                urlCell.appendChild(urlContainer);
                row.appendChild(urlCell);

                // Secret column
                const secretCell = document.createElement("td");
                secretCell.textContent = webhook.secret || "—";
                row.appendChild(secretCell);

                // Actions column
                const actionsCell = document.createElement("td");
                const btnGroup = document.createElement("div");
                btnGroup.className = "btn-group";
                btnGroup.setAttribute("role", "group");

                const testBtn = document.createElement("button");
                testBtn.className = "btn btn-outline-primary btn-sm";
                testBtn.textContent = "Test";
                testBtn.addEventListener("click", () => {
                    appendDeveloperLog(`Webhook test sent: ${webhook.service}`);
                    showToast(`Testing webhook: ${webhook.service}`, "info");
                });

                const deleteBtn = document.createElement("button");
                deleteBtn.className = "btn btn-outline-danger btn-sm";
                deleteBtn.textContent = "Delete";
                deleteBtn.addEventListener("click", async () => {
                    if (!confirm(`Remove webhook '${webhook.service}'? This action cannot be undone.`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`/api/webhooks/${encodeURIComponent(webhook.service)}`, {
                            method: "DELETE",
                        });

                        const result = await response.json();

                        if (response.ok) {
                            showToast(`Webhook '${webhook.service}' deleted`, "success");
                            appendDeveloperLog(`Deleted webhook: ${webhook.service}`);
                            loadWebhooks(); // Reload the table
                        } else {
                            showToast(result.message || "Failed to delete webhook", "error");
                        }
                    } catch (error) {
                        console.error("Error deleting webhook:", error);
                        showToast("Failed to delete webhook", "error");
                    }
                });

                btnGroup.appendChild(testBtn);
                btnGroup.appendChild(deleteBtn);
                actionsCell.appendChild(btnGroup);
                row.appendChild(actionsCell);

                tbody.appendChild(row);
            });

        } catch (error) {
            console.error("Error loading webhooks:", error);
            // Clear tbody safely
            tbody.innerHTML = "";
            
            // Create error row with safe text insertion
            const errorRow = document.createElement("tr");
            const errorCell = document.createElement("td");
            errorCell.colSpan = 4;
            errorCell.className = "text-center text-danger py-3";
            errorCell.textContent = `Failed to load webhooks: ${error.message}`;
            errorRow.appendChild(errorCell);
            tbody.appendChild(errorRow);
        }
    }
</script>
{% endblock %}
