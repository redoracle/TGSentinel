{% extends "base.html" %}
{% block title %}Alerts ¬∑ TG Sentinel{% endblock %}

{% block content %}
<section class="row g-4 mb-4">
    <div class="col-12">
        <article class="card" aria-labelledby="alerts-table-heading">
            <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-3">
                <button class="text-start p-0 d-flex align-items-center gap-2 border-0 bg-transparent text-decoration-none text-reset" type="button" data-bs-toggle="collapse" data-bs-target="#alerts-table-body" aria-expanded="true" aria-controls="alerts-table-body">
                    <i class="bi bi-chevron-right collapse-icon fs-7"></i>
                    <div>
                        <h1 class="card-title mb-0" id="alerts-table-heading">Alerts Feed</h1>
                        <small class="text-muted">Sortable table of triggered notifications</small>
                    </div>
                </button>
                <div class="d-flex gap-2">
                    <a href="/docs#alerts-api" class="btn btn-outline-primary btn-sm" title="View alerts documentation" target="_blank" rel="noopener">
                        <i class="bi bi-info-circle"></i>
                    </a>
                    <button class="btn btn-outline-primary btn-sm" type="button" id="btn-export-alerts">Export CSV</button>
                    <button class="btn btn-outline-primary btn-sm" type="button" id="btn-refresh-alerts">Refresh</button>
                </div>
            </div>
            <div class="collapse show card-body p-0" id="alerts-table-body">
                <div class="alerts-list-container" id="alerts-list-container">
                    <div class="list-group list-group-flush" id="alerts-list">
                        {%- for alert in alerts %}
                        <div class="list-group-item list-group-item-action alert-list-item" data-alert-id="{{ alert.msg_id }}">
                            <div class="d-flex w-100 justify-content-between align-items-start gap-3">
                                <div class="flex-grow-1 min-w-0">
                                    <!-- Channel and Sender -->
                                    <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                                        <a href="#" class="text-decoration-none channel-link fw-semibold" 
                                           data-chat-id="{{ alert.chat_id }}" 
                                           data-chat-name="{{ alert.chat_name | e }}" 
                                           data-bs-toggle="modal" 
                                           data-bs-target="#channelActionsModal"
                                           title="Click to manage channel">
                                            {{ alert.chat_name }}
                                        </a>
                                        <span class="text-muted">‚Ä¢</span>
                                        <small class="text-muted">{{ alert.sender | default("Unknown") }}</small>
                                        <span class="badge bg-danger ms-auto">{{ '%.2f'|format(alert.score) }}</span>
                                    </div>
                                    
                                    <!-- Message Excerpt -->
                                    <p class="mb-2 text-truncate" 
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="auto"
                                       data-bs-custom-class="excerpt-tooltip"
                                       data-bs-title="{{ (alert.message_text or alert.excerpt) | e }}">
                                        {{ alert.excerpt }}
                                    </p>
                                    
                                    <!-- Metadata Row -->
                                    <div class="d-flex gap-2 flex-wrap align-items-center">
                                        {% if alert.trigger and alert.trigger != 'N/A' %}
                                        <small class="text-muted">üîî {{ alert.trigger|e }}</small>
                                        {% endif %}
                                        {% if alert.matched_profiles %}
                                        <small class="text-muted">üìã {{ alert.matched_profiles|length }} profiles</small>
                                        {% endif %}
                                        {% set _date = alert.created_at.split(' ')[0] if alert.created_at else '' %}
                                        {% set _time = alert.created_at.split(' ')[1] if alert.created_at and alert.created_at.split(' ')|length > 1 else '' %}
                                        {% if alert.created_at %}
                                        <small class="text-muted" 
                                               data-bs-toggle="tooltip"
                                               data-bs-html="true"
                                               data-bs-placement="top"
                                               data-bs-title='<div><div><strong>Date:</strong> {{ _date }}</div><div><strong>Time:</strong> {{ _time }}</div><div><strong>Destination:</strong> {{ alert.sent_to }}</div></div>'>
                                            ‚è∞ {{ _date }} {{ _time }}
                                        </small>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Feedback Actions -->
                                <div class="d-flex flex-column gap-2">
                                    <div class="btn-group btn-group-sm" role="group" aria-label="Feedback controls">
                                        <button class="btn btn-outline-warning btn-feedback" data-score="up" data-chat-id="{{ alert.chat_id }}" data-msg-id="{{ alert.msg_id | default(0) }}" type="button" aria-label="Give positive feedback" title="Helpful">üëç</button>
                                        <button class="btn btn-outline-warning btn-feedback" data-score="down" data-chat-id="{{ alert.chat_id }}" data-msg-id="{{ alert.msg_id | default(0) }}" type="button" aria-label="Give negative feedback" title="Not helpful">üëé</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {%- else %}
                        <div class="alert-profiles-empty">
                            <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                            </svg>
                            <p class="mb-2">No alerts recorded yet</p>
                            <small>System will populate this list as triggers fire</small>
                        </div>
                        {%- endfor %}
                    </div>
                </div>
            </div>
        </article>
    </div>
</section>

<section class="row g-4 mb-4">
    <div class="col-12">
        <article class="card" aria-labelledby="digest-timeline-heading">
            <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-3">
                <button class="text-start p-0 d-flex align-items-center gap-2 border-0 bg-transparent text-decoration-none text-reset" type="button" data-bs-toggle="collapse" data-bs-target="#digest-timeline-body" aria-expanded="true" aria-controls="digest-timeline-body">
                    <i class="bi bi-chevron-right collapse-icon fs-7"></i>
                    <div>
                        <h2 class="card-title mb-0" id="digest-timeline-heading">Digest Timeline</h2>
                        <small class="text-muted">Aggregated alert batches</small>
                    </div>
                </button>
                <div class="d-flex gap-2">
                    <a href="/docs#digest-api" class="btn btn-outline-primary btn-sm" title="View digest documentation" target="_blank" rel="noopener">
                        <i class="bi bi-info-circle"></i>
                    </a>
                    <button class="btn btn-outline-primary btn-sm" type="button" id="btn-download-digest">Download JSON</button>
                </div>
            </div>
            <div class="collapse show card-body" id="digest-timeline-body">
                <h5 class="mb-3">Sent Digest Batches</h5>
                <div id="digest-timeline">
                    <div class="text-center text-muted">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        Loading digest history...
                    </div>
                </div>
            </div>
        </article>
    </div>
</section>

<!-- Channel Quick Actions Modal -->
<div class="modal fade" id="channelActionsModal" tabindex="-1" aria-labelledby="channelActionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="channelActionsModalLabel">
                    <i class="bi bi-gear-fill me-2"></i>
                    <span id="modal-channel-name">Channel Actions</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <small>Quick actions for <strong id="modal-channel-name-2"></strong></small>
                </div>
                
                <div class="d-grid gap-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Channel Settings</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-warning btn-sm channel-action" data-action="mute" type="button">
                                    <i class="bi bi-volume-mute-fill me-2"></i>Mute Channel
                                </button>
                                <button class="btn btn-outline-success btn-sm channel-action" data-action="unmute" type="button">
                                    <i class="bi bi-volume-up-fill me-2"></i>Unmute Channel
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Thresholds</h6>
                            <div class="mb-3">
                                <label class="form-label" for="channel-reaction-threshold">Reaction Threshold</label>
                                <input type="number" class="form-control form-control-sm" id="channel-reaction-threshold" min="0" max="100" value="5">
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="channel-reply-threshold">Reply Threshold</label>
                                <input type="number" class="form-control form-control-sm" id="channel-reply-threshold" min="0" max="100" value="3">
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="channel-rate-limit">Rate Limit (per hour)</label>
                                <input type="number" class="form-control form-control-sm" id="channel-rate-limit" min="0" max="100" value="10">
                            </div>
                            <button class="btn btn-primary btn-sm w-100 channel-action" data-action="update-thresholds" type="button">
                                <i class="bi bi-save me-2"></i>Save Thresholds
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Keywords</h6>
                            <div class="mb-3">
                                <label class="form-label" for="channel-keywords">Keywords (comma-separated)</label>
                                <textarea class="form-control form-control-sm" id="channel-keywords" rows="2" placeholder="urgent, important, breaking"></textarea>
                            </div>
                            <button class="btn btn-primary btn-sm w-100 channel-action" data-action="update-keywords" type="button">
                                <i class="bi bi-save me-2"></i>Save Keywords
                            </button>
                        </div>
                    </div>
                    
                    <div class="card border-danger">
                        <div class="card-body">
                            <h6 class="card-title text-danger">Danger Zone</h6>
                            <button class="btn btn-outline-danger btn-sm w-100 channel-action" data-action="remove" type="button">
                                <i class="bi bi-trash-fill me-2"></i>Remove Channel from Monitoring
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const alertsEndpoint = "{{ url_for('dashboard.recent_alerts') }}";
    const digestsEndpoint = "{{ url_for('dashboard.alert_digests') }}";
    const digestSchedulesEndpoint = "/api/digest/schedules"; // Proxied through UI or direct to Sentinel

    function escapeHtml(value) {
        if (value === null || value === undefined) {
            return "";
        }
        return String(value)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    async function refreshAlerts() {
        try {
            const response = await fetch(`${alertsEndpoint}?limit=250`);
            if (!response.ok) {
                throw new Error("Alerts fetch failed");
            }
            const payload = await response.json();
            renderAlertsTable(payload.alerts || []);
        } catch (error) {
            console.error(error);
            showToast("Unable to refresh alerts", "error");
        }
    }

    function renderAlertsTable(alerts) {
        const listContainer = document.querySelector("#alerts-list");
        if (!listContainer) {
            return;
        }
        if (!alerts.length) {
            listContainer.innerHTML = `
                <div class="alert-profiles-empty">
                    <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                    </svg>
                    <p class="mb-2">No alerts available</p>
                    <small>Refresh to check for new alerts</small>
                </div>
            `;
            return;
        }
        const items = alerts.map((alert, index) => {
            // Use msg_id directly from API response
            const msgId = alert.msg_id || 0;
            
            // Format timestamp
            let date = '';
            let time = '';
            let timestampDisplay = '';
            if (alert.created_at) {
                const ps = alert.created_at.split(' ');
                date = ps[0] || '';
                time = ps[1] || '';
                timestampDisplay = `${date} ${time}`;
            }
            
            // Profile count
            const profileCount = alert.matched_profiles ? alert.matched_profiles.length : 0;
            
            return `
            <div class="list-group-item list-group-item-action alert-list-item" data-alert-id="${msgId}">
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <div class="flex-grow-1 min-w-0 me-2">
                        <!-- Title Row: Channel Name + Score Badge -->
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <h6 class="mb-0 text-truncate">
                                <a href="#" class="text-decoration-none channel-link" 
                                   data-chat-id="${escapeHtml(alert.chat_id)}" 
                                   data-chat-name="${escapeHtml(alert.chat_name)}" 
                                   data-bs-toggle="modal" 
                                   data-bs-target="#channelActionsModal"
                                   title="Click to manage channel">
                                    ${escapeHtml(alert.chat_name)}
                                </a>
                            </h6>
                            <span class="badge bg-danger badge-sm">Score: ${escapeHtml(Number(alert.score || 0).toFixed(2))}</span>
                        </div>
                        
                        <!-- Sender Info -->
                        ${alert.sender && alert.sender !== 'Unknown' ? `<p class="mb-1 small text-muted text-truncate">From: ${escapeHtml(alert.sender)}</p>` : ''}
                        
                        <!-- Message Excerpt -->
                        <p class="mb-2 small text-truncate" 
                           data-bs-toggle="tooltip"
                           data-bs-placement="auto"
                           data-bs-custom-class="excerpt-tooltip"
                           data-bs-title="${escapeHtml(alert.message_text || alert.excerpt)}">
                            ${escapeHtml(alert.excerpt)}
                        </p>
                        
                        <!-- Metadata Row with Icons -->
                        <div class="d-flex gap-2 flex-wrap">
                            <small class="text-muted">ID: ${msgId}</small>
                            ${alert.trigger && alert.trigger !== 'N/A' ? `<small class="text-muted">üîî ${escapeHtml(alert.trigger)}</small>` : ''}
                            ${profileCount > 0 ? `<small class="text-muted">üìã ${profileCount}</small>` : ''}
                            ${timestampDisplay ? `<small class="text-muted" 
                                   data-bs-toggle="tooltip"
                                   data-bs-html="true"
                                   data-bs-placement="top"
                                   data-bs-title='<div><div><strong>Date:</strong> ${escapeHtml(date)}</div><div><strong>Time:</strong> ${escapeHtml(time)}</div><div><strong>Destination:</strong> ${escapeHtml(alert.sent_to || "dm")}</div></div>'>
                                ‚è∞ ${escapeHtml(timestampDisplay)}
                            </small>` : ''}
                        </div>
                    </div>
                    
                    <!-- Actions Column -->
                    <div class="d-flex flex-column align-items-end gap-2">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-warning btn-feedback" data-score="up" data-chat-id="${escapeHtml(alert.chat_id)}" data-msg-id="${msgId}" type="button" title="Helpful">
                                <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2.144 2.144 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a9.84 9.84 0 0 0-.443.05 9.365 9.365 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111L8.864.046zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a8.908 8.908 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.224 2.224 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.866.866 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
                                </svg>
                            </button>
                            <button class="btn btn-outline-warning btn-feedback" data-score="down" data-chat-id="${escapeHtml(alert.chat_id)}" data-msg-id="${msgId}" type="button" title="Not helpful">
                                <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M8.864 15.674c-.956.24-1.843-.484-1.908-1.42-.072-1.05-.23-2.015-.428-2.59-.125-.36-.479-1.012-1.04-1.638-.557-.624-1.282-1.179-2.131-1.41C2.685 8.432 2 7.85 2 7V3c0-.845.682-1.464 1.448-1.546 1.07-.113 1.564-.415 2.068-.723l.048-.029c.272-.166.578-.349.97-.484C6.931.08 7.395 0 8 0h3.5c.937 0 1.599.478 1.934 1.064.164.287.254.607.254.913 0 .152-.023.312-.077.464.201.262.38.577.488.9.11.33.172.762.004 1.15.069.13.12.268.159.403.077.27.113.567.113.856 0 .289-.036.586-.113.856-.035.12-.08.244-.138.363.394.571.418 1.2.234 1.733-.206.592-.682 1.1-1.2 1.272-.847.283-1.803.276-2.516.211a9.877 9.877 0 0 1-.443-.05 9.364 9.364 0 0 1-.062 4.51c-.138.508-.55.848-1.012.964l-.261.065zM11.5 1H8c-.51 0-.863.068-1.14.163-.281.097-.506.229-.776.393l-.04.025c-.555.338-1.198.73-2.49.868-.333.035-.554.29-.554.55V7c0 .255.226.543.62.65 1.095.3 1.977.997 2.614 1.709.635.71 1.064 1.475 1.238 1.977.243.7.407 1.768.482 2.85.025.362.36.595.667.518l.262-.065c.16-.04.258-.144.288-.255a8.34 8.34 0 0 0-.145-4.726.5.5 0 0 1 .595-.643h.003l.014.004.058.013a8.912 8.912 0 0 0 1.036.157c.663.06 1.457.054 2.11-.163.175-.059.45-.301.57-.651.107-.308.087-.67-.266-1.021L12.793 7l.353-.354c.043-.042.105-.14.154-.315.048-.167.075-.37.075-.581 0-.211-.027-.414-.075-.581-.05-.174-.111-.273-.154-.315l-.353-.354.353-.354c.047-.047.109-.176.005-.488a2.224 2.224 0 0 0-.505-.804l-.353-.354.353-.354c.006-.005.041-.05.041-.17a.866.866 0 0 0-.121-.415C12.4 1.272 12.063 1 11.5 1z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join("");
        listContainer.innerHTML = items;
        
        // Re-init tooltips for dynamically injected elements
        initTooltips(listContainer);
    }

    async function refreshDigests() {
        try {
            const response = await fetch(digestsEndpoint);
            if (!response.ok) {
                throw new Error("Digests fetch failed");
            }
            const payload = await response.json();
            renderDigests(payload.digests || []);
        } catch (error) {
            console.error(error);
            showToast("Unable to refresh digests", "error");
        }
    }

    function initTooltips(context=document) {
        try {
            const nodes = (context || document).querySelectorAll('[data-bs-toggle="tooltip"]');
            nodes.forEach(el => {
                // Dispose existing instance if any
                const existing = bootstrap.Tooltip.getInstance(el);
                if (existing) existing.dispose();
                new bootstrap.Tooltip(el, { container: 'body', html: true, delay: { show: 0, hide: 100 } });
            });
        } catch (e) {
            console.debug('Tooltip init failed:', e);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        initTooltips();
    });

    function renderProfileBadges(matchedProfiles) {
        if (!matchedProfiles || matchedProfiles.length === 0) {
            return '<span class="text-muted">‚Äî</span>';
        }
        
        // Parse if string (JSON)
        let profiles = matchedProfiles;
        if (typeof matchedProfiles === 'string') {
            try {
                profiles = JSON.parse(matchedProfiles);
            } catch (e) {
                return '<span class="text-muted">‚Äî</span>';
            }
        }
        
        // Show first 3 profiles as badges
        const badgeColors = ['secondary', 'info', 'success', 'warning', 'primary'];
        const badges = profiles.slice(0, 3).map((profile, idx) => {
            const color = badgeColors[idx % badgeColors.length];
            return `<span class="badge bg-${color} me-1" title="Profile: ${escapeHtml(profile)}">${escapeHtml(profile)}</span>`;
        }).join('');
        
        const remaining = profiles.length - 3;
        const remainingBadge = remaining > 0 ? `<span class="badge bg-dark" title="${remaining} more profile(s)">+${remaining}</span>` : '';
        
        return badges + remainingBadge;
    }

    async function loadDigestSchedules() {
        const loadingEl = document.getElementById('digest-loading');
        const schedulesEl = document.getElementById('digest-schedules');
        const emptyEl = document.getElementById('digest-empty');
        
        try {
            // Fetch from UI proxy endpoint (avoids CSP violation)
            const response = await fetch('/api/digest/schedules', {
                headers: { 'Accept': 'application/json' }
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch digest schedules');
            }
            
            const data = await response.json();
            
            if (loadingEl) loadingEl.classList.add('d-none');
            
            if (!data.data || !data.data.schedules || data.data.schedules.length === 0) {
                if (emptyEl) emptyEl.classList.remove('d-none');
                return;
            }
            
            renderDigestSchedules(data.data.schedules);
            if (schedulesEl) schedulesEl.classList.remove('d-none');
            
        } catch (error) {
            console.error('Failed to load digest schedules:', error);
            if (loadingEl) loadingEl.classList.add('d-none');
            if (emptyEl) {
                emptyEl.innerHTML = '<p class="text-muted mb-0">Unable to load digest schedules. Check Sentinel API connection.</p>';
                emptyEl.classList.remove('d-none');
            }
        }
    }

    function renderDigestSchedules(schedules) {
        const container = document.getElementById('digest-schedules');
        if (!container) return;
        
        const scheduleIcons = {
            'hourly': '‚è∞',
            'every_4h': 'üïì',
            'every_6h': 'üïï',
            'every_12h': 'üïõ',
            'daily': 'üìÖ',
            'weekly': 'üìä',
            'none': 'üö´'
        };
        
        const scheduleNames = {
            'hourly': 'Hourly',
            'every_4h': 'Every 4 Hours',
            'every_6h': 'Every 6 Hours',
            'every_12h': 'Every 12 Hours',
            'daily': 'Daily',
            'weekly': 'Weekly',
            'none': 'Disabled'
        };
        
        const html = schedules.map(sched => {
            const icon = scheduleIcons[sched.schedule] || 'üì¨';
            const name = scheduleNames[sched.schedule] || sched.schedule;
            const profileBadges = renderProfileBadges(sched.profiles);
            
            return `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h4 class="h6 mb-0">${icon} ${name} Digest</h4>
                            <span class="badge bg-${sched.enabled ? 'success' : 'secondary'}">
                                ${sched.enabled ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        <div class="mb-2">
                            <strong>Profiles:</strong> ${profileBadges}
                        </div>
                        <div class="text-muted small">
                            <div>Next run: ${sched.next_run ? new Date(sched.next_run).toLocaleString() : 'Not scheduled'}</div>
                            <div>Last run: ${sched.last_run ? new Date(sched.last_run).toLocaleString() : 'Never'}</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
    }

    function renderDigests(digests) {
        const timeline = document.getElementById("digest-timeline");
        if (!timeline) {
            return;
        }
        if (!digests.length) {
            timeline.innerHTML = '<p class="text-muted">No digest batches yet.</p>';
            return;
        }
        timeline.innerHTML = digests.map((digest) => `
            <div class="card mb-3" role="listitem">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h3 class="h5 mb-0">${escapeHtml(digest.date)}</h3>
                        <span class="badge bg-info" 
                              style="z-index: 1; cursor: help;"
                              data-bs-toggle="tooltip"
                              data-bs-placement="left"
                              data-bs-html="true"
                              data-bs-title="<div><strong>${escapeHtml(digest.items)} alert records</strong> on this day</div>">
                            ${escapeHtml(digest.items)} alerts
                        </span>
                    </div>
                    <p class="mb-0 text-muted">Average score: ${escapeHtml(digest.avg_score)}</p>
                </div>
            </div>`).join("");
        
        // Re-initialize tooltips for the new content
        initTooltips(timeline);
    }

    // Use event delegation to handle feedback button clicks
    // This prevents duplicate listeners on rapid refresh cycles
    function setupFeedbackDelegation() {
        const alertsList = document.querySelector("#alerts-list");
        if (!alertsList) {
            return;
        }
        
        // Remove any existing listener before adding new one
        const newAlertsList = alertsList.cloneNode(true);
        alertsList.parentNode.replaceChild(newAlertsList, alertsList);
        
        // Add single delegated listener to the alerts list
        newAlertsList.addEventListener("click", async (event) => {
            const button = event.target.closest(".btn-feedback");
            if (!button) {
                return; // Not a feedback button click
            }
            
            const chatId = button.getAttribute("data-chat-id");
            const msgId = button.getAttribute("data-msg-id");
            const label = button.getAttribute("data-score"); // "up" or "down"
            
            if (!chatId || !msgId) {
                showToast("Unable to record feedback: missing alert data", "error");
                return;
            }
            
            // Parse with explicit radix and validate
            const parsedChatId = parseInt(chatId, 10);
            const parsedMsgId = parseInt(msgId, 10);
            
            if (!Number.isInteger(parsedChatId) || Number.isNaN(parsedChatId)) {
                console.error("Invalid chat_id for feedback:", chatId);
                showToast("Unable to record feedback: invalid chat ID", "error");
                return;
            }
            
            if (!Number.isInteger(parsedMsgId) || Number.isNaN(parsedMsgId)) {
                console.error("Invalid msg_id for feedback:", msgId);
                showToast("Unable to record feedback: invalid message ID", "error");
                return;
            }
            
            try {
                const response = await fetch("{{ url_for('admin.submit_alert_feedback') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        chat_id: parsedChatId,
                        msg_id: parsedMsgId,
                        label: label
                    })
                });
                
                if (!response.ok) {
                    throw new Error("Feedback submission failed");
                }
                
                const result = await response.json();
                if (result.status === "ok") {
                    const direction = label === "up" ? "success" : "warning";
                    showToast("Feedback recorded", direction);
                    
                    // Visual feedback - briefly highlight the button
                    button.classList.add(label === "up" ? "btn-success" : "btn-danger");
                    button.classList.remove("btn-outline-warning");
                    setTimeout(() => {
                        button.classList.remove("btn-success", "btn-danger");
                        button.classList.add("btn-outline-warning");
                    }, 1500);
                } else {
                    throw new Error(result.message || "Unknown error");
                }
            } catch (error) {
                console.error("Feedback error:", error);
                showToast("Failed to record feedback", "error");
            }
        });
    }

    function bindInteractions() {
        setupFeedbackDelegation();
        document.getElementById("btn-refresh-alerts")?.addEventListener("click", refreshAlerts);
        document.getElementById("btn-download-digest")?.addEventListener("click", refreshDigests);
        document.getElementById("btn-export-alerts")?.addEventListener("click", async () => {
            try {
                // TODO: Implement export_alerts endpoint
                showToast("Export feature not yet implemented", "warning");
            } catch (err) {
                console.error("Export failed", err);
                showToast("Export failed", "error");
            }
        });
        document.getElementById("threshold-slider")?.addEventListener("input", (event) => {
            document.getElementById("threshold-value").textContent = Number(event.target.value).toFixed(1);
        });
        document.getElementById("btn-save-threshold")?.addEventListener("click", saveThreshold);
        document.querySelectorAll(".btn-action").forEach((button) => {
            button.addEventListener("click", () => {
                const action = button.getAttribute("data-action");
                showToast(`${action} action queued`, "info");
            });
        });
    }

    async function loadThreshold() {
        const sliderEl = document.getElementById("threshold-slider");
        const valueEl = document.getElementById("threshold-value");
        
        // These elements don't exist in alerts.html, skip gracefully
        if (!sliderEl || !valueEl) {
            return;
        }
        
        try {
            // Fetch from UI proxy endpoint (which queries Sentinel internally)
            const response = await fetch("/api/config/threshold");
            if (!response.ok) {
                throw new Error("Failed to load config from Sentinel");
            }
            const data = await response.json();
            if (data.status === "ok" && data.threshold !== undefined) {
                const threshold = Number(data.threshold);
                sliderEl.value = threshold;
                valueEl.textContent = threshold.toFixed(1);
            }
        } catch (error) {
            console.error("Error loading threshold:", error);
            // Keep default value if load fails
        }
    }

    async function saveThreshold() {
        const slider = document.getElementById("threshold-slider");
        if (!slider) {
            return; // Element doesn't exist in alerts.html
        }
        const threshold = Number(slider.value);
        
        try {
            // Save via UI proxy endpoint (which updates Sentinel config)
            const response = await fetch("/api/config/threshold", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ threshold })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || "Failed to save threshold");
            }
            
            const data = await response.json();
            if (data.status === "ok") {
                showToast("Threshold saved successfully", "success");
            } else {
                throw new Error(data.message || "Unknown error");
            }
        } catch (error) {
            console.error("Error saving threshold:", error);
            showToast(`Failed to save threshold: ${error.message}`, "error");
        }
    }

    // Channel modal state
    let currentChannelId = null;
    let currentChannelName = null;
    let currentChannelConfig = null;

    // Initialize channel modal
    function initChannelModal() {
        const modal = document.getElementById('channelActionsModal');
        if (!modal) return;

        modal.addEventListener('show.bs.modal', async function(event) {
            const button = event.relatedTarget;
            currentChannelId = button.getAttribute('data-chat-id');
            currentChannelName = button.getAttribute('data-chat-name');

            // Update modal title
            document.getElementById('modal-channel-name').textContent = currentChannelName;
            document.getElementById('modal-channel-name-2').textContent = currentChannelName;

            // Load channel configuration from Sentinel
            await loadChannelConfig(currentChannelId);
        });

        // Handle channel actions using event delegation
        modal.addEventListener('click', async function(event) {
            const button = event.target.closest('.channel-action');
            if (button) {
                const action = button.getAttribute('data-action');
                await handleChannelAction(action);
            }
        });
    }

    async function loadChannelConfig(chatId) {
        try {
            // Fetch full config for channel details
            const configResponse = await fetch(`/api/config/channels`);
            if (configResponse.ok) {
                const configData = await configResponse.json();
                const channels = configData.channels || [];
                currentChannelConfig = channels.find(ch => ch.id == chatId || ch.chat_id == chatId);

                if (currentChannelConfig) {
                    // Populate form fields with current values
                    document.getElementById('channel-reaction-threshold').value = currentChannelConfig.reaction_threshold || 5;
                    document.getElementById('channel-reply-threshold').value = currentChannelConfig.reply_threshold || 3;
                    document.getElementById('channel-rate-limit').value = currentChannelConfig.rate_limit_per_hour || 10;
                    document.getElementById('channel-keywords').value = (currentChannelConfig.keywords || []).join(', ');
                }
            }
        } catch (error) {
            console.error('Error loading channel config:', error);
            showToast('Failed to load channel configuration', 'error');
        }
    }

    async function handleChannelAction(action) {
        if (!currentChannelId) {
            showToast('No channel selected', 'error');
            return;
        }

        try {
            switch(action) {
                case 'mute':
                    await muteChannel(currentChannelId, true);
                    break;
                case 'unmute':
                    await muteChannel(currentChannelId, false);
                    break;
                case 'update-thresholds':
                    await updateChannelThresholds(currentChannelId);
                    break;
                case 'update-keywords':
                    await updateChannelKeywords(currentChannelId);
                    break;
                case 'remove':
                    await removeChannel(currentChannelId);
                    break;
                default:
                    showToast('Unknown action', 'warning');
            }
        } catch (error) {
            console.error(`Error handling ${action}:`, error);
            showToast(`Failed to ${action}: ${error.message}`, 'error');
        }
    }

    async function muteChannel(chatId, mute) {
        try {
            // Update rate_limit to effectively mute/unmute (set to 0 or restore)
            const rateLimit = mute ? 0 : (currentChannelConfig?.rate_limit_per_hour || 10);
            
            const response = await fetch(`/api/config/channels/${chatId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rate_limit_per_hour: rateLimit })
            });

            if (!response.ok) {
                let errorMessage = 'Failed to update config';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.message || errorMessage;
                } catch {
                    // JSON parsing failed, use default message
                }
                throw new Error(errorMessage);
            }

            showToast(`Channel ${mute ? 'muted' : 'unmuted'} successfully`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('channelActionsModal'))?.hide();
            refreshAlerts();
        } catch (error) {
            throw new Error(`Failed to ${mute ? 'mute' : 'unmute'} channel: ${error.message}`);
        }
    }

    async function updateChannelThresholds(chatId) {
        try {
            const reactionThreshold = parseInt(document.getElementById('channel-reaction-threshold').value, 10);
            const replyThreshold = parseInt(document.getElementById('channel-reply-threshold').value, 10);
            const rateLimit = parseInt(document.getElementById('channel-rate-limit').value, 10);

            const response = await fetch(`/api/config/channels/${chatId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reaction_threshold: reactionThreshold,
                    reply_threshold: replyThreshold,
                    rate_limit_per_hour: rateLimit
                })
            });

            if (!response.ok) {
                let errorMessage = 'Failed to update config';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.message || errorMessage;
                } catch {
                    // JSON parsing failed, use default message
                }
                throw new Error(errorMessage);
            }

            showToast('Thresholds updated successfully', 'success');
        } catch (error) {
            throw new Error(`Failed to update thresholds: ${error.message}`);
        }
    }

    async function updateChannelKeywords(chatId) {
        try {
            const keywordsText = document.getElementById('channel-keywords').value;
            const keywords = keywordsText.split(',').map(k => k.trim()).filter(k => k.length > 0);

            const response = await fetch(`/api/config/channels/${chatId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ keywords })
            });

            if (!response.ok) {
                let errorMessage = 'Failed to update config';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.message || errorMessage;
                } catch {
                    // JSON parsing failed, use default message
                }
                throw new Error(errorMessage);
            }

            showToast('Keywords updated successfully', 'success');
        } catch (error) {
            throw new Error(`Failed to update keywords: ${error.message}`);
        }
    }

    async function removeChannel(chatId) {
        if (!confirm(`Are you sure you want to remove "${currentChannelName}" from monitoring?`)) {
            return;
        }

        try {
            const response = await fetch(`/api/config/channels/${chatId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                let errorMessage = 'Failed to remove channel';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.message || errorMessage;
                } catch {
                    // JSON parsing failed, use default message
                }
                throw new Error(errorMessage);
            }

            showToast('Channel removed successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('channelActionsModal'))?.hide();
            refreshAlerts();
        } catch (error) {
            throw new Error(`Failed to remove channel: ${error.message}`);
        }
    }

    // Interval management to prevent duplicate timers
    let alertsIntervalId = null;
    let digestsIntervalId = null;

    function startIntervals() {
        // Clear any existing intervals before starting new ones
        stopIntervals();
        alertsIntervalId = setInterval(refreshAlerts, 120000);
        digestsIntervalId = setInterval(refreshDigests, 300000);
    }

    function stopIntervals() {
        if (alertsIntervalId !== null) {
            clearInterval(alertsIntervalId);
            alertsIntervalId = null;
        }
        if (digestsIntervalId !== null) {
            clearInterval(digestsIntervalId);
            digestsIntervalId = null;
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        loadThreshold();
        refreshAlerts();
        refreshDigests();
        bindInteractions();
        initChannelModal();
        startIntervals();
    });

    // Clean up intervals on page unload
    window.addEventListener("beforeunload", stopIntervals);

    // Pause intervals when page is hidden, resume when visible
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            stopIntervals();
        } else {
            startIntervals();
        }
    });
</script>
{% endblock %}
