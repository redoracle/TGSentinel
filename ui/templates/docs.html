{% extends "base.html" %}
{% block title %}API Documentation · TG Sentinel{% endblock %}

{% block extra_head %}
<!-- Highlight.js for syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" integrity="sha512-rO+olRTkcf304DQBxSWxln8JXCzTHlKnIdnMUwYvQa9/Jd4cQaNkItIUj6Z4nvW1dqK0SKXLbn9h4KwZTNtAyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
{% endblock %}

{% block body_attrs %} class="docs-page"{% endblock %}

{% block content %}
<section class="card docs-wrapper">
    <div class="card-header">
        <h1 class="card-title mb-0">Documentation Sets</h1>
        <small class="text-muted">Switch between Sentinel API, UI API, and YAML configuration references</small>
    </div>
    <div class="p-1 docs-tabs-shell">
        <ul class="nav nav-tabs nav-fill border-bottom-0" id="docsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="sentinel-docs-tab" type="button" data-docs-tab-button="sentinel" role="tab" aria-controls="sentinel-docs" aria-selected="true">
                    Sentinel API Documentation
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ui-docs-tab" type="button" data-docs-tab-button="ui" role="tab" aria-controls="ui-docs" aria-selected="false">
                    UI API Documentation
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="yaml-docs-tab" type="button" data-docs-tab-button="yaml" role="tab" aria-controls="yaml-docs" aria-selected="false">
                    Sentinel YAML Configuration Documentation
                </button>
            </li>
        </ul>
    </div>
    <div class="docs-layout p-1">
        <div class="row g-0 g-lg-3 flex-grow-1">
            <div class="col-12 col-lg-3 docs-nav-column mb-4 mb-lg-0">
                <div class="card sticky-nav">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Navigation</h5>
                    </div>
                    <div class="card-body">
                        <div class="docs-nav-list active" data-docs-nav="sentinel">
                            <nav class="nav flex-column nav-pills" aria-label="Sentinel API navigation">
                                <a class="nav-link active" href="#sentinel-overview">Overview</a>
                                <a class="nav-link" href="#sentinel-config">Config Management</a>
                                <a class="nav-link" href="#sentinel-session">Session Management</a>
                                <a class="nav-link" href="#sentinel-status">Health & Status</a>
                                <a class="nav-link" href="#sentinel-assets">Media & Stats</a>
                            </nav>
                        </div>
                        <div class="docs-nav-list" data-docs-nav="ui">
                            <nav class="nav flex-column nav-pills" aria-label="UI API navigation">
                                <a class="nav-link active" href="#overview" aria-current="page">Overview</a>
                                <a class="nav-link" href="#authentication">Authentication</a>
                                <a class="nav-link" href="#session-login">Session Login</a>
                                <a class="nav-link" href="#ui-lock">UI Lock</a>
                                <a class="nav-link" href="#dashboard">Dashboard</a>
                                <a class="nav-link" href="#alerts">Alerts</a>
                                <a class="nav-link" href="#config">Configuration</a>
                                <a class="nav-link" href="#analytics">Analytics</a>
                                <a class="nav-link" href="#telegram">Telegram</a>
                                <a class="nav-link" href="#webhooks">Webhooks</a>
                                <a class="nav-link" href="#system">System</a>
                                <a class="nav-link" href="#examples">Examples</a>
                            </nav>
                        </div>
                        <div class="docs-nav-list" data-docs-nav="yaml">
                            <nav class="nav flex-column nav-pills" aria-label="YAML configuration navigation">
                                <a class="nav-link active" href="#yaml-overview">Overview</a>
                                <a class="nav-link" href="#yaml-tgsentinel">tgsentinel.yml</a>
                                <a class="nav-link" href="#yaml-developer">developer.yml</a>
                                <a class="nav-link" href="#yaml-webhooks">webhooks.yml</a>
                                <a class="nav-link" href="#yaml-volumes">Docker Volumes</a>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-lg-9 docs-content">
        <div class="docs-tab-pane active" data-docs-content="sentinel" id="sentinel-docs">
            <section id="sentinel-overview" class="mb-5">
                <h1 class="section-header">Sentinel API Overview</h1>
                <p class="lead">Worker-level HTTP API exposed only inside the Docker network. Use it for health checks, session lifecycle events, and telemetry shared with the UI.</p>
                <div class="alert alert-info">
                    <strong>Base URL:</strong> <code>{{ sentinel_api_base_url | default('http://localhost:8080') }}</code><br>
                    <strong>Service:</strong> <code>sentinel</code> container (Telethon owner).<br>
                    <strong>Security:</strong> Never expose publicly; UI proxies the required flows.
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle">
                        <thead>
                            <tr>
                                <th>Method</th>
                                <th>Endpoint</th>
                                <th>Purpose</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="method-badge method-get">GET</span></td>
                                <td><code>/api/health</code></td>
                                <td>Heartbeat with timestamp for readiness probes.</td>
                            </tr>
                            <tr>
                                <td><span class="method-badge method-get">GET</span></td>
                                <td><code>/api/status</code></td>
                                <td>Authorization flag, connection status, cached user_info, last_sync.</td>
                            </tr>
                            <tr>
                                <td><span class="method-badge method-get">GET</span></td>
                                <td><code>/api/config</code></td>
                                <td>Get current configuration (single source of truth).</td>
                            </tr>
                            <tr>
                                <td><span class="method-badge method-post">POST</span></td>
                                <td><code>/api/config</code></td>
                                <td>Update configuration with deep merge (writes to YAML).</td>
                            </tr>
                            <tr>
                                <td><span class="method-badge method-post">POST</span></td>
                                <td><code>/api/session/import</code></td>
                                <td>Atomic Telethon session upload (JSON base64 or multipart).</td>
                            </tr>
                            <tr>
                                <td><span class="method-badge method-post">POST</span></td>
                                <td><code>/api/session/logout</code></td>
                                <td>Removes <code>*.session*</code> artifacts and publishes logout event.</td>
                            </tr>
                            <tr>
                                <td><span class="method-badge method-get">GET</span></td>
                                <td><code>/api/avatar/&lt;prefix&gt;/&lt;int:entity_id&gt;</code></td>
                                <td>Streams JPEG avatar from Redis cache for users/chats.</td>
                            </tr>
                            <tr>
                                <td><span class="method-badge method-get">GET</span></td>
                                <td><code>/api/alerts</code></td>
                                <td>Placeholder alert feed (extend within sentinel handlers).</td>
                            </tr>
                            <tr>
                                <td><span class="method-badge method-get">GET</span></td>
                                <td><code>/api/stats</code></td>
                                <td>Placeholder metrics (messages_processed, alerts_sent, uptime_seconds).</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="sentinel-config" class="mb-5">
                <h2 class="section-header">Config Management (Single Source of Truth)</h2>
                <p>Sentinel is the authoritative owner of <code>config/tgsentinel.yml</code>. The UI proxies all configuration operations through these endpoints.</p>
                
                <div class="endpoint-card card method-get">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                                <strong class="ms-2 section-url">/api/config</strong>
                            </div>
                        </div>
                        <p class="mb-2 alert-info">Returns the complete configuration including telegram settings, alerts, digest, channels, monitored_users, interests, and system settings.</p>
                        <h6>Response Example:</h6>
                        <pre class="code-block"><code class="language-json">{
  "status": "ok",
  "data": {
    "telegram": {
      "session": "data/tgsentinel.session"
    },
    "alerts": {
      "mode": "both",
      "target_channel": "@alerts"
    },
    "digest": {
      "hourly": true,
      "daily": false,
      "top_n": 10
    },
    "channels": [
      {
        "id": -1001193248583,
        "name": "Algorand Announcements",
        "vip_senders": [],
        "keywords": ["algorand", "upgrade"],
        "reaction_threshold": 3,
        "reply_threshold": 2,
        "rate_limit_per_hour": 10
      }
    ],
    "monitored_users": [
      {
        "id": 789012,
        "name": "Test User",
        "username": "testuser",
        "enabled": true
      }
    ],
    "interests": ["security", "vulnerability"],
    "redis": "redis://redis:6379/0",
    "database_uri": "sqlite:////app/data/sentinel.db",
    "embeddings_model": "all-MiniLM-L6-v2",
    "similarity_threshold": 0.42
  },
  "error": null
}</code></pre>
                    </div>
                </div>

                <div class="endpoint-card card method-post">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                                <strong class="ms-2 section-url">/api/config</strong>
                            </div>
                        </div>
                        <p class="mb-2 alert-info">Updates configuration via deep merge. Writes to <code>config/tgsentinel.yml</code> and reloads global config. UI uses this for all config mutations (channels, users, settings).</p>
                        <h6>Request Body Example (updating monitored users):</h6>
                        <pre class="code-block"><code class="language-json">{
  "monitored_users": [
    {
      "id": 123456,
      "name": "Alice",
      "username": "alice",
      "enabled": true
    }
  ]
}</code></pre>
                        <h6>Response:</h6>
                        <pre class="code-block"><code class="language-json">{
  "status": "ok",
  "message": "Configuration updated",
  "error": null
}</code></pre>
                        <h6>Usage Pattern:</h6>
                        <pre class="code-block"><code class="language-bash"># Fetch current config
curl {{ sentinel_api_base_url | default('http://localhost:8080') }}/api/config

# Update specific section (deep merge)
curl -X POST {{ sentinel_api_base_url | default('http://localhost:8080') }}/api/config \
  -H "Content-Type: application/json" \
  -d '{"channels": [{"id": -100123, "name": "New Channel"}]}'</code></pre>
                    </div>
                </div>
            </section>

            <section id="sentinel-session" class="mb-5">
                <h2 class="section-header">Session Management</h2>
                <p>Upload and reset Telethon sessions exclusively through these worker endpoints.</p>
                <div class="endpoint-card card method-post">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                                <strong class="ms-2 section-url">/api/session/import</strong>
                            </div>
                        </div>
                        <p class="mb-2 alert-info">Accepts <code>{"session_data":"base64"}</code> JSON or multipart <code>session_file</code>. Validates Telethon schema, removes stale WAL files, writes to <code>{{ _config.telegram_session if _config else 'data/tgsentinel.session' }}</code>, then publishes <code>tgsentinel:session_updated</code>.</p>
                        <h6>cURL example:</h6>
                        <pre class="code-block"><code class="language-bash">curl -X POST {{ sentinel_api_base_url | default('http://localhost:8080') }}/api/session/import \
  -F "session_file=@tgsentinel.session"</code></pre>
                    </div>
                </div>
                <div class="endpoint-card card method-post">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                                <strong class="ms-2 section-url">/api/session/logout</strong>
                            </div>
                        </div>
                        <p class="mb-2 alert-info">Removes every <code>/app/data/*.session*</code> file and announces a logout event for the session monitor.</p>
                        <pre class="code-block"><code class="language-json">{
  "status": "ok",
  "message": "Logout successful",
  "files_removed": [
    "/app/data/tgsentinel.session",
    "/app/data/tgsentinel.session-wal"
  ]
}</code></pre>
                    </div>
                </div>
            </section>

            <section id="sentinel-status" class="mb-5">
                <h2 class="section-header">Health & Status</h2>
                <p>Feed UI worker badges and external monitors.</p>
                <div class="endpoint-card card method-get">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                                <strong class="ms-2 section-url">/api/health</strong>
                            </div>
                        </div>
                        <p class="mb-2 alert-info">Returns <code>{"status":"ok","service":"tgsentinel","timestamp":"..."}</code>. Safe for Kubernetes-style probes.</p>
                    </div>
                </div>
                <div class="endpoint-card card method-get">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                                <strong class="ms-2 section-url">/api/status</strong>
                            </div>
                        </div>
                        <p class="mb-2 alert-info">Primary status document consumed by the UI.</p>
                        <pre class="code-block"><code class="language-json">{
  "status": "ok",
  "data": {
    "authorized": true,
    "connected": true,
    "user_info": {"username": "Analyst"},
    "last_sync": "2025-11-18T12:47:39Z"
  },
  "error": null
}</code></pre>
                    </div>
                </div>
            </section>

            <section id="sentinel-assets" class="mb-5">
                <h2 class="section-header">Media & Metrics</h2>
                <p>Supporting endpoints for avatars and placeholder telemetry. Extend within <code>src/tgsentinel/api.py</code> as needed.</p>
                <div class="endpoint-card card method-get">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                                <strong class="ms-2 section-url">/api/avatar/&lt;prefix&gt;/&lt;entity_id&gt;</strong>
                            </div>
                        </div>
                        <p class="mb-2 alert-info">Use <code>prefix=user|chat</code>. Returns JPEG bytes cached in Redis (<code>tgsentinel:user_avatar:&lt;id&gt;</code>).</p>
                    </div>
                </div>
                <div class="endpoint-card card method-get">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                                <strong class="ms-2 section-url">/api/alerts</strong>
                            </div>
                        </div>
                        <p class="mb-2 alert-info">Stub endpoint that currently returns an empty list. Customize to broadcast worker alerts.</p>
                    </div>
                </div>
                <div class="endpoint-card card method-get">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                                <strong class="ms-2 section-url">/api/stats</strong>
                            </div>
                        </div>
                        <p class="mb-2 alert-info">Returns worker counters (messages_processed, alerts_sent, uptime_seconds). Extend for Prometheus exporters.</p>
                    </div>
                </div>
            </section>
        </div>

        <div class="docs-tab-pane" data-docs-content="ui" id="ui-docs">
        <!-- Overview -->
        <section id="overview" class="mb-5">
            <h1 class="section-header">TG Sentinel API Documentation</h1>
            <p class="lead">Complete REST API reference for TG Sentinel monitoring and alerting system.</p>
            
            <div class="alert alert-info">
                <strong>Base URL:</strong> <code>{{ api_base_url }}</code><br>
                <strong>API Version:</strong> v1<br>
                <strong>Response Format:</strong> JSON
            </div>

            <h3>Quick Start</h3>
            <p>All API endpoints return JSON responses. Most endpoints require the application to be initialized.</p>
            <pre class="code-block"><code class="language-bash">
curl -X GET {{ api_base_url }}/api/system/health \
  -H "Content-Type: application/json"
            </code></pre>
        </section>

        <!-- Authentication -->
        <section id="authentication" class="mb-5">
            <h2 class="section-header">Authentication</h2>
            <p>Currently, API authentication is handled via session cookies. API key authentication is planned for future releases.</p>
            
            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/session/info</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Get current session information including username, connection status, and connected chats.</p>
                    
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "username": "Analyst",
  "avatar": "/static/images/logo.png",
  "session_path": "data/tgsentinel.session",
  "phone_masked": "+1***1234",
  "connected": true,
  "connected_chats": ["Channel Alpha", "Channel Beta"]
}
                    </code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/alerts/feedback</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Record thumbs up/down feedback for an alert (improves heuristics).</p>
                    <h6>Request Body:</h6>
                    <pre class="code-block"><code class="language-json">{
  "chat_id": -1001234567890,
  "msg_id": 12345,
  "label": "up" // or "down"
}</code></pre>
                    <h6 class="alert alert-info">Response:</h6>
                    <pre class="code-block"><code class="language-json">{"status": "ok"}</code></pre>
                </div>
            </div>
        </section>

        <!-- Session Login -->
        <section id="session-login" class="mb-5">
            <h2 class="section-header">Session Login</h2>
            <p>Endpoints to start and verify interactive MTProto login from the UI. These endpoints are designed for user-initiated flows, not long‑lived programmatic tokens.</p>

            <div class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/session/login/start</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Send a login confirmation code to the specified phone number. Normalizes phone and stores a short‑lived login context.</p>
                    <h6>Request Body:</h6>
                    <pre class="code-block"><code class="language-json">{
  "phone": "+41 2600 0000"
}</code></pre>
                    <h6 class="alert alert-info">Response:</h6>
                    <pre class="code-block"><code class="language-json">{
  "status": "ok",
  "message": "Code sent"
}</code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/session/login/verify</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Verify the received code and finalize login. Supports 2FA password when required.</p>
                    <h6>Request Body:</h6>
                    <pre class="code-block"><code class="language-json">{
  "phone": "+41 2600 0000",
  "code": "12345",
  "password": "optional-2fa-password"
}</code></pre>
                    <h6 class="alert alert-info">Responses:</h6>
                    <pre class="code-block"><code class="language-json">// 200 OK
{
  "status": "ok",
  "message": "Authenticated",
  "redirect": "/alerts"
}

// 410 Gone (context expired or missing)
{
  "status": "error",
  "message": "Login session expired or missing. Please click 'Send Code' again."
}</code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/session/relogin</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Clears the current session and returns a hint to start the re‑authentication flow.</p>
                    <pre class="code-block"><code class="language-json">{
  "status": "ok",
  "message": "Session cleared. Start re-authentication.",
  "relogin_required": true,
  "redirect": "/alerts"
}</code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/session/logout</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Invalidates the local Telethon session and clears cached user data.</p>
                    <pre class="code-block"><code class="language-json">{
  "status": "ok",
  "message": "Session cleared. You may re-login.",
  "details": {"file_removed": true},
  "redirect": "/alerts"
}</code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/config/channels/add</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Add one or more channels to the config (id + name). Skips duplicates.</p>
                    <h6>Request Body:</h6>
                    <pre class="code-block"><code class="language-json">{
  "channels": [
    {"id": -1001111111111, "name": "Broadcast Channel"},
    {"id": -1002222222222, "name": "Supergroup"}
  ]
}</code></pre>
                    <h6 class="alert alert-info">Response:</h6>
                    <pre class="code-block"><code class="language-json">{"status": "ok", "added": 2}</code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-delete">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-delete" aria-label="HTTP DELETE method">DELETE</span>
                            <strong class="ms-2 section-url">/api/config/channels/&lt;chat_id&gt;</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Delete a channel by ID.</p>
                    <pre class="code-block"><code class="language-bash">curl -X DELETE {{ api_base_url }}/api/config/channels/-1001111111111</code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/config/users/add</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Add monitored users to the config.</p>
                    <h6>Request Body:</h6>
                    <pre class="code-block"><code class="language-json">{
  "users": [
    {"id": 555555, "name": "User 1", "username": "u1"},
    {"id": 666666, "name": "User 2", "username": "u2"}
  ]
}</code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-delete">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-delete" aria-label="HTTP DELETE method">DELETE</span>
                            <strong class="ms-2 section-url">/api/config/users/&lt;user_id&gt;</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Delete a monitored user by ID.</p>
                    <pre class="code-block"><code class="language-bash">curl -X DELETE {{ api_base_url }}/api/config/users/555555</code></pre>
                </div>
            </div>
        </section>

        <!-- UI Lock -->
        <section id="ui-lock" class="mb-5">
            <h2 class="section-header">UI Lock</h2>
            <p>Lock the UI without logging out of Telegram. Unlock with a password (optional).</p>

            <div class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/ui/lock</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Lock or unlock the UI. Requires JSON body.</p>
                    <h6>Lock Request Body:</h6>
                    <pre class="code-block"><code class="language-json">{"action": "lock"}</code></pre>
                    <h6>Unlock Request Body:</h6>
                    <pre class="code-block"><code class="language-json">{"action": "unlock", "password": "your-password"}</code></pre>
                    <h6 class="alert alert-info">Responses:</h6>
                    <pre class="code-block"><code class="language-json">// 200 OK
{"status":"ok","locked":true}

// 403 when password mismatches
{"status":"error","message":"Invalid password"}

// 423 for locked API routes (except /api/ui/lock and /api/session/*)
{"status":"locked","message":"UI locked"}
                    </code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/ui/lock/status</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Get current lock status and configuration hints.</p>
                    <pre class="code-block"><code class="language-json">{
  "locked": false,
  "timeout": 900,
  "enabled": true
}</code></pre>
                </div>
            </div>
        </section>

        <!-- Dashboard -->
        <section id="dashboard" class="mb-5">
            <h2 class="section-header">Dashboard</h2>

            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/dashboard/summary</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Get dashboard summary statistics for the last 24 hours.</p>
                    
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "messages_ingested": 1250,
  "alerts_sent": 45,
  "avg_importance": 0.67,
  "feedback_accuracy": 87.5
}
                    </code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/dashboard/activity</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Get live activity feed from Redis stream.</p>
                    
                    <h6 class="alert alert-info">Query Parameters:</h6>
                    <table class="table table-sm param-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Type</th>
                                <th>Default</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>limit</code></td>
                                <td>integer</td>
                                <td>20</td>
                                <td>Maximum number of entries (max: 100)</td>
                            </tr>
                        </tbody>
                    </table>

                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "entries": [
    {
      "id": "1699876543210-0",
      "chat_name": "Algorand Dev",
      "sender": "Alice",
      "message": "New smart contract deployed...",
      "importance": 0.85,
      "tags": ["smart-contract", "deployment"],
      "timestamp": "2025-11-12T10:30:00Z"
    }
  ]
}
                    </code></pre>
                </div>
            </div>
        </section>

        <!-- Alerts -->
        <section id="alerts" class="mb-5">
            <h2 class="section-header">Alerts</h2>

            <div id="alerts-api" class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/alerts/recent</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Get recent alerts ordered by creation time (descending).</p>
                    
                    <h6 class="alert alert-info">Query Parameters:</h6>
                    <table class="table table-sm param-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th>Type</th>
                                <th>Default</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>limit</code></td>
                                <td>integer</td>
                                <td>100</td>
                                <td>Maximum number of alerts (max: 250)</td>
                            </tr>
                        </tbody>
                    </table>

                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "alerts": [
    {
      "chat_id": -1001234567890,
      "chat_name": "Crypto Alerts",
      "sender": "Bob",
      "excerpt": "Important security update...",
      "score": 0.92,
      "trigger": "Importance threshold",
      "sent_to": "both",
      "created_at": "2025-11-12T09:15:00"
    }
  ]
}
                    </code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/alerts/digests</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Get digest summaries grouped by date.</p>
                    
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "digests": [
    {
      "date": "2025-11-12",
      "items": 15,
      "avg_score": 0.78
    },
    {
      "date": "2025-11-11",
      "items": 23,
      "avg_score": 0.82
    }
  ]
}
                    </code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/export_alerts</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Export alerts as CSV. When data is present, headers are machine-friendly for CSV parsers.</p>
                    <pre class="code-block"><code class="language-bash">curl -L {{ api_base_url }}/api/export_alerts?limit=500 -o alerts.csv</code></pre>
                </div>
            </div>
        </section>

        <!-- Configuration -->
        <section id="config" class="mb-5">
            <h2 class="section-header">Configuration</h2>
            <p>TG Sentinel configuration includes separate management for <strong>Monitored Channels</strong> (channels/supergroups) and <strong>Monitored Users</strong> (individual private chats). Both sections have independent add/delete operations and can be configured via the <code>/config</code> page.</p>

            <div id="telegram-config" class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/config/current</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Get current configuration including environment variables (Telegram settings, alerts mode, digest settings, etc.).</p>
                    
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "telegram": {
    "api_id": "12345678",
    "api_hash": "abcd1234...",
    "phone_number": "+1234567890",
    "session": "data/tgsentinel.session"
  },
  "alerts": {
    "mode": "both",
    "target_channel": "@my_alerts"
  },
  "digest": {
    "hourly": true,
    "daily": false,
    "top_n": 10
  },
  "redis": {
    "host": "redis",
    "port": 6379
  },
  "semantic": {
    "embeddings_model": "all-MiniLM-L6-v2",
    "similarity_threshold": 0.42
  },
  "database_uri": "sqlite:///data/sentinel.db"
}
                    </code></pre>
                </div>
            </div>

            <div id="scoring-config" class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/config/save</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Save configuration changes to YAML file (includes Telegram settings, alerts mode, digest settings, and scoring/semantic thresholds).</p>
                    
                    <h6>Request Body:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "phone_number": "+1234567890",
  "mode": "both",
  "target_channel": "@alerts",
  "digest": {
    "hourly": true,
    "daily": false,
    "top_n": 10
  }
}
                    </code></pre>

                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "status": "ok"
}
                    </code></pre>
                </div>
            </div>

            <div id="channels-api" class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/config/channels</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Get list of configured Telegram channels (monitored channels section).</p>
                    
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "channels": [
    {
      "id": -1001234567890,
      "chat_id": -1001234567890,
      "name": "Algorand Official",
      "vip_senders": [111111, 222222],
      "keywords": ["governance", "update"],
      "reaction_threshold": 5,
      "reply_threshold": 3,
      "enabled": true
    }
  ]
}
                    </code></pre>
                </div>
            </div>

            <div id="users-api" class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/config/users</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Get list of configured monitored users (monitored users section, separate from channels).</p>
                    
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "users": [
    {
      "id": 555555,
      "name": "John Doe",
      "username": "johndoe",
      "enabled": true
    },
    {
      "id": 666666,
      "name": "Jane Smith",
      "username": "janesmith",
      "enabled": false
    }
  ]
}
                    </code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/sentinel/restart</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Restart the sentinel container to apply configuration changes.</p>
                    
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "status": "ok",
  "message": "Sentinel restarting"
}
                    </code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/config/rules/test</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Run a lightweight rules test for configured channels (diagnostics only).</p>
                    <h6>Request Body (optional):</h6>
                    <pre class="code-block"><code class="language-json">{
  "channel_ids": [-1001234567890],
  "text": "sample text"
}</code></pre>
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">{
  "status": "ok",
  "tested": 1,
  "results": [
    {
      "channel_id": -1001234567890,
      "channel_name": "Example",
      "matched_rules": ["keyword"],
      "diagnostics": {
        "keywords": ["keyword"],
        "vip_senders": [],
        "reaction_threshold": 5,
        "reply_threshold": 3
      }
    }
  ]
}</code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/config/stats/reset</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Reset transient per‑channel counters (best‑effort).</p>
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">{
  "status": "ok",
  "cleared_keys": 3
}</code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/config/export</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Download the current YAML configuration.</p>
                    <h6 class="alert alert-info">Response:</h6>
                    <pre class="code-block"><code class="language-bash">curl -OJ {{ api_base_url }}/api/config/export</code></pre>
                </div>
            </div>
        </section>

        <!-- Analytics -->
        <section id="analytics" class="mb-5">
            <h2 class="section-header">Analytics</h2>

            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/analytics/metrics</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Get real-time system and processing metrics.</p>
                    
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "messages_per_min": 12.5,
  "semantic_latency": 45,
  "cpu": 23.4,
  "memory": 512.3,
  "redis_stream_depth": 156
}
                    </code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/analytics/keywords</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Get top keywords and their frequency.</p>
                    
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "keywords": [
    {"keyword": "governance", "count": 45},
    {"keyword": "security", "count": 32},
    {"keyword": "update", "count": 28}
  ]
}
                    </code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/analytics/anomalies</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Detect anomalies in message volume and patterns.</p>
                    
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "anomalies": [
    {
      "type": "volume_spike",
      "severity": "high",
      "description": "Message volume 3x above baseline",
      "timestamp": "2025-11-12T10:00:00Z",
      "affected_channels": ["Crypto News"]
    }
  ]
}
                    </code></pre>
                </div>
            </div>
        </section>

        <!-- Console -->
        <section id="console" class="mb-5">
            <h2 class="section-header">Console</h2>
            <p>Administrative console actions and diagnostics export.</p>

            <div class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/console/command</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Accepts simple commands (e.g., "reauth"). Returns accepted status.</p>
                    <pre class="code-block"><code class="language-json">{
  "command": "reauth"
}</code></pre>
                    
                    <h6 class="alert alert-info">Response:</h6>
                    <pre class="code-block"><code class="language-json">{
  "status": "accepted",
  "message": "Command queued"
}</code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/console/diagnostics</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Exports anonymized diagnostics bundle (JSON attachment).</p>
                    <pre class="code-block"><code class="language-bash">curl -L {{ api_base_url }}/api/console/diagnostics -o diagnostics.json</code></pre>
                </div>
            </div>
        </section>

        <!-- Developer -->
        <section id="developer" class="mb-5">
            <h2 class="section-header">Developer</h2>
            <p>Integration settings for Prometheus metrics and local API docs.</p>
            <div class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/developer/settings</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Persist developer settings like Prometheus port and an ephemeral API key.</p>
                    <h6>Request Body:</h6>
                    <pre class="code-block"><code class="language-json">{
  "prometheus_port": 9100,
  "api_key": "(optional)"
}</code></pre>
                    <h6 class="alert alert-info">Response:</h6>
                    <pre class="code-block"><code class="language-json">{"status": "ok"}</code></pre>
                </div>
            </div>
        </section>

        <!-- Telegram -->
        <section id="telegram" class="mb-5">
            <h2 class="section-header">Telegram</h2>
            <p>Direct MTProto access endpoints used by the UI for channel/user discovery.</p>

            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/telegram/chats</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">List accessible chats (channels/supergroups). Requires env TG_API_ID/TG_API_HASH and a valid session file.</p>
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">{
  "chats": [
    {"id": -100123, "name": "Channel A", "type": "channel", "username": null},
    {"id": -100456, "name": "Supergroup B", "type": "supergroup", "username": "groupb"}
  ]
}</code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/telegram/users</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Fetch private chats (users) via a cache+request pattern to the sentinel worker. Returns 200 with cached or fallback data; 503 when Redis is explicitly unavailable.</p>
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">{
  "users": [
    {"id": 111111, "name": "Cached User", "username": "cached", "phone": null}
  ]
}</code></pre>
                </div>
            </div>
        </section>

        <!-- Webhooks -->
        <section id="webhooks" class="mb-5">
            <h2 class="section-header">Webhooks</h2>

            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/webhooks</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">List all configured webhooks (secrets are masked).</p>
                    
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "webhooks": [
    {
      "service": "Pushover",
      "url": "https://api.pushover.net/1/messages.json",
      "secret": "••••••",
      "enabled": true
    }
  ]
}
                    </code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-post">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-post" aria-label="HTTP POST method">POST</span>
                            <strong class="ms-2 section-url">/api/webhooks</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Create a new webhook configuration.</p>
                    
                    <h6>Request Body:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "service": "Discord",
  "url": "https://discord.com/api/webhooks/123/abc",
  "secret": "optional-token"
}
                    </code></pre>

                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "status": "ok",
  "service": "Discord"
}
                    </code></pre>

                    <h6>Error Responses:</h6>
                    <ul>
                        <li><code>400</code> - Missing required fields</li>
                        <li><code>409</code> - Duplicate service name</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint-card card method-delete">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-delete" aria-label="HTTP DELETE method">DELETE</span>
                            <strong class="ms-2 section-url">/api/webhooks/:service_name</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Delete a webhook by service name.</p>
                    
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "status": "ok",
  "deleted": "Discord"
}
                    </code></pre>
                </div>
            </div>
        </section>

        <!-- System -->
        <section id="system" class="mb-5">
            <h2 class="section-header">System</h2>

            <div id="system-config" class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/system/health</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Get system health metrics and connection status (Redis, database, CPU, memory).</p>
                    
                    <h6 class="alert alert-info">Response Example:</h6>
                    <pre class="code-block"><code class="language-json">
{
  "redis_stream_depth": 156,
  "database_size_mb": 12.5,
  "redis_online": true,
  "cpu_percent": 23.4,
  "memory_mb": 512.3,
  "last_checkpoint": "2025-11-12T10:30:00Z"
}
                    </code></pre>
                </div>
            </div>

            <div class="endpoint-card card method-get">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="method-badge method-get" aria-label="HTTP GET method">GET</span>
                            <strong class="ms-2 section-url">/api/participant/info</strong>
                        </div>
                    </div>
                    <p class="mb-2 alert-info">Return chat/user/participant details. Supports pending mode (202) with minimal info and re‑polling.</p>
                    <pre class="code-block"><code class="language-bash">curl "{{ api_base_url }}/api/participant/info?chat_id=-100123&user_id=42&pending=1"</code></pre>
                    
                    <p class="mt-3 mb-2"><strong>Example 200 response (success):</strong></p>
                    <pre class="code-block"><code class="language-json">{
  "chat_id": -100123,
  "chat_title": "Tech Discussion Group",
  "chat_type": "channel",
  "chat_username": "techdiscussion",
  "user_id": 42,
  "user_first_name": "John",
  "user_last_name": "Doe",
  "user_username": "johndoe",
  "user_phone": "+1234567890",
  "user_is_bot": false,
  "participant_status": "member",
  "participant_role": "user",
  "participant_joined_at": "2025-01-15T08:30:00Z",
  "participant_is_admin": false,
  "participant_is_creator": false,
  "participant_can_post": true,
  "created_at": "2025-11-14T10:00:00Z",
  "metadata": {
    "last_seen": "2025-11-14T09:55:00Z",
    "message_count": 127
  }
}</code></pre>
                    
                    <p class="mt-3 mb-2"><strong>Example 202 pending response (data not yet available):</strong></p>
                    <pre class="code-block"><code class="language-json">{
  "chat_id": -100123,
  "user_id": 42,
  "status": "pending",
  "message": "Participant information is being fetched. Please retry after a few seconds.",
  "retry_after": 5
}</code></pre>

                    <h6 class="alert alert-info mt-3">Error Responses:</h6>
                    <pre class="code-block"><code class="language-json">// 400 Bad Request (missing or invalid parameters)
{
  "status": "error",
  "message": "Missing required parameters",
  "details": "Both chat_id and user_id are required"
}

// 401 Unauthorized (authentication required)
{
  "status": "error",
  "message": "Authentication required",
  "details": "Please log in to access this endpoint"
}

// 404 Not Found (participant or chat not found)
{
  "status": "error",
  "message": "Participant not found",
  "details": "No participant record exists for the specified chat_id and user_id"
}

// 422 Unprocessable Entity (validation error)
{
  "status": "error",
  "message": "Invalid parameter value",
  "details": "chat_id must be a valid integer"
}

// 500 Internal Server Error
{
  "status": "error",
  "message": "Internal server error",
  "details": "An unexpected error occurred. Please try again later or contact support."
}</code></pre>
                </div>
            </div>
        </section>

        <!-- Examples -->
        <section id="examples" class="mb-5">
            <h2 class="section-header">Code Examples</h2>

            <h3>Python</h3>
            <pre class="code-block"><code class="language-python">
import requests

# Get system health
response = requests.get('{{ api_base_url }}/api/system/health')
health = response.json()
print(f"Redis online: {health['redis_online']}")

# Create a webhook
webhook_data = {
    "service": "Slack",
    "url": "https://hooks.slack.com/services/T00/B00/XXX",
    "secret": "xoxb-token"
}
response = requests.post(
    '{{ api_base_url }}/api/webhooks',
    json=webhook_data
)
print(response.json())
            </code></pre>

            <h3>JavaScript/Node.js</h3>
            <pre class="code-block"><code class="language-javascript">
// Get recent alerts
fetch('{{ api_base_url }}/api/alerts/recent?limit=10')
  .then(response => response.json())
  .then(data => {
    console.log(`Found ${data.alerts.length} alerts`);
    data.alerts.forEach(alert => {
      console.log(`${alert.chat_name}: ${alert.excerpt}`);
    });
  });

// Save configuration
const config = {
  mode: "both",
  target_channel: "@my_alerts"
};

fetch('{{ api_base_url }}/api/config/save', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(config)
})
  .then(response => response.json())
  .then(data => console.log('Config saved:', data));
            </code></pre>

            <h3>cURL</h3>
            <pre class="code-block"><code class="language-bash">
# Get dashboard summary
curl -X GET {{ api_base_url }}/api/dashboard/summary

# Create webhook
curl -X POST {{ api_base_url }}/api/webhooks \
  -H "Content-Type: application/json" \
  -d '{
    "service": "Discord",
    "url": "https://discord.com/api/webhooks/123/abc"
  }'

# Delete webhook
curl -X DELETE {{ api_base_url }}/api/webhooks/Discord

# Get analytics metrics
curl -X GET {{ api_base_url }}/api/analytics/metrics
            </code></pre>
        </section>

        <div class="alert alert-secondary">
            <strong>Need Help?</strong> For issues or questions, check the <a href="https://github.com/redoracle/TGSentinel" target="_blank" rel="noopener noreferrer">GitHub repository</a> or open an issue.
        </div>
        </div>

        <div class="docs-tab-pane" data-docs-content="yaml" id="yaml-docs">
            <section id="yaml-overview" class="mb-5">
                <h1 class="section-header">YAML Configuration Overview</h1>
                <p class="lead">TG Sentinel uses a <strong>single source of truth</strong> architecture: Sentinel owns <code>config/tgsentinel.yml</code> and all Telegram-related configuration. The UI proxies all config operations through Sentinel's <code>/api/config</code> endpoints.</p>
                <div class="alert alert-info">
                    <strong>Config Owner:</strong> Sentinel container (single source of truth)<br>
                    <strong>Config Volume:</strong> <code>tgsentinel_sentinel_config:/app/config</code><br>
                    <strong>UI Access:</strong> Via HTTP API only (<code>GET/POST /api/config</code>)<br>
                    <strong>Architecture:</strong> Dual-database (Sentinel owns session + config, UI owns ui.db)<br>
                    <strong>Backup tip:</strong> Use <code>docker compose cp</code> or admin export endpoints.
                </div>
                <div class="alert alert-warning">
                    <strong>Important:</strong> The UI container does NOT mount <code>tgsentinel_sentinel_config</code>. All configuration changes flow through Sentinel API to maintain consistency.
                </div>
            </section>

            <section id="yaml-tgsentinel" class="mb-5">
                <h2 class="section-header">config/tgsentinel.yml (Sentinel - Single Source of Truth)</h2>
                <p>Authoritative source for all Telegram credentials, monitoring rules, alert modes, and per-channel heuristics. Managed by Sentinel, accessed by UI through <code>GET/POST /api/config</code> endpoints. Updated via <code>tgsentinel.config.load_config()</code>.</p>
                <div class="row g-3">
                    <div class="col-12 col-xl-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h3 class="card-title mb-0">Key Sections</h3>
                            </div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    <li><code>telegram.api_id</code>, <code>telegram.api_hash</code>, <code>telegram.session</code></li>
                                    <li><code>alerts.mode</code>, <code>alerts.target_channel</code>, digest cadence</li>
                                    <li><code>channels[]</code> list with heuristics (<code>vip_senders</code>, keywords, thresholds, rate limits)</li>
                                    <li><code>monitored_users[]</code> list for individual user monitoring (id, name, username, enabled)</li>
                                    <li><code>interests[]</code> for semantic scoring and relevance matching</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-xl-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h3 class="card-title mb-0">Sample Snippet</h3>
                            </div>
                            <div class="card-body">
                                <pre class="code-block"><code class="language-yaml">telegram:
  api_id: 12345
  api_hash: "abcd..."
  session: "data/tgsentinel.session"
alerts:
  mode: both
  target_channel: "@alerts"
channels:
  - id: -100123
    name: "Threat Intel"
    vip_senders: ["@securityguru"]
    keywords: ["vulnerability", "exploit"]
    reaction_threshold: 5
    reply_threshold: 3
    rate_limit_per_hour: 12
monitored_users:
  - id: 789012
    name: "Security Expert"
    username: "secexp"
    enabled: true
interests:
  - "zero-day"
  - "exploit"
  - "CVE"</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="yaml-developer" class="mb-5">
                <h2 class="section-header">config/developer.yml (Optional/Legacy)</h2>
                <p>Optional UI-only developer settings managed through <code>/api/developer/settings</code>: API keys, Prometheus exporter port, feature flags, and webhook secrets hashing strategies.</p>
                <div class="alert alert-warning">
                    <strong>Note:</strong> With the single source of truth architecture, most settings now reside in <code>tgsentinel.yml</code> on Sentinel. This file is primarily for UI-specific developer features.
                </div>
                <div class="endpoint-card card">
                    <div class="card-body">
                        <pre class="code-block"><code class="language-yaml">api_keys:
  hash: "c9f0f895fb98ab9159f51fd0297e236d"
prometheus:
  enabled: true
  port: 9100
features:
  enable_console_stream: true
  enable_live_diagnostics: false</code></pre>
                        <p class="mb-0">If present, stored on UI's local filesystem. Not mounted as volume in current architecture.</p>
                    </div>
                </div>
            </section>

            <section id="yaml-webhooks" class="mb-5">
                <h2 class="section-header">config/webhooks.yml (Optional)</h2>
                <p>Optional CRUD via <code>/api/webhooks</code>. Each entry captures outbound integration metadata. Secrets are masked on reads but stored encrypted/plain depending on the service.</p>
                <div class="alert alert-warning">
                    <strong>Note:</strong> Webhook configuration is optional. Most alerting flows through Sentinel's native Telegram integration configured in <code>tgsentinel.yml</code>.
                </div>
                <div class="endpoint-card card">
                    <div class="card-body">
                        <pre class="code-block"><code class="language-yaml">webhooks:
  slack:
    url: "https://hooks.slack.com/services/T00/B00/XXX"
    secret: "***"
    enabled: true
  discord:
    url: "https://discord.com/api/webhooks/..."
    secret: "***"
    enabled: false</code></pre>
                        <p class="mb-0">If used, managed independently from main Sentinel configuration.</p>
                    </div>
                </div>
            </section>

            <section id="yaml-volumes" class="mb-5">
                <h2 class="section-header">Docker Volume Mapping</h2>
                <p>Reference from <code>docker-compose.yml</code>. Sentinel owns the configuration volume (single source of truth). UI accesses config via HTTP API only.</p>
                <pre class="code-block"><code class="language-yaml">services:
  sentinel:
    volumes:
      - tgsentinel_sentinel_config:/app/config  # Config owner
      - tgsentinel_sentinel_data:/app/data      # Session + sentinel.db
    environment:
      - TG_CONFIG_PATH=/app/config/tgsentinel.yml
  
  ui:
    volumes:
      - tgsentinel_ui_data:/app/data            # UI-only: ui.db
    environment:
      - SENTINEL_API_BASE_URL=http://sentinel:8080/api

volumes:
  tgsentinel_sentinel_config:  # Sentinel-only config volume
  tgsentinel_sentinel_data:    # Sentinel-only data (session + DB)
  tgsentinel_ui_data:          # UI-only data (ui.db)</code></pre>
                <div class="alert alert-danger">
                    <strong>Critical:</strong> The UI container does <strong>NOT</strong> mount <code>tgsentinel_sentinel_config</code>. All config operations go through <code>GET/POST /api/config</code> endpoints. Never share config volumes between containers.
                </div>
                <h5 class="mt-4">Architecture Benefits</h5>
                <ul>
                    <li><strong>Single Source of Truth:</strong> Sentinel owns config, eliminating sync conflicts</li>
                    <li><strong>Clean Separation:</strong> UI never directly accesses session files or Sentinel DB</li>
                    <li><strong>API-First:</strong> All config changes flow through validated HTTP endpoints</li>
                    <li><strong>Session Security:</strong> Telethon session isolated in Sentinel container</li>
                </ul>
            </section>
        </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script>
    const tabButtons = document.querySelectorAll('[data-docs-tab-button]');
    const contentPanes = document.querySelectorAll('[data-docs-content]');
    const navLists = document.querySelectorAll('[data-docs-nav]');
    const navLinks = document.querySelectorAll('.nav-pills .nav-link[href^="#"]');
    const mainContent = document.querySelector('.docs-content');

    let activeTab = null;
    let currentActiveSection = null;
    let updateTimeout = null;

    const updateActiveLink = (id) => {
        if (currentActiveSection === id || !activeTab) {
            return;
        }
        currentActiveSection = id;
        document.querySelectorAll(`.docs-nav-list[data-docs-nav="${activeTab}"] .nav-link`).forEach(link => {
            link.classList.remove('active');
            link.removeAttribute('aria-current');
            if (link.getAttribute('href') === `#${id}`) {
                link.classList.add('active');
                link.setAttribute('aria-current', 'page');
            }
        });
    };

    const observer = new IntersectionObserver((entries) => {
        if (updateTimeout) {
            clearTimeout(updateTimeout);
        }
        updateTimeout = setTimeout(() => {
            let mostVisible = null;
            let maxRatio = 0;
            entries.forEach(entry => {
                if (entry.isIntersecting && entry.intersectionRatio > maxRatio) {
                    maxRatio = entry.intersectionRatio;
                    mostVisible = entry.target;
                }
            });
            if (mostVisible) {
                updateActiveLink(mostVisible.getAttribute('id'));
            }
        }, 100);
    }, {
        threshold: [0, 0.25, 0.5, 0.75, 1],
        rootMargin: '-20% 0px -20% 0px'
    });

    const observeSectionsForActiveTab = () => {
        observer.disconnect();
        if (!activeTab) {
            return;
        }
        const activePane = document.querySelector(`[data-docs-content="${activeTab}"]`);
        if (activePane) {
            activePane.querySelectorAll('section[id]').forEach(section => observer.observe(section));
        }
    };

    const resetNavLinks = () => {
        document.querySelectorAll('.nav-pills .nav-link').forEach(link => {
            link.classList.remove('active');
            link.removeAttribute('aria-current');
        });
    };

    const activateDocsTab = (tabName) => {
        if (activeTab === tabName) {
            return;
        }
        activeTab = tabName;
        tabButtons.forEach(btn => {
            const isActive = btn.dataset.docsTabButton === tabName;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-selected', String(isActive));
        });
        contentPanes.forEach(pane => {
            pane.classList.toggle('active', pane.dataset.docsContent === tabName);
        });
        navLists.forEach(list => {
            list.classList.toggle('active', list.dataset.docsNav === tabName);
        });
        currentActiveSection = null;
        observeSectionsForActiveTab();
        resetNavLinks();
        const firstNavLink = document.querySelector(`.docs-nav-list[data-docs-nav="${tabName}"] .nav-link`);
        if (firstNavLink) {
            firstNavLink.classList.add('active');
            firstNavLink.setAttribute('aria-current', 'page');
        }
        // Scroll to top of page when switching tabs
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.docsTabButton;
            if (tabName) {
                activateDocsTab(tabName);
            }
        });
    });

    // Smooth scrolling limited to the active tab's navigation links
    navLinks.forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            const parentList = this.closest('[data-docs-nav]');
            if (!parentList || parentList.dataset.docsNav !== activeTab) {
                return;
            }
            if (e.detail !== 0) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    // Calculate offset from top of page
                    const targetRect = target.getBoundingClientRect();
                    const navbarHeight = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--navbar-height')) || 76;
                    const scrollOffset = window.pageYOffset + targetRect.top - navbarHeight - 20;
                    window.scrollTo({ top: scrollOffset, behavior: 'smooth' });
                    resetNavLinks();
                    this.classList.add('active');
                    this.setAttribute('aria-current', 'page');
                }
            }
        });
    });

    activateDocsTab('sentinel');

    const cleanup = () => {
        if (updateTimeout) {
            clearTimeout(updateTimeout);
        }
        observer.disconnect();
    };

    window.addEventListener('beforeunload', cleanup);
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            cleanup();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('pre code').forEach(block => {
            hljs.highlightElement(block);
        });
    });
</script>
<!-- Highlight.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" integrity="sha512-D9gUyxqja7hBtkWpPWGt9wfbfaMGVt9gnyCvYa+jojwwPHLCzUm5i8rpk7vD7wNee9bA35eYIjobYPaQuKS1MQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% endblock %}
