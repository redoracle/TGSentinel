{% extends "base.html" %}
{% block title %}Profiles ¬∑ TG Sentinel{% endblock %}

{% block content %}
<!-- Two-Tab Navigation -->
<section class="card mb-4">
    <div class="card-header">
        <h1 class="card-title mb-0">Profile Management</h1>
        <small class="text-muted">Configure keyword-based and semantic interest profiles</small>
    </div>
    <div class="card-body p-0">
        <ul class="nav nav-tabs nav-fill border-bottom-0" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="alert-profiles-tab" data-bs-toggle="tab" data-bs-target="#alert-profiles" type="button" role="tab" aria-controls="alert-profiles" aria-selected="true">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-bell me-2" viewBox="0 0 16 16">
                        <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                    </svg>
                    Alert Profiles
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="interest-profiles-tab" data-bs-toggle="tab" data-bs-target="#interest-profiles" type="button" role="tab" aria-controls="interest-profiles" aria-selected="false">
                    <svg width="16" height="16" fill="currentColor" class="bi bi-brain me-2" viewBox="0 0 16 16">
                        <path d="M5.5 2a.5.5 0 0 0-1 0v11a.5.5 0 0 0 1 0v-11zm5 0a.5.5 0 0 0-1 0v11a.5.5 0 0 0 1 0v-11zm-4 1.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5zm3 0a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5z"/>
                    </svg>
                    Interest Profiles
                </button>
            </li>
        </ul>
    </div>
</section>

<div class="tab-content" id="profileTabsContent">
    <!-- Alert Profiles Tab -->
    <div class="tab-pane fade show active" id="alert-profiles" role="tabpanel" aria-labelledby="alert-profiles-tab">
        <section class="row g-4 mb-4">
            <div class="col-12 col-xl-4">
                <article class="card alert-profiles-list-card" aria-labelledby="alert-profiles-list-heading">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="card-title mb-0" id="alert-profiles-list-heading">Alert Profiles</h2>
                            <small class="text-muted"><span id="alert-profiles-count">0</span> profiles</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" type="button" id="btn-alert-bulk-actions" title="Bulk actions">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                                </svg>
                            </button>
                            <button class="btn btn-sm btn-primary" type="button" id="btn-new-alert-profile">
                                <svg width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                                </svg>
                                New
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Search/Filter Bar -->
                        <div class="p-3 border-bottom">
                            <input type="text" class="form-control form-control-sm" id="alert-profiles-search" placeholder="üîç Search profiles...">
                        </div>
                        <!-- Profiles List with virtualized scrolling -->
                        <div class="alert-profiles-list-container" id="alert-profiles-list-container">
                            <div class="list-group list-group-flush" id="alert-profiles-list">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                    </div>
                </article>
            </div>
            <div class="col-12 col-xl-8">
                <article class="card h-100" aria-labelledby="alert-profile-editor-heading">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title mb-0" id="alert-profile-editor-heading">Alert Profile Editor</h2>
                            <small class="text-muted">Configure keyword detection rules</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="alert-profile-form" class="d-grid gap-3" novalidate>
                            <input type="hidden" id="alert-profile-id" value="">
                            
                            <div class="alert alert-info" role="alert">
                                <strong>Select a profile</strong> from the list or create a new one to configure keyword-based detection.
                            </div>
                            
                            <!-- Basic Info -->
                            <div class="row">
                                <div class="col-md-4 d-none">
                                    <label class="form-label" for="alert-profile-id-display">Profile ID</label>
                                    <input class="form-control" id="alert-profile-id-display" type="text" placeholder="Auto-generated" readonly style="background-color: #e9ecef;">
                                    <small class="form-text text-muted">Auto-assigned integer ID (1000-1999)</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label" for="alert-name">Profile Name <span class="text-danger">*</span></label>
                                    <input class="form-control" id="alert-name" name="name" type="text" placeholder="e.g., Security Alerts" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label" for="alert-enabled">Status</label>
                                    <select class="form-select" id="alert-enabled" name="enabled">
                                        <option value="true" selected>Enabled</option>
                                        <option value="false">Disabled</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="form-label" for="alert-description">Description</label>
                                <input class="form-control" id="alert-description" name="description" type="text" placeholder="Brief description">
                            </div>
                            
                            <!-- Keywords Section -->
                            <div class="border-top pt-3">
                                <h3 class="h6 mb-3">Keyword Detection</h3>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-critical-keywords">Critical Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-critical-keywords" name="critical_keywords" rows="3" placeholder="exploit, breach, hack"></textarea>
                                        <small class="text-muted">Comma-separated. Highest priority.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-security-keywords">Security Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-security-keywords" name="security_keywords" rows="3" placeholder="vulnerability, attack, malicious"></textarea>
                                        <small class="text-muted">Security-related terms.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-urgency-keywords">Urgency Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-urgency-keywords" name="urgency_keywords" rows="3" placeholder="urgent, asap, critical"></textarea>
                                        <small class="text-muted">Time-sensitive indicators.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-financial-keywords">Financial Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-financial-keywords" name="financial_keywords" rows="3" placeholder="price, market, trading"></textarea>
                                        <small class="text-muted">Market and financial terms.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-technical-keywords">Technical Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-technical-keywords" name="technical_keywords" rows="3" placeholder="update, upgrade, release"></textarea>
                                        <small class="text-muted">Development and tech terms.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-project-keywords">Project Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-project-keywords" name="project_keywords" rows="3" placeholder="marketing, alert, governance"></textarea>
                                        <small class="text-muted">Project-specific terms.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-community-keywords">Community Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-community-keywords" name="community_keywords" rows="3" placeholder="announcement, airdrop, vote"></textarea>
                                        <small class="text-muted">Community engagement terms.</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="alert-general-keywords">General Keywords</label>
                                        <textarea class="form-control font-monospace" id="alert-general-keywords" name="general_keywords" rows="3" placeholder="news, update, important"></textarea>
                                        <small class="text-muted">General interest terms.</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detection Settings -->
                            <div class="border-top pt-3">
                                <h3 class="h6 mb-3">Detection Settings</h3>
                                
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label" for="alert-min-score">Minimum Score</label>
                                        <input class="form-control" id="alert-min-score" name="min_score" type="number" min="0" max="10" step="0.1" value="1.0">
                                        <small class="text-muted">Threshold for alerts (0-10)</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="alert-vip-senders">VIP Senders</label>
                                        <input class="form-control font-monospace" id="alert-vip-senders" name="vip_senders" type="text" placeholder="@username1, @username2">
                                        <small class="text-muted">Always alert from these</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="alert-excluded-users">Excluded Users</label>
                                        <input class="form-control font-monospace" id="alert-excluded-users" name="excluded_users" type="text" placeholder="@spammer, @bot">
                                        <small class="text-muted">Never alert from these</small>
                                    </div>
                                </div>
                                
                                <div class="row g-3 mt-2">
                                    <div class="col-md-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="alert-detect-questions" name="detect_questions">
                                            <label class="form-check-label" for="alert-detect-questions">Detect Questions</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="alert-detect-mentions" name="detect_mentions">
                                            <label class="form-check-label" for="alert-detect-mentions">Detect Mentions</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="alert-detect-links" name="detect_links">
                                            <label class="form-check-label" for="alert-detect-links">Detect Links</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="alert-require-forwarded" name="require_forwarded">
                                            <label class="form-check-label" for="alert-require-forwarded">Only Forwards</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Scope Restriction (Channels & Users) -->
                            <div class="border-top pt-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h3 class="h6 mb-0">Apply Profile To</h3>
                                    <button type="button" class="btn btn-primary btn-sm" id="btn-select-entities-alert" data-bs-toggle="modal" data-bs-target="#selectEntitiesModal">
                                        <span aria-hidden="true">+</span> ADD
                                    </button>
                                </div>
                                <div id="selected-entities-alert" class="border rounded p-3 bg-dark" style="min-height: 80px;">
                                    <div class="text-muted small" id="entities-placeholder-alert">No channels or users selected. 
</div>
                                    <div id="entities-badges-alert" class="d-flex flex-wrap gap-2"></div>
                                </div>
                                <small class="text-muted">Select specific channels/users or leave empty to apply to all monitored entities configured in the settings section.</small>
                            </div>
                            
                            <!-- Digest Configuration for Alert Profiles -->
                            <div class="border rounded p-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h3 class="h6 mb-0">
                                        <svg width="14" height="14" fill="currentColor" class="bi bi-envelope me-1" viewBox="0 0 16 16">
                                            <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
                                        </svg>
                                        Digest Schedules
                                    </h3>
                                    <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#alert-digest-help">
                                        <svg width="14" height="14" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16">
                                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                            <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                                        </svg>
                                    </button>
                                </div>
                                
                                <div class="collapse mb-3" id="alert-digest-help">
                                    <div class="alert alert-info small mb-0">
                                        <p class="mb-1"><strong>What are digest schedules?</strong></p>
                                        <p class="mb-1">Instead of instant alerts for every message, digest schedules batch messages and send summaries at regular intervals.</p>
                                        <p class="mb-0 mt-2"><em>Configure up to 3 schedules for this channel's alert profile.</em></p>
                                    </div>
                                </div>
                                
                                {# Render 3 schedule cards for Alert Profiles #}
                                {% for schedule_num in range(1, 4) %}
                                <div class="card mb-3">
                                    <div class="card-header py-2">
                                        {% if schedule_num > 1 %}
                                        <button class="btn btn-link p-0 text-decoration-none text-white d-flex align-items-center gap-2 w-100" type="button" data-bs-toggle="collapse" data-bs-target="#alert-schedule-{{ schedule_num }}-body" aria-expanded="false">
                                            <svg width="14" height="14" fill="currentColor" class="bi bi-chevron-right schedule-chevron" viewBox="0 0 16 16">
                                                <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                                            </svg>
                                            <strong>Schedule {{ schedule_num }}</strong> <span class="badge bg-dark">Optional</span>
                                        </button>
                                        {% else %}
                                        <strong>Schedule {{ schedule_num }}</strong>
                                        {% endif %}
                                    </div>
                                    <div class="card-body{% if schedule_num > 1 %} collapse{% endif %}" id="alert-schedule-{{ schedule_num }}-body">
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label" for="alert-digest-schedule-{{ schedule_num }}-type">Schedule Type</label>
                                                <select class="form-select form-select-sm alert-digest-schedule-type" id="alert-digest-schedule-{{ schedule_num }}-type" name="alert_digest_schedule_{{ schedule_num }}_type">
                                                    <option value="">{% if schedule_num == 1 %}None (Instant Alerts){% else %}None{% endif %}</option>
                                                    <option value="hourly">‚è∞ Hourly</option>
                                                    <option value="every_4h">üïì Every 4 Hours</option>
                                                    <option value="every_6h">üïï Every 6 Hours</option>
                                                    <option value="every_12h">üïõ Every 12 Hours</option>
                                                    <option value="daily">üìÖ Daily</option>
                                                    <option value="weekly">üìä Weekly</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label" for="alert-digest-schedule-{{ schedule_num }}-top-n">Top N Messages</label>
                                                <input type="number" class="form-control form-control-sm" id="alert-digest-schedule-{{ schedule_num }}-top-n" name="alert_digest_schedule_{{ schedule_num }}_top_n" min="1" max="100" value="{{ 10 * schedule_num }}" placeholder="{{ 10 * schedule_num }}">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label" for="alert-digest-schedule-{{ schedule_num }}-min-score">Min Score</label>
                                                <input type="number" class="form-control form-control-sm" id="alert-digest-schedule-{{ schedule_num }}-min-score" name="alert_digest_schedule_{{ schedule_num }}_min_score" min="0" max="10" step="0.1" value="{{ 6.0 - schedule_num }}" placeholder="{{ 6.0 - schedule_num }}">
                                            </div>
                                            <div class="col-md-6 alert-digest-daily-settings d-none" id="alert-digest-schedule-{{ schedule_num }}-daily-settings">
                                                <label class="form-label" for="alert-digest-schedule-{{ schedule_num }}-daily-hour">Daily Hour (UTC)</label>
                                                <input type="number" class="form-control form-control-sm" id="alert-digest-schedule-{{ schedule_num }}-daily-hour" name="alert_digest_schedule_{{ schedule_num }}_daily_hour" min="0" max="23" value="8" placeholder="8">
                                            </div>
                                            <div class="col-md-6 alert-digest-weekly-settings d-none" id="alert-digest-schedule-{{ schedule_num }}-weekly-settings">
                                                <label class="form-label" for="alert-digest-schedule-{{ schedule_num }}-weekly-day">Weekly Day</label>
                                                <select class="form-select form-select-sm" id="alert-digest-schedule-{{ schedule_num }}-weekly-day" name="alert_digest_schedule_{{ schedule_num }}_weekly_day">
                                                    <option value="0">Monday</option>
                                                    <option value="1">Tuesday</option>
                                                    <option value="2">Wednesday</option>
                                                    <option value="3">Thursday</option>
                                                    <option value="4">Friday</option>
                                                    <option value="5">Saturday</option>
                                                    <option value="6">Sunday</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 alert-digest-weekly-settings d-none" id="alert-digest-schedule-{{ schedule_num }}-weekly-hour-settings">
                                                <label class="form-label" for="alert-digest-schedule-{{ schedule_num }}-weekly-hour">Weekly Hour (UTC)</label>
                                                <input type="number" class="form-control form-control-sm" id="alert-digest-schedule-{{ schedule_num }}-weekly-hour" name="alert_digest_schedule_{{ schedule_num }}_weekly_hour" min="0" max="23" value="8" placeholder="8">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                
                                <!-- Delivery Settings for Alert Profiles -->
                                <div class="card bg-secondary">
                                    <div class="card-header py-2">
                                        <strong>Delivery Settings</strong>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label" for="alert-digest-mode">Delivery Mode</label>
                                                <select class="form-select form-select-sm" id="alert-digest-mode" name="alert_digest_mode">
                                                    <option value="dm">üí¨ DM Only (Saved Messages)</option>
                                                    <option value="channel">üì¢ Channel Only</option>
                                                    <option value="both">üîÑ Both DM & Channel</option>
                                                </select>
                                                <small class="form-text">Where to send digests</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label" for="alert-digest-target-channel">Target Channel (for channel/both mode)</label>
                                                <input type="text" class="form-control form-control-sm" id="alert-digest-target-channel" name="alert_digest_target_channel" placeholder="@my_alerts_channel">
                                                <small class="form-text">Channel username or ID</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex gap-3 border-top pt-3">
                                <button class="btn btn-primary" type="submit" id="btn-save-alert-profile">
                                    <span id="alert-save-btn-text">Save Profile</span>
                                </button>
                                <button class="btn btn-outline-primary" type="button" id="btn-backtest-alert-profile">
                                    <svg width="16" height="16" fill="currentColor" class="bi bi-speedometer me-1" viewBox="0 0 16 16">
                                        <path d="M8 2a.5.5 0 0 1 .5.5V4a.5.5 0 0 1-1 0V2.5A.5.5 0 0 1 8 2zM3.732 3.732a.5.5 0 0 1 .707 0l.915.914a.5.5 0 1 1-.708.708l-.914-.915a.5.5 0 0 1 0-.707zM2 8a.5.5 0 0 1 .5-.5h1.586a.5.5 0 0 1 0 1H2.5A.5.5 0 0 1 2 8zm9.5 0a.5.5 0 0 1 .5-.5h1.5a.5.5 0 0 1 0 1H12a.5.5 0 0 1-.5-.5zm.754-4.246a.389.389 0 0 0-.527-.02L7.547 7.31A.91.91 0 1 0 8.85 8.569l3.434-4.297a.389.389 0 0 0-.029-.518z"/>
                                        <path fill-rule="evenodd" d="M6.664 15.889A8 8 0 1 1 9.336.11a8 8 0 0 1-2.672 15.78zm-4.665-4.283A11.945 11.945 0 0 1 8 10c2.186 0 4.236.585 6.001 1.606a7 7 0 1 0-12.002 0z"/>
                                    </svg>
                                    Backtest
                                </button>
                                <button class="btn btn-outline-secondary" type="button" id="btn-reset-alert-profile">Clear</button>
                                <button class="btn btn-outline-danger d-none" type="button" id="btn-delete-alert-profile">Delete</button>
                            </div>
                        </form>
                    </div>
                </article>
            </div>
        </section>
    </div>
    
    <!-- Interest Profiles Tab -->
    <div class="tab-pane fade" id="interest-profiles" role="tabpanel" aria-labelledby="interest-profiles-tab">
        <section class="row g-4 mb-4">
            <!-- Interest Profiles List (Left Column) -->
            <div class="col-12 col-xl-4">
                <article class="card alert-profiles-list-card" aria-labelledby="interest-profiles-list-heading">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="card-title mb-0" id="interest-profiles-list-heading">Interest Profiles</h2>
                            <small class="text-muted"><span id="interest-profiles-count">0</span> profiles</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" type="button" id="btn-interest-bulk-actions" title="Bulk actions">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                                </svg>
                            </button>
                            <button class="btn btn-sm btn-primary" type="button" id="btn-new-interest-profile">
                                <svg width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                                </svg>
                                New
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Search/Filter Bar -->
                        <div class="p-3 border-bottom">
                            <input type="text" class="form-control form-control-sm" id="interest-profiles-search" placeholder="üîç Search profiles...">
                        </div>
                        <!-- Profiles List with virtualized scrolling -->
                        <div class="interest-profiles-list-container" id="interest-profiles-list-container">
                            <div class="list-group list-group-flush" id="interest-profiles-list">
                                <!-- Populated dynamically -->
                                <div class="text-center text-muted p-4">
                                    <svg width="48" height="48" fill="currentColor" class="bi bi-collection mb-2" viewBox="0 0 16 16">
                                        <path d="M2.5 3.5a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1h-11zm2-2a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1h-7zM0 13a1.5 1.5 0 0 0 1.5 1.5h13A1.5 1.5 0 0 0 16 13V6a1.5 1.5 0 0 0-1.5-1.5h-13A1.5 1.5 0 0 0 0 6v7zm1.5.5A.5.5 0 0 1 1 13V6a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5h-13z"/>
                                    </svg>
                                    <p>Loading profiles...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </article>
            </div>
            <div class="col-12 col-xl-8">
                <article class="card h-100" aria-labelledby="interest-profile-editor-heading">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title mb-0" id="interest-profile-editor-heading">Interest Profile Editor</h2>
                            <small class="text-muted">Configure semantic interest profiles</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="global-profile-form" class="d-grid gap-3" novalidate>
                            <input type="hidden" id="global-profile-id" value="">
                            <input type="hidden" id="global-profile-mode" value="create">
                            
                            <div class="alert alert-info" role="alert" id="global-profile-empty-state">
                                <strong>Select a profile</strong> from the list or create a new one to configure global keyword profiles.
                            </div>
                            
                            <!-- Basic Info -->
                            <div class="row">
                                <div class="col-md-4 d-none">
                                    <label class="form-label" for="global-profile-id-input">Profile ID</label>
                                    <input class="form-control" id="global-profile-id-input" name="id" type="text" placeholder="Auto-generated" readonly style="background-color: #e9ecef;">
                                    <small class="form-text text-muted">Auto-assigned integer ID (2000-2999)</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label" for="global-profile-name">Profile Name <span class="text-danger">*</span></label>
                                    <input class="form-control" id="global-profile-name" name="name" type="text" placeholder="e.g., Security & Vulnerabilities" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label" for="global-description">Description</label>
                                    <input class="form-control" id="global-description" name="description" type="text" placeholder="Brief description">
                                </div>
                            </div>
                            
                            <!-- Keyword Categories -->
                            <div class="border rounded p-3">
                                <h3 class="h6 mb-3">Keyword Categories</h3>
                                
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label" for="global-keywords">
                                            <svg width="14" height="14" fill="currentColor" class="bi bi-search me-1" viewBox="0 0 16 16">
                                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                            </svg>
                                            General Keywords
                                        </label>
                                        <textarea class="form-control" id="global-keywords" name="keywords" rows="3" placeholder="vulnerability&#10;security&#10;exploit"></textarea>
                                        <small class="form-text">One keyword per line</small>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label" for="global-action-keywords">
                                            <svg width="14" height="14" fill="currentColor" class="bi bi-check-circle me-1" viewBox="0 0 16 16">
                                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                                <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
                                            </svg>
                                            Action Keywords
                                        </label>
                                        <textarea class="form-control" id="global-action-keywords" name="action_keywords" rows="3" placeholder="download&#10;upgrade&#10;install"></textarea>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label" for="global-urgency-keywords">
                                            <svg width="14" height="14" fill="currentColor" class="bi bi-lightning me-1" viewBox="0 0 16 16">
                                                <path d="M5.52.359A.5.5 0 0 1 6 0h4a.5.5 0 0 1 .474.658L8.694 6H12.5a.5.5 0 0 1 .395.807l-7 9a.5.5 0 0 1-.873-.454L6.823 9.5H3.5a.5.5 0 0 1-.48-.641l2.5-8.5z"/>
                                            </svg>
                                            Urgency Keywords
                                        </label>
                                        <textarea class="form-control" id="global-urgency-keywords" name="urgency_keywords" rows="3" placeholder="urgent&#10;critical&#10;emergency"></textarea>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label" for="global-security-keywords">
                                            <svg width="14" height="14" fill="currentColor" class="bi bi-shield-lock me-1" viewBox="0 0 16 16">
                                                <path d="M5.338 1.59a61.44 61.44 0 0 0-2.837.856.481.481 0 0 0-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 0 0 2.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 0 0 .101.025.615.615 0 0 0 .1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 0 0 2.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 0 0-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 0 1 1.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 0 1-2.517 2.453 7.159 7.159 0 0 1-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 0 1-1.048-.625 11.777 11.777 0 0 1-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 0 1 2.185 1.43 62.456 62.456 0 0 1 5.072.56z"/>
                                                <path d="M9.5 6.5a1.5 1.5 0 0 1-1 1.415l.385 1.99a.5.5 0 0 1-.491.595h-.788a.5.5 0 0 1-.49-.595l.384-1.99a1.5 1.5 0 1 1 2-1.415z"/>
                                            </svg>
                                            Security Keywords
                                        </label>
                                        <textarea class="form-control" id="global-security-keywords" name="security_keywords" rows="3" placeholder="CVE&#10;zero-day&#10;patch"></textarea>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label" for="global-release-keywords">
                                            <svg width="14" height="14" fill="currentColor" class="bi bi-box-seam me-1" viewBox="0 0 16 16">
                                                <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5l2.404.961L10.404 2l-2.218-.887zm3.564 1.426L5.596 5 8 5.961 14.154 3.5l-2.404-.961zm3.25 1.7-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
                                            </svg>
                                            Release Keywords
                                        </label>
                                        <textarea class="form-control" id="global-release-keywords" name="release_keywords" rows="3" placeholder="v1.0&#10;beta&#10;stable"></textarea>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <label class="form-label" for="global-decision-keywords">
                                            <svg width="14" height="14" fill="currentColor" class="bi bi-diagram-3 me-1" viewBox="0 0 16 16">
                                                <path fill-rule="evenodd" d="M6 3.5A1.5 1.5 0 0 1 7.5 2h1A1.5 1.5 0 0 1 10 3.5v1A1.5 1.5 0 0 1 8.5 6v1H14a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0V8h-5v.5a.5.5 0 0 1-1 0v-1A.5.5 0 0 1 2 7h5.5V6A1.5 1.5 0 0 1 6 4.5v-1zM8.5 5a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1zM0 11.5A1.5 1.5 0 0 1 1.5 10h1A1.5 1.5 0 0 1 4 11.5v1A1.5 1.5 0 0 1 2.5 14h-1A1.5 1.5 0 0 1 0 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zm4.5.5A1.5 1.5 0 0 1 7.5 10h1a1.5 1.5 0 0 1 1.5 1.5v1A1.5 1.5 0 0 1 8.5 14h-1A1.5 1.5 0 0 1 6 12.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zm4.5.5a1.5 1.5 0 0 1 1.5-1.5h1a1.5 1.5 0 0 1 1.5 1.5v1a1.5 1.5 0 0 1-1.5 1.5h-1a1.5 1.5 0 0 1-1.5-1.5v-1zm1.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1z"/>
                                            </svg>
                                            Decision Keywords
                                        </label>
                                        <textarea class="form-control" id="global-decision-keywords" name="decision_keywords" rows="3" placeholder="vote&#10;proposal&#10;deadline"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Scoring Weights -->
                            <div class="border rounded p-3">
                                <h3 class="h6 mb-3">Scoring Weights</h3>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label" for="weight-keywords">Keywords: <span id="weight-keywords-value">0.8</span></label>
                                        <input type="range" class="form-range" id="weight-keywords" name="weight_keywords" min="0" max="3" step="0.1" value="0.8">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="weight-action">Action: <span id="weight-action-value">1.0</span></label>
                                        <input type="range" class="form-range" id="weight-action" name="weight_action" min="0" max="3" step="0.1" value="1.0">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="weight-urgency">Urgency: <span id="weight-urgency-value">1.5</span></label>
                                        <input type="range" class="form-range" id="weight-urgency" name="weight_urgency" min="0" max="3" step="0.1" value="1.5">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="weight-security">Security: <span id="weight-security-value">1.2</span></label>
                                        <input type="range" class="form-range" id="weight-security" name="weight_security" min="0" max="3" step="0.1" value="1.2">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="weight-release">Release: <span id="weight-release-value">0.8</span></label>
                                        <input type="range" class="form-range" id="weight-release" name="weight_release" min="0" max="3" step="0.1" value="0.8">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="weight-decision">Decision: <span id="weight-decision-value">1.1</span></label>
                                        <input type="range" class="form-range" id="weight-decision" name="weight_decision" min="0" max="3" step="0.1" value="1.1">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Detection Flags -->
                            <div class="border rounded p-3">
                                <h3 class="h6 mb-3">Detection Flags</h3>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="global-detect-codes" name="detect_codes" checked>
                                            <label class="form-check-label" for="global-detect-codes">Detect code blocks</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="global-detect-documents" name="detect_documents" checked>
                                            <label class="form-check-label" for="global-detect-documents">Detect documents</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="global-prioritize-pinned" name="prioritize_pinned" checked>
                                            <label class="form-check-label" for="global-prioritize-pinned">Prioritize pinned</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Scope Restriction (Channels & Users) -->
                            <div class="border-top pt-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h3 class="h6 mb-0">Apply Profile To</h3>
                                    <button type="button" class="btn btn-primary btn-sm" id="btn-select-entities-interest" data-bs-toggle="modal" data-bs-target="#selectEntitiesModal">
                                        <span aria-hidden="true">+</span> ADD
                                    </button>
                                </div>
                                <div id="selected-entities-interest" class="border rounded p-3 bg-dark" style="min-height: 80px;">
                                    <div class="text-muted small" id="entities-placeholder-interest">No channels or users selected.</div>
                                    <div id="entities-badges-interest" class="d-flex flex-wrap gap-2"></div>
                                </div>
                                <small class="text-muted">Select specific channels/users or leave empty to apply to all monitored entities configured in the settings section.</small>
                            </div>
                            
                            <!-- Digest Configuration (Phase 5) -->
                            <div class="border rounded p-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h3 class="h6 mb-0">
                                        <svg width="14" height="14" fill="currentColor" class="bi bi-envelope me-1" viewBox="0 0 16 16">
                                            <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
                                        </svg>
                                        Digest Schedules
                                    </h3>
                                    <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#digest-config-help">
                                        <svg width="14" height="14" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16">
                                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                            <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                                        </svg>
                                    </button>
                                </div>
                                
                                <div class="collapse mb-3" id="digest-config-help">
                                    <div class="alert alert-info small mb-0">
                                        <p class="mb-1"><strong>What are digest schedules?</strong></p>
                                        <p class="mb-1">Instead of instant alerts for every message, digest schedules batch messages and send summaries at regular intervals.</p>
                                        <ul class="mb-0">
                                            <li><strong>Hourly:</strong> Every hour (00:00, 01:00, ...)</li>
                                            <li><strong>Every 4h:</strong> 4 times per day (00:00, 04:00, 08:00, ...)</li>
                                            <li><strong>Daily:</strong> Once per day at configured hour</li>
                                            <li><strong>Weekly:</strong> Once per week on configured day</li>
                                        </ul>
                                        <p class="mb-0 mt-2"><em>Configure up to 3 schedules per profile for different batching frequencies.</em></p>
                                    </div>
                                </div>
                                
                                {# Macro for rendering digest schedule cards #}
                                {% macro schedule_card(num) %}
                                {% set default_top_n = 10 * num %}
                                {% set default_min_score = 6.0 - num %}
                                <!-- Schedule {{ num }} -->
                                <div class="card mb-3">
                                    <div class="card-header py-2">
                                        {% if num > 1 %}
                                        <button class="btn btn-link p-0 text-decoration-none text-white d-flex align-items-center gap-2 w-100" type="button" data-bs-toggle="collapse" data-bs-target="#global-schedule-{{ num }}-body" aria-expanded="false">
                                            <svg width="14" height="14" fill="currentColor" class="bi bi-chevron-right schedule-chevron" viewBox="0 0 16 16">
                                                <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                                            </svg>
                                            <strong>Schedule {{ num }}</strong> <span class="badge bg-dark">Optional</span>
                                        </button>
                                        {% else %}
                                        <strong>Schedule {{ num }}</strong>
                                        {% endif %}
                                    </div>
                                    <div class="card-body{% if num > 1 %} collapse{% endif %}" id="global-schedule-{{ num }}-body">
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label" for="digest-schedule-{{ num }}-type">Schedule Type</label>
                                                <select class="form-select form-select-sm" id="digest-schedule-{{ num }}-type" name="digest_schedule_{{ num }}_type">
                                                    <option value="">{% if num == 1 %}None (Instant Alerts){% else %}None{% endif %}</option>
                                                    <option value="hourly">‚è∞ Hourly</option>
                                                    <option value="every_4h">üïì Every 4 Hours</option>
                                                    <option value="every_6h">üïï Every 6 Hours</option>
                                                    <option value="every_12h">üïõ Every 12 Hours</option>
                                                    <option value="daily">üìÖ Daily</option>
                                                    <option value="weekly">üìä Weekly</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label" for="digest-schedule-{{ num }}-top-n">Top N Messages</label>
                                                <input type="number" class="form-control form-control-sm" id="digest-schedule-{{ num }}-top-n" name="digest_schedule_{{ num }}_top_n" min="1" max="100" value="{{ default_top_n }}" placeholder="{{ default_top_n }}">
                                                {% if num == 1 %}<small class="form-text">Max messages in digest</small>{% endif %}
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label" for="digest-schedule-{{ num }}-min-score">Min Score</label>
                                                <input type="number" class="form-control form-control-sm" id="digest-schedule-{{ num }}-min-score" name="digest_schedule_{{ num }}_min_score" min="0" max="10" step="0.1" value="{{ default_min_score }}" placeholder="{{ default_min_score }}">
                                                {% if num == 1 %}<small class="form-text">Minimum score threshold</small>{% endif %}
                                            </div>
                                            <div class="col-md-6 digest-daily-settings d-none" id="digest-schedule-{{ num }}-daily-settings">
                                                <label class="form-label" for="digest-schedule-{{ num }}-daily-hour">Daily Hour (UTC)</label>
                                                <input type="number" class="form-control form-control-sm" id="digest-schedule-{{ num }}-daily-hour" name="digest_schedule_{{ num }}_daily_hour" min="0" max="23" value="8" placeholder="8">
                                                {% if num == 1 %}<small class="form-text">Hour of day (0-23)</small>{% endif %}
                                            </div>
                                            <div class="col-md-6 digest-weekly-settings d-none" id="digest-schedule-{{ num }}-weekly-settings">
                                                <label class="form-label" for="digest-schedule-{{ num }}-weekly-day">Weekly Day</label>
                                                <select class="form-select form-select-sm" id="digest-schedule-{{ num }}-weekly-day" name="digest_schedule_{{ num }}_weekly_day">
                                                    <option value="0">Monday</option>
                                                    <option value="1">Tuesday</option>
                                                    <option value="2">Wednesday</option>
                                                    <option value="3">Thursday</option>
                                                    <option value="4">Friday</option>
                                                    <option value="5">Saturday</option>
                                                    <option value="6">Sunday</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 digest-weekly-settings d-none" id="digest-schedule-{{ num }}-weekly-hour-settings">
                                                <label class="form-label" for="digest-schedule-{{ num }}-weekly-hour">Weekly Hour (UTC)</label>
                                                <input type="number" class="form-control form-control-sm" id="digest-schedule-{{ num }}-weekly-hour" name="digest_schedule_{{ num }}_weekly_hour" min="0" max="23" value="8" placeholder="8">
                                                {% if num == 1 %}<small class="form-text">Hour of day (0-23)</small>{% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endmacro %}
                                
                                {# Render 3 schedule cards using the macro #}
                                {% for schedule_num in range(1, 4) %}
                                {{ schedule_card(schedule_num) }}
                                {% endfor %}
                                
                                <!-- Delivery Settings -->
                                <div class="card bg-secondary">
                                    <div class="card-header py-2">
                                        <strong>Delivery Settings</strong>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label" for="digest-mode">Delivery Mode</label>
                                                <select class="form-select form-select-sm" id="digest-mode" name="digest_mode">
                                                    <option value="dm">üí¨ DM Only (Saved Messages)</option>
                                                    <option value="channel">üì¢ Channel Only</option>
                                                    <option value="both">üîÑ Both DM & Channel</option>
                                                </select>
                                                <small class="form-text">Where to send digests</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label" for="digest-target-channel">Target Channel</label>
                                                <input type="text" class="form-control form-control-sm" id="digest-target-channel" name="digest_target_channel" placeholder="@security_alerts">
                                                <small class="form-text">Required for channel/both modes</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Usage Info -->
                            <div class="alert alert-secondary d-none" role="alert" id="global-profile-usage">
                                <strong>Profile Usage:</strong>
                                <div id="global-profile-usage-content"></div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex justify-content-end gap-2">
                                <button class="btn btn-primary" type="submit" id="btn-save-global-profile">
                                    <svg width="16" height="16" fill="currentColor" class="bi bi-check-lg me-1" viewBox="0 0 16 16">
                                        <path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022Z"/>
                                    </svg>
                                    <span id="global-save-btn-text">Save Profile</span>
                                </button>
                                <button class="btn btn-outline-primary" type="button" id="btn-backtest-global-profile">
                                    <svg width="16" height="16" fill="currentColor" class="bi bi-speedometer me-1" viewBox="0 0 16 16">
                                        <path d="M8 2a.5.5 0 0 1 .5.5V4a.5.5 0 0 1-1 0V2.5A.5.5 0 0 1 8 2zM3.732 3.732a.5.5 0 0 1 .707 0l.915.914a.5.5 0 1 1-.708.708l-.914-.915a.5.5 0 0 1 0-.707zM2 8a.5.5 0 0 1 .5-.5h1.586a.5.5 0 0 1 0 1H2.5A.5.5 0 0 1 2 8zm9.5 0a.5.5 0 0 1 .5-.5h1.5a.5.5 0 0 1 0 1H12a.5.5 0 0 1-.5-.5zm.754-4.246a.389.389 0 0 0-.527-.02L7.547 7.31A.91.91 0 1 0 8.85 8.569l3.434-4.297a.389.389 0 0 0-.029-.518z"/>
                                        <path fill-rule="evenodd" d="M6.664 15.889A8 8 0 1 1 9.336.11a8 8 0 0 1-2.672 15.78zm-4.665-4.283A11.945 11.945 0 0 1 8 10c2.186 0 4.236.585 6.001 1.606a7 7 0 1 0-12.002 0z"/>
                                    </svg>
                                    Backtest
                                </button>
                                <button class="btn btn-outline-secondary" type="button" id="btn-reset-global-profile">Clear</button>
                                <button class="btn btn-outline-danger d-none" type="button" id="btn-delete-global-profile">Delete</button>
                            </div>
                        </form>
                    </div>
                </article>
            </div>
    <div class="tab-pane fade" id="interest-profiles" role="tabpanel" aria-labelledby="interest-profiles-tab">
        <section class="row g-4 mb-4">
            <!-- Interest Profiles List (Left Column) -->
            <div class="col-12 col-xl-4">
                <article class="card alert-profiles-list-card" aria-labelledby="interest-profiles-list-heading">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="card-title mb-0" id="interest-profiles-list-heading">Interest Profiles</h2>
                            <small class="text-muted"><span id="interest-profiles-count">0</span> profiles</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" type="button" id="btn-interest-bulk-actions" title="Bulk actions">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                                </svg>
                            </button>
                            <button class="btn btn-sm btn-primary" type="button" id="btn-new-interest-profile">
                                <svg width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                                </svg>
                                New
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Search/Filter Bar -->
                        <div class="p-3 border-bottom">
                            <input type="text" class="form-control form-control-sm" id="interest-profiles-search" placeholder="üîç Search profiles...">
                        </div>
                        <!-- Profiles List -->
                        <div class="alert-profiles-list-container" id="interest-profiles-list-container">
                            <div class="list-group list-group-flush" id="interest-profiles-list">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                    </div>
                </article>
            </div>
            
            <!-- Interest Profile Editor (Right Column) -->
            <div class="col-12 col-xl-8">
                <article class="card h-100" aria-labelledby="interest-profile-editor-heading">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title mb-0" id="interest-profile-editor-heading">Interest Profile Editor</h2>
                            <small class="text-muted">Create and refine semantic interest profiles</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="interest-profile-form" class="d-grid gap-3" novalidate>
                    <input type="hidden" id="interest-profile-id" value="">
                    
                    <!-- Basic Fields -->
                    <div class="row">
                        <div class="col-md-4 d-none">
                            <label class="form-label" for="interest-profile-id-display">Profile ID</label>
                            <input class="form-control" id="interest-profile-id-display" type="text" placeholder="Auto-generated" readonly style="background-color: #e9ecef;">
                            <small class="form-text text-muted">Auto-assigned integer ID (3000-3999)</small>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label" for="topic-name">Topic name <span class="text-danger">*</span></label>
                            <input class="form-control" id="topic-name" name="topic" type="text" placeholder="e.g., marketing core development" required>
                            <small class="form-text">A unique identifier for this interest profile</small>
                        </div>
                    </div>
                    
                    <div>
                        <label class="form-label" for="topic-description">Description</label>
                        <input class="form-control" id="topic-description" name="description" type="text" placeholder="Brief description of this profile">
                        <small class="form-text">Optional: helps document the profile's purpose</small>
                    </div>
                    
                    <div>
                        <label class="form-label" for="positive-samples">Positive examples</label>
                        <textarea class="form-control" id="positive-samples" name="positive" rows="6" placeholder="Paste messages that should match this profile&#10;One example per line"></textarea>
                        <small class="form-text">Messages that represent the interest</small>
                    </div>
                    
                    <div>
                        <label class="form-label" for="negative-samples">Negative examples</label>
                        <textarea class="form-control" id="negative-samples" name="negative" rows="4" placeholder="Paste noise or unrelated content&#10;One example per line"></textarea>
                        <small class="form-text">Messages that should NOT match (helps refine the profile)</small>
                    </div>
                    
                    <!-- Scope Restriction (Channels & Users) -->
                    <div class="border-top pt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h3 class="h6 mb-0">Apply Profile To</h3>
                            <button type="button" class="btn btn-primary btn-sm" id="btn-select-entities-interest" data-bs-toggle="modal" data-bs-target="#selectEntitiesModal">
                                <span aria-hidden="true">+</span> ADD
                            </button>
                        </div>
                        <div id="selected-entities-interest" class="border rounded p-3 bg-dark" style="min-height: 80px;">
                            <div class="text-muted small" id="entities-placeholder-interest">No channels or users selected. Profile applies to all monitored entitties configured in the settings section.
</div>
                            <div id="entities-badges-interest" class="d-flex flex-wrap gap-2"></div>
                        </div>
                        <small class="text-muted">Select specific channels/users or leave empty to apply to all monitored entities</small>
                    </div>
                    
                    <!-- Advanced Section (Collapsible) -->
                    <div class="border-top pt-3">
                        <button class="btn btn-link p-0 text-decoration-none d-flex align-items-center gap-2" type="button" data-bs-toggle="collapse" data-bs-target="#advanced-config" aria-expanded="false" aria-controls="advanced-config">
                            <svg width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16" id="collapse-icon">
                                <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                            </svg>
                            <strong>Advanced Configuration</strong>
                        </button>
                    </div>
                    
                    <div class="collapse" id="advanced-config">
                        <div class="card card-body bg-dark border-secondary">
                            <div class="d-grid gap-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label" for="similarity-threshold">Similarity Threshold</label>
                                        <input class="form-control" id="similarity-threshold" name="threshold" type="number" min="0" max="1" step="0.01" value="0.42" placeholder="0.42">
                                        <small class="form-text">Score threshold (0.0 - 1.0) for matches</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="profile-weight">Profile Weight</label>
                                        <input class="form-control" id="profile-weight" name="weight" type="number" min="0" max="10" step="0.1" value="1.0" placeholder="1.0">
                                        <small class="form-text">Importance multiplier for this profile</small>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label" for="profile-enabled">Status</label>
                                        <select class="form-select" id="profile-enabled" name="enabled">
                                            <option value="true" selected>Enabled</option>
                                            <option value="false">Disabled</option>
                                        </select>
                                        <small class="form-text">Active/inactive state</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="profile-priority">Priority</label>
                                        <select class="form-select" id="profile-priority" name="priority">
                                            <option value="low">Low</option>
                                            <option value="normal" selected>Normal</option>
                                            <option value="high">High</option>
                                            <option value="critical">Critical</option>
                                        </select>
                                        <small class="form-text">Alert priority level</small>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="form-label" for="profile-keywords">Keywords (comma-separated)</label>
                                    <input class="form-control" id="profile-keywords" name="keywords" type="text" placeholder="keyword1, keyword2, keyword3">
                                    <small class="form-text">Boost scoring for messages containing these keywords</small>
                                </div>
                                
                                <div>
                                    <label class="form-label" for="profile-tags">Tags (comma-separated)</label>
                                    <input class="form-control" id="profile-tags" name="tags" type="text" placeholder="security, urgent, technical">
                                    <small class="form-text">Organizational tags for filtering and grouping</small>
                                </div>
                                
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="profile-notify-always" name="notify_always">
                                    <label class="form-check-label" for="profile-notify-always">
                                        Always notify (bypass other filters)
                                    </label>
                                </div>
                                
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="profile-include-in-digest" name="include_digest" checked>
                                    <label class="form-check-label" for="profile-include-in-digest">
                                        Include matches in digests
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Digest Configuration for Interest Profiles -->
                    <div class="border rounded p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="h6 mb-0">
                                <svg width="14" height="14" fill="currentColor" class="bi bi-envelope me-1" viewBox="0 0 16 16">
                                    <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/>
                                </svg>
                                Digest Schedules
                            </h3>
                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#interest-digest-help">
                                <svg width="14" height="14" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="collapse mb-3" id="interest-digest-help">
                            <div class="alert alert-info small mb-0">
                                <p class="mb-1"><strong>What are digest schedules?</strong></p>
                                <p class="mb-1">Batch matching messages from this interest profile and send summaries at regular intervals.</p>
                                <p class="mb-0 mt-2"><em>Configure up to 3 schedules for this interest profile.</em></p>
                            </div>
                        </div>
                        
                        {# Render 3 schedule cards for Interest Profiles #}
                        {% for schedule_num in range(1, 4) %}
                        <div class="card mb-3">
                            <div class="card-header py-2">
                                {% if schedule_num > 1 %}
                                <button class="btn btn-link p-0 text-decoration-none text-white d-flex align-items-center gap-2 w-100" type="button" data-bs-toggle="collapse" data-bs-target="#interest-schedule-{{ schedule_num }}-body" aria-expanded="false">
                                    <svg width="14" height="14" fill="currentColor" class="bi bi-chevron-right schedule-chevron" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                                    </svg>
                                    <strong>Schedule {{ schedule_num }}</strong> <span class="badge bg-dark">Optional</span>
                                </button>
                                {% else %}
                                <strong>Schedule {{ schedule_num }}</strong>
                                {% endif %}
                            </div>
                            <div class="{% if schedule_num > 1 %}collapse {% endif %}card-body" id="interest-schedule-{{ schedule_num }}-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label" for="interest-digest-schedule-{{ schedule_num }}-type">Schedule Type</label>
                                        <select class="form-select form-select-sm interest-digest-schedule-type" id="interest-digest-schedule-{{ schedule_num }}-type" name="interest_digest_schedule_{{ schedule_num }}_type">
                                            <option value="">{% if schedule_num == 1 %}None (Instant Alerts){% else %}None{% endif %}</option>
                                            <option value="hourly">‚è∞ Hourly</option>
                                            <option value="every_4h">üïì Every 4 Hours</option>
                                            <option value="every_6h">üïï Every 6 Hours</option>
                                            <option value="every_12h">üïõ Every 12 Hours</option>
                                            <option value="daily">üìÖ Daily</option>
                                            <option value="weekly">üìä Weekly</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="interest-digest-schedule-{{ schedule_num }}-top-n">Top N Messages</label>
                                        <input type="number" class="form-control form-control-sm" id="interest-digest-schedule-{{ schedule_num }}-top-n" name="interest_digest_schedule_{{ schedule_num }}_top_n" min="1" max="100" value="{{ 10 * schedule_num }}" placeholder="{{ 10 * schedule_num }}">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label" for="interest-digest-schedule-{{ schedule_num }}-min-score">Min Score</label>
                                        <input type="number" class="form-control form-control-sm" id="interest-digest-schedule-{{ schedule_num }}-min-score" name="interest_digest_schedule_{{ schedule_num }}_min_score" min="0" max="10" step="0.1" value="{{ 6.0 - schedule_num }}" placeholder="{{ 6.0 - schedule_num }}">
                                    </div>
                                    <div class="col-md-6 interest-digest-daily-settings d-none" id="interest-digest-schedule-{{ schedule_num }}-daily-settings">
                                        <label class="form-label" for="interest-digest-schedule-{{ schedule_num }}-daily-hour">Daily Hour (UTC)</label>
                                        <input type="number" class="form-control form-control-sm" id="interest-digest-schedule-{{ schedule_num }}-daily-hour" name="interest_digest_schedule_{{ schedule_num }}_daily_hour" min="0" max="23" value="8" placeholder="8">
                                    </div>
                                    <div class="col-md-6 interest-digest-weekly-settings d-none" id="interest-digest-schedule-{{ schedule_num }}-weekly-settings">
                                        <label class="form-label" for="interest-digest-schedule-{{ schedule_num }}-weekly-day">Weekly Day</label>
                                        <select class="form-select form-select-sm" id="interest-digest-schedule-{{ schedule_num }}-weekly-day" name="interest_digest_schedule_{{ schedule_num }}_weekly_day">
                                            <option value="0">Monday</option>
                                            <option value="1">Tuesday</option>
                                            <option value="2">Wednesday</option>
                                            <option value="3">Thursday</option>
                                            <option value="4">Friday</option>
                                            <option value="5">Saturday</option>
                                            <option value="6">Sunday</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 interest-digest-weekly-settings d-none" id="interest-digest-schedule-{{ schedule_num }}-weekly-hour-settings">
                                        <label class="form-label" for="interest-digest-schedule-{{ schedule_num }}-weekly-hour">Weekly Hour (UTC)</label>
                                        <input type="number" class="form-control form-control-sm" id="interest-digest-schedule-{{ schedule_num }}-weekly-hour" name="interest_digest_schedule_{{ schedule_num }}_weekly_hour" min="0" max="23" value="8" placeholder="8">
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Delivery Settings for Interest Profiles -->
                        <div class="card bg-secondary">
                            <div class="card-header py-2">
                                <strong>Delivery Settings</strong>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label" for="interest-digest-mode">Delivery Mode</label>
                                        <select class="form-select form-select-sm" id="interest-digest-mode" name="interest_digest_mode">
                                            <option value="dm">üí¨ DM Only (Saved Messages)</option>
                                            <option value="channel">üì¢ Channel Only</option>
                                            <option value="both">üîÑ Both DM & Channel</option>
                                        </select>
                                        <small class="form-text">Where to send digests</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="interest-digest-target-channel">Target Channel (for channel/both mode)</label>
                                        <input type="text" class="form-control form-control-sm" id="interest-digest-target-channel" name="interest_digest_target_channel" placeholder="@my_alerts_channel">
                                        <small class="form-text">Channel username or ID</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-3">
                        <button class="btn btn-primary" type="submit" id="btn-save-interest-profile">
                            <span id="interest-save-btn-text">Save Profile</span>
                        </button>
                        <button class="btn btn-outline-primary" type="button" id="btn-backtest-interest-profile">
                            <svg width="16" height="16" fill="currentColor" class="bi bi-speedometer me-1" viewBox="0 0 16 16">
                                <path d="M8 2a.5.5 0 0 1 .5.5V4a.5.5 0 0 1-1 0V2.5A.5.5 0 0 1 8 2zM3.732 3.732a.5.5 0 0 1 .707 0l.915.914a.5.5 0 1 1-.708.708l-.914-.915a.5.5 0 0 1 0-.707zM2 8a.5.5 0 0 1 .5-.5h1.586a.5.5 0 0 1 0 1H2.5A.5.5 0 0 1 2 8zm9.5 0a.5.5 0 0 1 .5-.5h1.5a.5.5 0 0 1 0 1H12a.5.5 0 0 1-.5-.5zm.754-4.246a.389.389 0 0 0-.527-.02L7.547 7.31A.91.91 0 1 0 8.85 8.569l3.434-4.297a.389.389 0 0 0-.029-.518z"/>
                                <path fill-rule="evenodd" d="M6.664 15.889A8 8 0 1 1 9.336.11a8 8 0 0 1-2.672 15.78zm-4.665-4.283A11.945 11.945 0 0 1 8 10c2.186 0 4.236.585 6.001 1.606a7 7 0 1 0-12.002 0z"/>
                            </svg>
                            Backtest
                        </button>
                        <button class="btn btn-outline-secondary" type="button" id="btn-reset-interest-profile">Clear</button>
                        <button class="btn btn-outline-danger d-none" type="button" id="btn-delete-interest-profile">Delete</button>
                    </div>
                </form>
            </div>
        </article>
    </div>
</div>

<!-- Similarity Tester (Full Width Below Editor) -->
<div class="row g-3 mt-0">
    <div class="col-12">
        <article class="card h-100" aria-labelledby="profile-tester-heading">
            <div class="card-header">
                <div>
                    <h2 class="card-title mb-0" id="profile-tester-heading">Similarity Tester</h2>
                    <small class="text-muted">Compare phrases against saved profiles</small>
                </div>
            </div>
            <div class="card-body d-grid gap-3">
                <div>
                    <label class="form-label" for="test-phrase">Test phrase</label>
                    <input class="form-control max-w-100" id="test-phrase" type="text" placeholder="Exploit in governance contract">
                </div>
                <div>
                    <label class="form-label" for="profile-select">Compare against</label>
                    <select class="form-select max-w-100" id="profile-select">
                        {%- for interest in interests %}
                        <option value="{{ interest }}">{{ interest }}</option>
                        {%- else %}
                        <option value="default">Default profile</option>
                        {%- endfor %}
                    </select>
                </div>
                <div class="d-flex gap-2 align-items-center flex-wrap">
                    <button class="btn btn-outline-primary btn-sm" type="button" id="btn-run-test">Run Test</button>
                    <p class="mb-0" id="test-result" aria-live="polite">Score: --</p>
                </div>
                <div class="logs-viewer overflow-x-auto" aria-live="polite" id="profile-log">
                    <pre class="mb-0 text-muted white-space-pre-wrap">Build focused profiles for semantic scoring.</pre>
                </div>
                <div class="d-flex gap-2 align-items-center flex-wrap">
                    <button class="btn btn-outline-primary" type="button" id="btn-import-profiles">
                        <svg width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                        </svg>
                        Import
                    </button>
                    <button class="btn btn-outline-primary" type="button" id="btn-export-profiles">
                        <svg width="16" height="16" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                        </svg>
                        Export
                    </button>
                </div>
            </div>
        </article>
    </div>
</div>

</section> <!-- End Interest Profiles Section -->
</div> <!-- End tab-content -->

<!-- Select Entities Modal (for Profile Restrictions) -->
<div class="modal fade" id="selectEntitiesModal" tabindex="-1" aria-labelledby="selectEntitiesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectEntitiesModalLabel">Select Channels & Users for Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <small><i class="bi bi-info-circle me-1"></i>Select which monitored channels and users this profile should apply to. Leave all unchecked to apply to all entities.</small>
                </div>
                
                <!-- Tabs Navigation -->
                <ul class="nav nav-tabs mb-3" id="selectEntitiesTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="modal-channels-tab" data-bs-toggle="tab" data-bs-target="#modal-channels-pane" type="button" role="tab" aria-controls="modal-channels-pane" aria-selected="true">
                            <i class="bi bi-megaphone me-1"></i>Channels <span class="badge bg-secondary ms-1" id="channels-count-badge">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="modal-users-tab" data-bs-toggle="tab" data-bs-target="#modal-users-pane" type="button" role="tab" aria-controls="modal-users-pane" aria-selected="false">
                            <i class="bi bi-person me-1"></i>Users <span class="badge bg-secondary ms-1" id="users-count-badge">0</span>
                        </button>
                    </li>
                </ul>

                <!-- Tabs Content -->
                <div class="tab-content" id="selectEntitiesTabsContent">
                    <!-- Channels Tab -->
                    <div class="tab-pane fade show active" id="modal-channels-pane" role="tabpanel" aria-labelledby="modal-channels-tab">
                        <div id="modal-channels-loading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted small">Loading monitored channels...</p>
                        </div>
                        <div id="modal-channels-error" class="alert alert-danger d-none" role="alert"></div>
                        <div id="modal-channels-list" class="d-none">
                            <!-- Search Filter -->
                            <div class="mb-3">
                                <input type="text" class="form-control form-control-sm" id="modal-channels-search" placeholder="üîç Search channels...">
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Select channels:</small>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-select-all-modal-channels">
                                    <i class="bi bi-check-square me-1"></i>Select All
                                </button>
                            </div>
                            <div class="list-group" style="max-height: 300px; overflow-y: auto;" id="modal-channels-checkboxes">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Users Tab -->
                    <div class="tab-pane fade" id="modal-users-pane" role="tabpanel" aria-labelledby="modal-users-tab">
                        <div id="modal-users-loading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted small">Loading monitored users...</p>
                        </div>
                        <div id="modal-users-error" class="alert alert-danger d-none" role="alert"></div>
                        <div id="modal-users-list" class="d-none">
                            <!-- Search Filter -->
                            <div class="mb-3">
                                <input type="text" class="form-control form-control-sm" id="modal-users-search" placeholder="üîç Search users...">
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">Select users:</small>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="btn-select-all-modal-users">
                                    <i class="bi bi-check-square me-1"></i>Select All
                                </button>
                            </div>
                            <div class="list-group" style="max-height: 300px; overflow-y: auto;" id="modal-users-checkboxes">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btn-apply-entity-selection">Apply Selection</button>
            </div>
        </div>
    </div>
</div>

<!-- Backtest Results Modal -->
<div class="modal fade" id="backtestModal" tabindex="-1" aria-labelledby="backtestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backtestModalLabel">Backtest Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="backtest-loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Running backtest...</span>
                    </div>
                    <p class="mt-3 text-muted">Analyzing historical messages...</p>
                </div>
                
                <div id="backtest-results" class="d-none">
                    <!-- Statistics Cards -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card bg-dark">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Total Messages</h6>
                                    <p class="card-text h3 mb-0" id="stat-total-messages">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Matched</h6>
                                    <p class="card-text h3 mb-0" id="stat-matched">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Match Rate</h6>
                                    <p class="card-text h3 mb-0" id="stat-match-rate">--</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Avg Score</h6>
                                    <p class="card-text h3 mb-0" id="stat-avg-score">--</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recommendations -->
                    <div class="alert alert-info" id="backtest-recommendations" role="alert">
                        <h6 class="alert-heading">Recommendations</h6>
                        <ul id="recommendations-list" class="mb-0"></ul>
                    </div>
                    
                    <!-- Matched Messages Table -->
                    <h6 class="mb-3">Matched Messages</h6>
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th class="w-15">Channel</th>
                                    <th class="w-10">Message ID</th>
                                    <th class="w-10">Score</th>
                                    <th class="w-20">Triggers</th>
                                    <th class="w-10">Would Alert</th>
                                    <th class="w-35">Preview</th>
                                </tr>
                            </thead>
                            <tbody id="backtest-matches-tbody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="backtest-error" class="alert alert-danger d-none" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // API Endpoints
    const alertProfileEndpoints = {
        list: "{{ url_for('profiles.list_alert_profiles') }}",
        get: "{{ url_for('profiles.get_alert_profile') }}",
        upsert: "{{ url_for('profiles.upsert_alert_profile') }}",
        delete: "{{ url_for('profiles.delete_alert_profile') }}",
        toggle: "{{ url_for('profiles.toggle_alert_profile') }}",
        backtest: "{{ url_for('profiles.backtest_alert_profile') }}"
    };
    
    const interestProfileEndpoints = {
        list: "{{ url_for('profiles.list_interest_profiles') }}",
        get: "{{ url_for('profiles.get_interest_profile', profile_id=0) }}".replace('/0', ''),  // Template for /interest/<id>
        upsert: "{{ url_for('profiles.upsert_interest_profile') }}",
        delete: "{{ url_for('profiles.delete_interest_profile', profile_id=0) }}".replace('/0', ''),  // Template for /interest/<id>
        toggle: "{{ url_for('profiles.toggle_interest_profile', profile_id=0) }}".replace('/0/toggle', ''),  // Template for /interest/<id>/toggle
        backtest: "{{ url_for('profiles.backtest_interest_profile') }}",
        // Legacy endpoints kept for backwards compatibility
        train: "{{ url_for('profiles.train_profile') }}",
        test: "{{ url_for('profiles.test_profile') }}",
        export: "{{ url_for('profiles.export_profiles') }}"
    };
    
    let currentAlertProfile = null;
    let currentInterestProfile = null;
    let allAlertProfiles = [];
    let filteredAlertProfiles = [];
    let allInterestProfiles = [];
    let filteredInterestProfiles = [];

    // ============= ALERT PROFILES FUNCTIONS =============
    
    async function loadAlertProfiles() {
        try {
            const response = await fetch(alertProfileEndpoints.list);
            if (!response.ok) throw new Error("Failed to load alert profiles");
            const data = await response.json();
            
            allAlertProfiles = data.profiles || [];
            filteredAlertProfiles = [...allAlertProfiles];
            
            // Update profile count
            const countEl = document.getElementById("alert-profiles-count");
            if (countEl) {
                countEl.textContent = allAlertProfiles.length;
            }
            
            renderAlertProfiles(filteredAlertProfiles);
        } catch (error) {
            console.error("Failed to load alert profiles:", error);
            showToast("Failed to load alert profiles", "error");
        }
    }
    
    function renderAlertProfiles(profiles) {
        const listEl = document.getElementById("alert-profiles-list");
        if (!listEl) return;
        
        if (!profiles || profiles.length === 0) {
            listEl.innerHTML = `
                <div class="alert-profiles-empty">
                    <svg fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                    </svg>
                    <p class="mb-2">No alert profiles yet</p>
                    <small>Create your first profile to get started</small>
                </div>
            `;
            return;
        }
        
        listEl.innerHTML = profiles.map(profile => {
            // Calculate metadata
            const keywordCount = (profile.critical_keywords || []).length + 
                               (profile.security_keywords || []).length +
                               (profile.urgency_keywords || []).length +
                               (profile.financial_keywords || []).length +
                               (profile.technical_keywords || []).length +
                               (profile.project_keywords || []).length +
                               (profile.community_keywords || []).length +
                               (profile.general_keywords || []).length;
            
            const hasActivity = profile.last_triggered_at; // Will be implemented in backend
            const activityIndicator = hasActivity ? '<span class="alert-profile-activity" title="Recently triggered"></span>' : '';
            
            const lastUpdated = profile.updated_at ? 
                new Date(profile.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 
                'Never';
            
            return `
                <a href="#" class="list-group-item list-group-item-action alert-profile-item" 
                   data-profile-id="${profile.id}"
                   data-profile-name="${escapeHtml(profile.name)}"
                   data-enabled="${profile.enabled}">
                    ${activityIndicator}
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1 pe-2">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <h6 class="mb-0">${escapeHtml(profile.name)}</h6>
                                <span class="badge bg-secondary" style="font-size: 0.7em;">ID: ${profile.id}</span>
                            </div>
                            ${profile.description ? `<small class="text-muted d-block mb-2">${escapeHtml(profile.description)}</small>` : ''}
                            <div class="alert-profile-metadata">
                                ${keywordCount > 0 ? `
                                    <span class="alert-profile-meta-badge">
                                        <svg fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                                        </svg>
                                        ${keywordCount} rules
                                    </span>
                                ` : ''}
                                <span class="alert-profile-meta-badge">
                                    <svg fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                                    </svg>
                                    ${lastUpdated}
                                </span>
                            </div>
                        </div>
                        <div class="d-flex flex-column align-items-end gap-2">
                            <div class="alert-profile-toggle-wrapper">
                                <div class="form-check form-switch mb-0">
                                    <input class="form-check-input alert-profile-toggle" type="checkbox" 
                                           data-profile-id="${profile.id}" 
                                           ${profile.enabled ? 'checked' : ''}
                                           onclick="event.stopPropagation()"
                                           title="${profile.enabled ? 'Disable' : 'Enable'} profile">
                                </div>
                            </div>
                            <div class="alert-profile-actions">
                                <button class="alert-profile-action-btn" 
                                        data-action="export" 
                                        data-profile-id="${profile.id}"
                                        onclick="event.stopPropagation(); exportAlertProfile('${profile.id}')"
                                        title="Export profile">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                    </svg>
                                </button>
                                <button class="alert-profile-action-btn" 
                                        data-action="duplicate" 
                                        data-profile-id="${profile.id}"
                                        onclick="event.stopPropagation(); duplicateAlertProfile('${profile.id}')"
                                        title="Duplicate profile">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1H2z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </a>
            `;
        }).join('');
        
        // Attach click handlers
        listEl.querySelectorAll('.alert-profile-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                loadAlertProfile(item.dataset.profileId);
            });
        });
        
        listEl.querySelectorAll('.alert-profile-toggle').forEach(toggle => {
            toggle.addEventListener('change', async (e) => {
                e.stopPropagation();
                
                // Store previous state for revert on error
                const previousState = !toggle.checked;
                
                // Disable checkbox to prevent rapid repeated clicks
                toggle.disabled = true;
                
                try {
                    await toggleAlertProfile(toggle.dataset.profileId, toggle.checked);
                } catch (error) {
                    // Revert checkbox to previous state on error
                    toggle.checked = previousState;
                    console.error('Failed to toggle alert profile:', error);
                    showToast('Failed to toggle profile. Please try again.', 'error');
                } finally {
                    // Re-enable checkbox after request completes
                    toggle.disabled = false;
                }
            });
        });
    }
    
    function filterAlertProfiles(searchTerm) {
        const term = searchTerm.toLowerCase().trim();
        
        if (!term) {
            filteredAlertProfiles = [...allAlertProfiles];
        } else {
            filteredAlertProfiles = allAlertProfiles.filter(profile => {
                const name = (profile.name || '').toLowerCase();
                const desc = (profile.description || '').toLowerCase();
                const keywords = [
                    ...(profile.critical_keywords || []),
                    ...(profile.security_keywords || []),
                    ...(profile.urgency_keywords || []),
                    ...(profile.financial_keywords || []),
                    ...(profile.technical_keywords || []),
                    ...(profile.project_keywords || []),
                    ...(profile.community_keywords || []),
                    ...(profile.general_keywords || [])
                ].join(' ').toLowerCase();
                
                return name.includes(term) || desc.includes(term) || keywords.includes(term);
            });
        }
        
        renderAlertProfiles(filteredAlertProfiles);
    }
    
    function exportAlertProfile(profileId) {
        const profile = allAlertProfiles.find(p => p.id === profileId);
        if (!profile) return;
        
        const dataStr = JSON.stringify(profile, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `alert-profile-${profile.name.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showToast('Profile exported', 'success');
    }
    
    async function duplicateAlertProfile(profileId) {
        const profile = allAlertProfiles.find(p => p.id === profileId);
        if (!profile) return;
        
        const duplicatedProfile = {
            ...profile,
            id: `${profile.id}-copy-${Date.now()}`,
            name: `${profile.name} (Copy)`,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };
        
        try {
            const response = await fetch(alertProfileEndpoints.upsert, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(duplicatedProfile)
            });
            
            if (!response.ok) throw new Error('Failed to duplicate profile');
            
            showToast('Profile duplicated', 'success');
            await loadAlertProfiles();
        } catch (error) {
            console.error('Failed to duplicate profile:', error);
            showToast('Failed to duplicate profile', 'error');
        }
    }
    
    async function loadAlertProfile(profileId) {
        try {
            const response = await fetch(`${alertProfileEndpoints.get}?id=${encodeURIComponent(profileId)}`);
            if (!response.ok) throw new Error("Failed to load alert profile");
            const data = await response.json();
            
            currentAlertProfile = data.profile;
            
            // Populate form
            document.getElementById("alert-profile-id").value = data.profile.id;
            document.getElementById("alert-profile-id-display").value = data.profile.id || ""; // Display ID field
            document.getElementById("alert-name").value = data.profile.name || "";
            document.getElementById("alert-description").value = data.profile.description || "";
            document.getElementById("alert-enabled").value = data.profile.enabled !== false ? "true" : "false";
            
            // Keywords
            document.getElementById("alert-critical-keywords").value = (data.profile.critical_keywords || []).join(", ");
            document.getElementById("alert-security-keywords").value = (data.profile.security_keywords || []).join(", ");
            document.getElementById("alert-urgency-keywords").value = (data.profile.urgency_keywords || []).join(", ");
            document.getElementById("alert-financial-keywords").value = (data.profile.financial_keywords || []).join(", ");
            document.getElementById("alert-technical-keywords").value = (data.profile.technical_keywords || []).join(", ");
            document.getElementById("alert-project-keywords").value = (data.profile.project_keywords || []).join(", ");
            document.getElementById("alert-community-keywords").value = (data.profile.community_keywords || []).join(", ");
            document.getElementById("alert-general-keywords").value = (data.profile.general_keywords || []).join(", ");
            
            // Detection settings
            document.getElementById("alert-min-score").value = data.profile.min_score || 1.0;
            document.getElementById("alert-vip-senders").value = (data.profile.vip_senders || []).join(", ");
            document.getElementById("alert-excluded-users").value = (data.profile.excluded_users || []).join(", ");
            document.getElementById("alert-detect-questions").checked = data.profile.detect_questions || false;
            document.getElementById("alert-detect-mentions").checked = data.profile.detect_mentions || false;
            document.getElementById("alert-detect-links").checked = data.profile.detect_links || false;
            document.getElementById("alert-require-forwarded").checked = data.profile.require_forwarded || false;
            
            // Set channel and user selections using the helper function
            setSelectedEntityIds('alert', data.profile.channels || [], data.profile.users || []);
            
            // Populate digest configuration if exists (Alert Profiles use 'alert-' prefix)
            if (data.profile.digest_config) {
                populateDigestConfigInForm(data.profile.digest_config, 'alert-');
            } else {
                populateDigestConfigInForm(null, 'alert-');
            }
            
            // Update buttons
            document.getElementById("alert-save-btn-text").textContent = "Update Profile";
            document.getElementById("btn-delete-alert-profile").classList.remove("d-none");
            
            // Highlight active item
            document.querySelectorAll(".alert-profile-item").forEach(item => {
                item.classList.remove("active");
            });
            document.querySelector(`[data-profile-id="${profileId}"]`)?.closest('.alert-profile-item')?.classList.add('active');
            
            showToast(`Loaded: ${data.profile.name}`, "info");
        } catch (error) {
            console.error("Failed to load alert profile:", error);
            showToast("Failed to load alert profile", "error");
        }
    }
    
    async function saveAlertProfile(event) {
        event.preventDefault();
        
        const profileData = {
            id: document.getElementById("alert-profile-id").value || null,
            name: document.getElementById("alert-name").value.trim(),
            description: document.getElementById("alert-description").value.trim(),
            enabled: document.getElementById("alert-enabled").value === "true",
            critical_keywords: parseCSV(document.getElementById("alert-critical-keywords").value),
            security_keywords: parseCSV(document.getElementById("alert-security-keywords").value),
            urgency_keywords: parseCSV(document.getElementById("alert-urgency-keywords").value),
            financial_keywords: parseCSV(document.getElementById("alert-financial-keywords").value),
            technical_keywords: parseCSV(document.getElementById("alert-technical-keywords").value),
            project_keywords: parseCSV(document.getElementById("alert-project-keywords").value),
            community_keywords: parseCSV(document.getElementById("alert-community-keywords").value),
            general_keywords: parseCSV(document.getElementById("alert-general-keywords").value),
            min_score: parseFloat(document.getElementById("alert-min-score").value) || 1.0,
            vip_senders: parseCSV(document.getElementById("alert-vip-senders").value),
            excluded_users: parseCSV(document.getElementById("alert-excluded-users").value),
            detect_questions: document.getElementById("alert-detect-questions").checked,
            detect_mentions: document.getElementById("alert-detect-mentions").checked,
            detect_links: document.getElementById("alert-detect-links").checked,
            require_forwarded: document.getElementById("alert-require-forwarded").checked,
            channels: getSelectedEntityIds('alert', 'channels'),
            users: getSelectedEntityIds('alert', 'users')
        };
        
        // Extract digest configuration from form (Alert Profiles use 'alert-' prefix)
        const digestConfig = extractDigestConfigFromForm('alert-');
        if (digestConfig && digestConfig.schedules && digestConfig.schedules.length > 0) {
            profileData.digest_config = digestConfig;
        }
        
        if (!profileData.name) {
            showToast("Profile name is required", "warning");
            return;
        }
        
        try {
            const response = await fetch(alertProfileEndpoints.upsert, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(profileData)
            });
            
            if (!response.ok) throw new Error("Failed to save alert profile");
            
            showToast(profileData.id ? "Profile updated" : "Profile created", "success");
            await loadAlertProfiles();
            
            if (!profileData.id) {
                resetAlertProfileForm();
            }
        } catch (error) {
            console.error("Failed to save alert profile:", error);
            showToast("Failed to save alert profile", "error");
        }
    }
    
    async function deleteAlertProfile() {
        const profileId = document.getElementById("alert-profile-id").value;
        if (!profileId) return;
        
        const profileName = document.getElementById("alert-name").value;
        if (!confirm(`Delete profile "${profileName}"?`)) return;
        
        try {
            const response = await fetch(`${alertProfileEndpoints.delete}?id=${encodeURIComponent(profileId)}`, {
                method: "DELETE"
            });
            
            if (!response.ok) throw new Error("Failed to delete alert profile");
            
            showToast("Profile deleted", "success");
            resetAlertProfileForm();
            await loadAlertProfiles();
        } catch (error) {
            console.error("Failed to delete alert profile:", error);
            showToast("Failed to delete alert profile", "error");
        }
    }
    
    async function toggleAlertProfile(profileId, enabled) {
        try {
            const response = await fetch(alertProfileEndpoints.toggle, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: profileId, enabled })
            });
            
            if (!response.ok) throw new Error("Failed to toggle alert profile");
            
            showToast(`Profile ${enabled ? 'enabled' : 'disabled'}`, "info");
            await loadAlertProfiles();
        } catch (error) {
            console.error("Failed to toggle alert profile:", error);
            showToast("Failed to toggle alert profile", "error");
        }
    }
    
    async function backtestAlertProfile() {
        const profileId = document.getElementById("alert-profile-id").value;
        if (!profileId) {
            showToast("Please select a profile first", "warning");
            return;
        }
        
        const modalEl = document.getElementById('backtestModal');
        const modal = new bootstrap.Modal(modalEl);
        
        // Apply glass backdrop effect
        const addGlassClass = () => {
            setTimeout(() => {
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop && !backdrop.classList.contains('glass-backdrop')) {
                    backdrop.classList.add('glass-backdrop');
                }
            }, 50);
        };
        
        modalEl.addEventListener('shown.bs.modal', addGlassClass, { once: true });
        modalEl.addEventListener('show.bs.modal', addGlassClass, { once: true });
        
        modal.show();
        
        document.getElementById('backtest-loading').classList.remove('d-none');
        document.getElementById('backtest-results').classList.add('d-none');
        document.getElementById('backtest-error').classList.add('d-none');
        
        try {
            const response = await fetch(alertProfileEndpoints.backtest, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id: profileId,
                    hours_back: 24,
                    max_messages: 100
                })
            });
            
            if (!response.ok) throw new Error("Backtest failed");
            const data = await response.json();
            
            // Display results
            document.getElementById('backtest-loading').classList.add('d-none');
            document.getElementById('backtest-results').classList.remove('d-none');
            
            // Statistics
            document.getElementById('stat-total-messages').textContent = data.stats.total_messages || 0;
            document.getElementById('stat-matched').textContent = data.stats.matched_messages || 0;
            document.getElementById('stat-match-rate').textContent = (data.stats.match_rate || 0).toFixed(1) + '%';
            document.getElementById('stat-avg-score').textContent = (data.stats.avg_score || data.stats.average_score || 0).toFixed(2);
            
            // Recommendations
            const recsList = document.getElementById('recommendations-list');
            if (data.recommendations && data.recommendations.length > 0) {
                recsList.innerHTML = data.recommendations.map(r => `<li>${escapeHtml(r)}</li>`).join('');
            } else {
                recsList.innerHTML = '<li>Profile is working well!</li>';
            }
            
            // Matches table
            const tbody = document.getElementById('backtest-matches-tbody');
            if (data.matches && data.matches.length > 0) {
                tbody.innerHTML = data.matches.map(match => `
                    <tr>
                        <td>${escapeHtml(match.chat_title || 'Unknown')}</td>
                        <td>${match.message_id}</td>
                        <td><span class="badge bg-primary">${match.score.toFixed(2)}</span></td>
                        <td><small>${escapeHtml((match.triggers || []).join(', '))}</small></td>
                        <td>${match.would_alert ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
                        <td><small>${escapeHtml((match.text_preview || '').substring(0, 100))}</small></td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No matches found</td></tr>';
            }
        } catch (error) {
            console.error("Backtest failed:", error);
            document.getElementById('backtest-loading').classList.add('d-none');
            document.getElementById('backtest-error').textContent = `Backtest failed: ${error.message}`;
            document.getElementById('backtest-error').classList.remove('d-none');
        }
    }
    
    function resetAlertProfileForm() {
        document.getElementById("alert-profile-form").reset();
        document.getElementById("alert-profile-id").value = "";
        document.getElementById("alert-profile-id-display").value = ""; // Clear display field
        document.getElementById("alert-save-btn-text").textContent = "Save Profile";
        document.getElementById("btn-delete-alert-profile").classList.add("d-none");
        document.getElementById("alert-min-score").value = "1.0";
        document.getElementById("alert-enabled").value = "true";
        
        // Clear digest configuration fields (Alert Profiles use 'alert-' prefix)
        populateDigestConfigInForm(null, 'alert-');
        
        document.querySelectorAll(".alert-profile-item").forEach(item => {
            item.classList.remove("active");
        });
        
        currentAlertProfile = null;
    }
    
    function newAlertProfile() {
        resetAlertProfileForm();
        showToast("Create a new alert profile", "info");
    }

    // ============= INTEREST PROFILES FUNCTIONS =============
    
    async function loadInterestProfiles() {
        try {
            const response = await fetch(interestProfileEndpoints.list);
            if (!response.ok) throw new Error("Failed to load interest profiles");
            const data = await response.json();
            
            allInterestProfiles = data.profiles || [];
            filteredInterestProfiles = [...allInterestProfiles];
            
            // Update profile count
            const countEl = document.getElementById("interest-profiles-count");
            if (countEl) {
                countEl.textContent = allInterestProfiles.length;
            }
            
            renderInterestProfiles(filteredInterestProfiles);
        } catch (error) {
            console.error("Failed to load interest profiles:", error);
            showToast("Failed to load interest profiles", "error");
        }
    }
    
    function renderInterestProfiles(profiles) {
        const listEl = document.getElementById("interest-profiles-list");
        if (!listEl) {
            return;
        }
        
        if (!profiles || profiles.length === 0) {
            listEl.innerHTML = `
                <div class="alert-profiles-empty">
                    <svg fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                    </svg>
                    <p class="mb-2">No interest profiles yet</p>
                    <small>Create your first profile to get started</small>
                </div>
            `;
            return;
        }
        
        listEl.innerHTML = profiles.map(profile => {
            const keywordCount = (profile.keywords || []).length + 
                               (profile.action_keywords || []).length +
                               (profile.urgency_keywords || []).length +
                               (profile.security_keywords || []).length +
                               (profile.release_keywords || []).length +
                               (profile.decision_keywords || []).length;
            
            const lastUpdated = profile.updated_at ? 
                new Date(profile.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 
                'Never';
            
            return `
                <a href="#" class="list-group-item list-group-item-action global-profile-item" 
                   data-profile-id="${profile.id}"
                   onclick="event.preventDefault(); loadGlobalProfile('${profile.id}')">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1 pe-2">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <h6 class="mb-0">${escapeHtml(profile.name)}</h6>
                                <span class="badge bg-secondary" style="font-size: 0.7em;">ID: ${profile.id}</span>
                            </div>
                            ${profile.description ? `<small class="text-muted d-block mb-2">${escapeHtml(profile.description)}</small>` : ''}
                            <div class="alert-profile-metadata">
                                ${keywordCount > 0 ? `
                                    <span class="alert-profile-meta-badge">
                                        <svg fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                                        </svg>
                                        ${keywordCount} keywords
                                    </span>
                                ` : ''}
                                <span class="alert-profile-meta-badge">
                                    <svg fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                                        <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                                    </svg>
                                    ${lastUpdated}
                                </span>
                            </div>
                        </div>
                        <div class="d-flex flex-column align-items-end gap-2">
                            <div class="alert-profile-toggle-wrapper">
                                <div class="form-check form-switch mb-0">
                                    <input class="form-check-input global-profile-toggle" type="checkbox" 
                                           data-profile-id="${profile.id}" 
                                           ${profile.enabled ? 'checked' : ''}
                                           onclick="event.stopPropagation(); toggleGlobalProfile('${profile.id}', this.checked)"
                                           title="${profile.enabled ? 'Disable' : 'Enable'} profile">
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            `;
        }).join('');
    }

    // ============= INTEREST PROFILES FUNCTIONS =============
    
    async function loadInterestProfiles() {
        try {
            const response = await fetch(globalProfileEndpoints.get(profileId));
            if (!response.ok) throw new Error("Failed to load global profile");
            const data = await response.json();
            
            if (!data.profile) {
                throw new Error("Profile not found");
            }
            
            const profile = data.profile;
            
            // Populate basic fields
            document.getElementById("global-profile-id-input").value = profileId;
            document.getElementById("global-profile-id").value = profileId;
            document.getElementById("global-profile-name").value = profile.name || "";
            document.getElementById("global-description").value = profile.description || "";
            
            // Populate keyword arrays (join with newlines for textareas)
            document.getElementById("global-keywords").value = (profile.keywords || []).join("\n");
            document.getElementById("global-action-keywords").value = (profile.action_keywords || []).join("\n");
            document.getElementById("global-urgency-keywords").value = (profile.urgency_keywords || []).join("\n");
            document.getElementById("global-security-keywords").value = (profile.security_keywords || []).join("\n");
            document.getElementById("global-release-keywords").value = (profile.release_keywords || []).join("\n");
            document.getElementById("global-decision-keywords").value = (profile.decision_keywords || []).join("\n");
            
            // Populate scoring weights (6 sliders)
            document.getElementById("weight-keywords").value = profile.weight_keywords || 0.8;
            document.getElementById("weight-action").value = profile.weight_action || 1.0;
            document.getElementById("weight-urgency").value = profile.weight_urgency || 1.5;
            document.getElementById("weight-security").value = profile.weight_security || 1.2;
            document.getElementById("weight-release").value = profile.weight_release || 0.8;
            document.getElementById("weight-decision").value = profile.weight_decision || 1.1;
            
            // Update slider value displays
            document.getElementById("weight-keywords-value").textContent = profile.weight_keywords || 0.8;
            document.getElementById("weight-action-value").textContent = profile.weight_action || 1.0;
            document.getElementById("weight-urgency-value").textContent = profile.weight_urgency || 1.5;
            document.getElementById("weight-security-value").textContent = profile.weight_security || 1.2;
            document.getElementById("weight-release-value").textContent = profile.weight_release || 0.8;
            document.getElementById("weight-decision-value").textContent = profile.weight_decision || 1.1;
            
            // Populate detection flags (3 checkboxes)
            document.getElementById("global-detect-codes").checked = profile.detect_codes !== false;  // default true
            document.getElementById("global-detect-documents").checked = profile.detect_documents !== false;  // default true
            document.getElementById("global-prioritize-pinned").checked = profile.prioritize_pinned !== false;  // default true
            
            // Populate digest schedules (up to 3)
            const schedules = profile.digest_schedules || [];
            for (let i = 1; i <= 3; i++) {
                const schedule = schedules[i - 1];
                if (schedule) {
                    document.getElementById(`digest-schedule-${i}-type`).value = schedule.schedule_type || "";
                    document.getElementById(`digest-schedule-${i}-top-n`).value = schedule.top_n || (10 * i);
                    document.getElementById(`digest-schedule-${i}-min-score`).value = schedule.min_score || (6.0 - i);
                    
                    if (schedule.schedule_type === 'daily') {
                        document.getElementById(`digest-schedule-${i}-daily-hour`).value = schedule.daily_hour || 8;
                    } else if (schedule.schedule_type === 'weekly') {
                        document.getElementById(`digest-schedule-${i}-weekly-day`).value = schedule.weekly_day || 0;
                        document.getElementById(`digest-schedule-${i}-weekly-hour`).value = schedule.weekly_hour || 8;
                    }
                } else {
                    // Clear empty schedule slots
                    document.getElementById(`digest-schedule-${i}-type`).value = "";
                    document.getElementById(`digest-schedule-${i}-top-n`).value = 10 * i;
                    document.getElementById(`digest-schedule-${i}-min-score`).value = 6.0 - i;
                }
            }
            
            // Populate digest delivery settings
            document.getElementById("digest-mode").value = profile.digest_mode || "dm";
            document.getElementById("digest-target-channel").value = profile.digest_target_channel || "";
            
            // Update buttons
            document.getElementById("global-save-btn-text").textContent = "Update Profile";
            document.getElementById("btn-delete-global-profile").classList.remove("d-none");
            
            // Highlight active item
            document.querySelectorAll(".global-profile-item").forEach(item => {
                item.classList.remove("active");
            });
            document.querySelector(`[data-profile-id="${profileId}"]`)?.classList.add('active');
            
            showToast(`Loaded: ${profile.name}`, "info");
        } catch (error) {
            console.error("Failed to load global profile:", error);
            showToast("Failed to load global profile", "error");
        }
    }
    
    async function toggleGlobalProfile(profileId, event) {
        if (event) event.stopPropagation();
        
        const toggle = event?.target;
        if (toggle) toggle.disabled = true;
        
        try {
            const response = await fetch(globalProfileEndpoints.toggle(profileId), {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            });
            
            if (!response.ok) throw new Error("Failed to toggle profile");
            
            const result = await response.json();
            await loadGlobalProfiles();  // Reload list to reflect new state
            
            showToast("Profile toggled successfully", "success");
        } catch (error) {
            console.error("Failed to toggle global profile:", error);
            showToast("Failed to toggle global profile", "error");
            // Revert toggle state on error
            if (toggle) {
                toggle.checked = !toggle.checked;
            }
        } finally {
            if (toggle) toggle.disabled = false;
        }
    }
    
    async function saveGlobalProfile(event) {
        event.preventDefault();
        
        const profileId = document.getElementById("global-profile-id-input").value.trim();
        const isNewProfile = !profileId || profileId === "";
        
        // Collect all form fields matching the HTML structure
        const profileData = {
            name: document.getElementById("global-profile-name").value.trim(),
            description: document.getElementById("global-description").value.trim(),
            
            // Keyword arrays (textarea fields - split by newline)
            keywords: parseTextareaLines(document.getElementById("global-keywords").value),
            action_keywords: parseTextareaLines(document.getElementById("global-action-keywords").value),
            urgency_keywords: parseTextareaLines(document.getElementById("global-urgency-keywords").value),
            security_keywords: parseTextareaLines(document.getElementById("global-security-keywords").value),
            release_keywords: parseTextareaLines(document.getElementById("global-release-keywords").value),
            decision_keywords: parseTextareaLines(document.getElementById("global-decision-keywords").value),
            
            // Scoring weights (6 range sliders)
            weight_keywords: parseFloat(document.getElementById("weight-keywords").value) || 0.8,
            weight_action: parseFloat(document.getElementById("weight-action").value) || 1.0,
            weight_urgency: parseFloat(document.getElementById("weight-urgency").value) || 1.5,
            weight_security: parseFloat(document.getElementById("weight-security").value) || 1.2,
            weight_release: parseFloat(document.getElementById("weight-release").value) || 0.8,
            weight_decision: parseFloat(document.getElementById("weight-decision").value) || 1.1,
            
            // Detection flags (3 checkboxes)
            detect_codes: document.getElementById("global-detect-codes").checked,
            detect_documents: document.getElementById("global-detect-documents").checked,
            prioritize_pinned: document.getElementById("global-prioritize-pinned").checked,
            
            enabled: true  // Default enabled
        };
        
        // Add ID if editing existing profile
        if (!isNewProfile) {
            profileData.id = parseInt(profileId);
        }
        
        // Extract digest schedules (up to 3)
        const digestSchedules = [];
        for (let i = 1; i <= 3; i++) {
            const scheduleType = document.getElementById(`digest-schedule-${i}-type`).value;
            if (!scheduleType) continue;
            
            const schedule = {
                schedule_type: scheduleType,
                top_n: parseInt(document.getElementById(`digest-schedule-${i}-top-n`).value) || (10 * i),
                min_score: parseFloat(document.getElementById(`digest-schedule-${i}-min-score`).value) || (6.0 - i)
            };
            
            if (scheduleType === 'daily') {
                schedule.daily_hour = parseInt(document.getElementById(`digest-schedule-${i}-daily-hour`).value) || 8;
            } else if (scheduleType === 'weekly') {
                schedule.weekly_day = parseInt(document.getElementById(`digest-schedule-${i}-weekly-day`).value) || 0;
                schedule.weekly_hour = parseInt(document.getElementById(`digest-schedule-${i}-weekly-hour`).value) || 8;
            }
            
            digestSchedules.push(schedule);
        }
        profileData.digest_schedules = digestSchedules;
        
        // Digest delivery settings
        profileData.digest_mode = document.getElementById("digest-mode").value || "dm";
        profileData.digest_target_channel = document.getElementById("digest-target-channel").value.trim();
        
        if (!profileData.name) {
            showToast("Profile name is required", "warning");
            return;
        }
        
        try {
            const response = await fetch(globalProfileEndpoints.upsert, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(profileData)
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || "Failed to save global profile");
            }
            
            const result = await response.json();
            showToast(isNewProfile ? "Profile created" : "Profile updated", "success");
            
            // Reload profiles list
            await loadGlobalProfiles();
            
            // If new profile, update form with generated ID, otherwise reset
            if (isNewProfile && result.profile_id) {
                document.getElementById("global-profile-id-input").value = result.profile_id;
                document.getElementById("global-profile-id").value = result.profile_id;
                document.getElementById("btn-delete-global-profile").classList.remove("d-none");
            } else {
                resetGlobalProfileForm();
            }
        } catch (error) {
            console.error("Failed to save global profile:", error);
            showToast("Failed to save global profile: " + error.message, "error");
        }
    }
    
    // Helper function to parse textarea lines into array
    function parseTextareaLines(text) {
        if (!text || text.trim() === "") return [];
        return text.split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0);
    }
    
    function resetGlobalProfileForm() {
        document.getElementById("global-profile-form").reset();
        document.getElementById("global-profile-id-input").value = "";
        document.getElementById("global-threshold").value = "0.7";
        document.getElementById("weight-keywords").value = "0.8";
        document.getElementById("weight-heuristics").value = "1.0";
        document.getElementById("weight-semantic").value = "0.5";
        document.getElementById("global-enabled").value = "true";
        
        // Clear digest configuration fields
        populateDigestConfigInForm(null, 'global-');
        
        document.getElementById("global-save-btn-text").textContent = "Save Profile";
        document.getElementById("btn-delete-global-profile").classList.add("d-none");
        
        // Remove active state from profile list
        document.querySelectorAll(".global-profile-item").forEach(item => {
            item.classList.remove("active");
        });
    }
    
    async function deleteGlobalProfile() {
        const profileId = document.getElementById("global-profile-id-input").value;
        if (!profileId) return;
        
        const profileName = document.getElementById("global-profile-name").value;
        if (!confirm(`Delete profile "${profileName}"?`)) return;
        
        try {
            const response = await fetch(globalProfileEndpoints.delete(profileId), {
                method: "DELETE"
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || "Failed to delete global profile");
            }
            
            showToast("Profile deleted", "success");
            resetGlobalProfileForm();
            await loadGlobalProfiles();
        } catch (error) {
            console.error("Failed to delete global profile:", error);
            showToast("Failed to delete global profile: " + error.message, "error");
        }
    }
    
    async function backtestGlobalProfile() {
        const profileId = document.getElementById("global-profile-id").value;
        if (!profileId) {
            showToast("Please select a profile first", "warning");
            return;
        }
        
        const modalEl = document.getElementById('backtestModal');
        const modal = new bootstrap.Modal(modalEl);
        
        // Apply glass backdrop effect
        const addGlassClass = () => {
            setTimeout(() => {
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop && !backdrop.classList.contains('glass-backdrop')) {
                    backdrop.classList.add('glass-backdrop');
                }
            }, 50);
        };
        
        modalEl.addEventListener('shown.bs.modal', addGlassClass, { once: true });
        modalEl.addEventListener('show.bs.modal', addGlassClass, { once: true });
        
        modal.show();
        
        // Show loading state
        document.getElementById('backtest-loading').classList.remove('d-none');
        document.getElementById('backtest-results').classList.add('d-none');
        document.getElementById('backtest-error').classList.add('d-none');
        
        try {
            const hours = parseInt(document.getElementById('backtestHoursBack').value) || 24;
            const maxMsgs = parseInt(document.getElementById('backtestMaxMessages').value) || 100;
            
            const response = await fetch('/api/profiles/global/backtest', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: profileId,
                    hours_back: hours,
                    max_messages: maxMsgs
                })
            });
            
            const result = await response.json();
            
            if (result.status === 'ok') {
                // Hide loading, show results
                document.getElementById('backtest-loading').classList.add('d-none');
                document.getElementById('backtest-results').classList.remove('d-none');
                
                // Update stats
                document.getElementById('stat-total-messages').textContent = result.stats.total_messages;
                document.getElementById('stat-matched').textContent = result.stats.matched_messages;
                document.getElementById('stat-match-rate').textContent = result.stats.match_rate + '%';
                document.getElementById('stat-avg-score').textContent = result.stats.avg_score;
                
                // Update recommendations
                const recsEl = document.getElementById('backtest-recommendations');
                const recsList = document.getElementById('recommendations-list');
                if (result.recommendations && result.recommendations.length > 0) {
                    recsList.innerHTML = result.recommendations.map(r => `<li>${escapeHtml(r)}</li>`).join('');
                    recsEl.classList.remove('d-none');
                } else {
                    recsEl.classList.add('d-none');
                }
                
                // Update match list (table)
                const tbody = document.getElementById('backtest-matches-tbody');
                if (result.matches && result.matches.length > 0) {
                    tbody.innerHTML = result.matches.map(m => `
                        <tr>
                            <td>${escapeHtml(m.chat_title || 'Unknown')}</td>
                            <td>${m.message_id}</td>
                            <td><span class="badge bg-primary">${m.score.toFixed(2)}</span></td>
                            <td><small>${escapeHtml((m.triggers || []).join(', '))}</small></td>
                            <td>${m.would_alert ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
                            <td><small>${escapeHtml((m.text_preview || '').substring(0, 100))}</small></td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No matches found</td></tr>';
                }
            } else {
                throw new Error(result.message || 'Backtest failed');
            }
        } catch (error) {
            console.error('Backtest error:', error);
            document.getElementById('backtest-loading').classList.add('d-none');
            document.getElementById('backtest-error').textContent = `Backtest failed: ${error.message}`;
            document.getElementById('backtest-error').classList.remove('d-none');
        }
    }
    
    async function bulkToggleGlobalProfiles(enabled) {
        if (!confirm(`Are you sure you want to ${enabled ? 'enable' : 'disable'} all global profiles?`)) {
            return;
        }
        
        showToast(`${enabled ? 'Enabling' : 'Disabling'} all global profiles...`, "info");
        
        try {
            // Get all profile IDs from the list
            const profileCards = document.querySelectorAll('[id^="global-profile-card-"]');
            let successCount = 0;
            let errorCount = 0;
            
            for (const card of profileCards) {
                const profileId = card.id.replace('global-profile-card-', '');
                const toggle = card.querySelector('.form-check-input');
                
                if (toggle && toggle.checked !== enabled) {
                    try {
                        const response = await fetch(`/api/profiles/global/${profileId}/toggle`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ enabled: enabled })
                        });
                        
                        if (response.ok) {
                            toggle.checked = enabled;
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (err) {
                        console.error(`Error toggling global profile ${profileId}:`, err);
                        errorCount++;
                    }
                }
            }
            
            if (errorCount === 0) {
                showToast(`Successfully ${enabled ? 'enabled' : 'disabled'} ${successCount} global profiles`, "success");
            } else {
                showToast(`${enabled ? 'Enabled' : 'Disabled'} ${successCount} profiles, ${errorCount} failed`, "warning");
            }
            
            // Reload profiles to reflect changes
            loadGlobalProfiles();
        } catch (error) {
            console.error('Bulk toggle error:', error);
            showToast("Error performing bulk toggle: " + error.message, "error");
        }
    }
    
    function exportAllGlobalProfiles() {
        // Trigger the existing export button
        const exportBtn = document.getElementById('btn-export-global-profiles');
        if (exportBtn) {
            exportBtn.click();
        } else {
            showToast("Export button not found", "error");
        }
    }

    // ============= INTEREST PROFILES FUNCTIONS =============
    
    async function loadInterestProfiles() {
        try {
            const response = await fetch(interestProfileEndpoints.list);
            if (!response.ok) throw new Error("Failed to load interest profiles");
            const data = await response.json();
            
            allInterestProfiles = data.profiles || [];
            filteredInterestProfiles = [...allInterestProfiles];
            
            // Update profile count
            const countEl = document.getElementById("interest-profiles-count");
            if (countEl) {
                countEl.textContent = allInterestProfiles.length;
            }
            
            renderInterestProfiles(filteredInterestProfiles);
        } catch (error) {
            console.error("Failed to load interest profiles:", error);
            showToast("Failed to load interest profiles", "error");
        }
    }
    
    function renderInterestProfiles(profiles) {
        const listEl = document.getElementById("interest-profiles-list");
        if (!listEl) return;
        
        if (!profiles || profiles.length === 0) {
            listEl.innerHTML = `
                <div class="alert-profiles-empty">
                    <svg fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                    </svg>
                    <p class="mb-2">No interest profiles yet</p>
                    <small>Create your first profile to get started</small>
                </div>
            `;
            return;
        }
        
        listEl.innerHTML = profiles.map(profile => {
            const isEnabled = profile.enabled !== false;
            const scheduleCount = (profile.digest_schedules || []).length;
            
            return `
                <button type="button" class="list-group-item list-group-item-action alert-profile-item ${currentInterestProfile && currentInterestProfile.id === profile.id ? 'active' : ''}" 
                        data-profile-id="${profile.id}"
                        onclick="selectInterestProfile(${profile.id})">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1 min-w-0 me-2">
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <h6 class="mb-0 text-truncate">${escapeHtml(profile.name)}</h6>
                                <span class="badge ${isEnabled ? 'bg-success' : 'bg-secondary'} badge-sm">${isEnabled ? 'ON' : 'OFF'}</span>
                            </div>
                            ${profile.description ? `<p class="mb-1 small text-muted text-truncate">${escapeHtml(profile.description)}</p>` : ''}
                            <div class="d-flex gap-2 flex-wrap">
                                <small class="text-muted">ID: ${profile.id}</small>
                                ${(profile.keywords || []).length > 0 ? `<small class="text-muted">üîë ${profile.keywords.length}</small>` : ''}
                                ${scheduleCount > 0 ? `<small class="text-muted">üìÖ ${scheduleCount}</small>` : ''}
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="form-check form-switch mb-0" onclick="event.stopPropagation()">
                                <input class="form-check-input" type="checkbox" 
                                       ${isEnabled ? 'checked' : ''}
                                       onchange="toggleInterestProfile(${profile.id}, event)"
                                       title="Enable/Disable">
                            </div>
                        </div>
                    </div>
                </button>
            `;
        }).join('');
    }
    
    async function selectInterestProfile(profileId) {
        try {
            const response = await fetch(`${interestProfileEndpoints.get}/${profileId}`);
            if (!response.ok) throw new Error("Failed to load profile");
            
            const data = await response.json();
            const profile = data.profile;
            
            currentInterestProfile = profile;
            
            // Update form fields
            document.getElementById("interest-profile-id").value = profile.id || "";
            document.getElementById("interest-profile-id-display").value = profile.id || "Auto-generated";
            document.getElementById("topic-name").value = profile.name || "";
            document.getElementById("topic-description").value = profile.description || "";
            
            // Samples
            document.getElementById("positive-samples").value = (profile.positive_samples || []).join("\n");
            document.getElementById("negative-samples").value = (profile.negative_samples || []).join("\n");
            
            // Advanced fields
            document.getElementById("similarity-threshold").value = profile.threshold || 0.42;
            document.getElementById("profile-weight").value = profile.weight || 1.0;
            document.getElementById("profile-enabled").value = profile.enabled !== false ? "true" : "false";
            document.getElementById("profile-priority").value = profile.priority || "normal";
            document.getElementById("profile-keywords").value = (profile.keywords || []).join(", ");
            
            // Set channel and user selections using the helper function
            setSelectedEntityIds('interest', profile.channels || [], profile.users || []);
            
            document.getElementById("profile-tags").value = (profile.tags || []).join(", ");
            document.getElementById("profile-notify-always").checked = profile.notify_always || false;
            document.getElementById("profile-include-in-digest").checked = profile.include_digest !== false;
            
            // Digest schedules
            populateInterestDigestSchedules(profile.digest_schedules || []);
            document.getElementById("interest-digest-mode").value = profile.digest_mode || "dm";
            document.getElementById("interest-digest-target-channel").value = profile.digest_target_channel || "";
            
            // Update UI state
            document.getElementById("btn-delete-interest-profile")?.classList.remove("d-none");
            
            // Highlight in list
            renderInterestProfiles(filteredInterestProfiles);
            
            showToast(`Loaded: ${profile.name}`, "info");
        } catch (error) {
            console.error("Failed to select profile:", error);
            showToast("Failed to load profile", "error");
        }
    }
    
    async function saveInterestProfile(event) {
        event.preventDefault();
        
        const profileId = document.getElementById("interest-profile-id").value;
        const name = document.getElementById("topic-name").value.trim();
        
        if (!name) {
            showToast("Profile name is required", "warning");
            return;
        }
        
        // Collect all form data
        const profileData = {
            id: profileId ? parseInt(profileId) : undefined,
            name: name,
            description: document.getElementById("topic-description").value.trim(),
            enabled: document.getElementById("profile-enabled").value === "true",
            positive_samples: document.getElementById("positive-samples").value
                .split("\n").map(s => s.trim()).filter(s => s),
            negative_samples: document.getElementById("negative-samples").value
                .split("\n").map(s => s.trim()).filter(s => s),
            threshold: parseFloat(document.getElementById("similarity-threshold").value) || 0.42,
            weight: parseFloat(document.getElementById("profile-weight").value) || 1.0,
            priority: document.getElementById("profile-priority").value,
            keywords: document.getElementById("profile-keywords").value
                .split(",").map(s => s.trim()).filter(s => s),
            channels: getSelectedEntityIds('interest', 'channels'),
            users: getSelectedEntityIds('interest', 'users'),
            tags: document.getElementById("profile-tags").value
                .split(",").map(s => s.trim()).filter(s => s),
            notify_always: document.getElementById("profile-notify-always").checked,
            include_digest: document.getElementById("profile-include-in-digest").checked,
            digest_schedules: extractInterestDigestSchedules(),
            digest_mode: document.getElementById("interest-digest-mode").value,
            digest_target_channel: document.getElementById("interest-digest-target-channel").value.trim()
        };
        
        try {
            const response = await fetch(interestProfileEndpoints.upsert, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(profileData)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || "Failed to save profile");
            }
            
            const result = await response.json();
            showToast(profileId ? "Profile updated" : "Profile created", "success");
            
            // Reload list and select the profile
            await loadInterestProfiles();
            if (result.profile_id) {
                await selectInterestProfile(result.profile_id);
            }
        } catch (error) {
            console.error("Failed to save profile:", error);
            showToast(error.message || "Failed to save profile", "error");
        }
    }
    
    async function deleteInterestProfile() {
        const profileId = document.getElementById("interest-profile-id").value;
        const profileName = document.getElementById("topic-name").value;
        
        if (!profileId) {
            showToast("No profile selected", "warning");
            return;
        }
        
        if (!confirm(`Delete profile "${profileName}"?`)) {
            return;
        }
        
        try {
            const response = await fetch(`${interestProfileEndpoints.delete}/${profileId}`, {
                method: "DELETE"
            });
            
            if (!response.ok) throw new Error("Failed to delete profile");
            
            showToast("Profile deleted", "success");
            resetInterestProfileForm();
            await loadInterestProfiles();
        } catch (error) {
            console.error("Failed to delete profile:", error);
            showToast("Failed to delete profile", "error");
        }
    }
    
    async function toggleInterestProfile(profileId, event) {
        event.stopPropagation();
        
        try {
            const response = await fetch(`${interestProfileEndpoints.toggle}/${profileId}/toggle`, {
                method: "POST"
            });
            
            if (!response.ok) throw new Error("Failed to toggle profile");
            
            const data = await response.json();
            showToast(`Profile ${data.enabled ? 'enabled' : 'disabled'}`, "success");
            
            // Reload list
            await loadInterestProfiles();
        } catch (error) {
            console.error("Failed to toggle profile:", error);
            showToast("Failed to toggle profile", "error");
            // Revert checkbox
            event.target.checked = !event.target.checked;
        }
    }
    
    function resetInterestProfileForm() {
        currentInterestProfile = null;
        document.getElementById("interest-profile-id").value = "";
        document.getElementById("interest-profile-id-display").value = "Auto-generated";
        document.getElementById("topic-name").value = "";
        document.getElementById("topic-description").value = "";
        document.getElementById("positive-samples").value = "";
        document.getElementById("negative-samples").value = "";
        document.getElementById("similarity-threshold").value = "0.42";
        document.getElementById("profile-weight").value = "1.0";
        document.getElementById("profile-enabled").value = "true";
        document.getElementById("profile-priority").value = "normal";
        document.getElementById("profile-keywords").value = "";
        document.getElementById("profile-channels").value = "";
        document.getElementById("profile-tags").value = "";
        document.getElementById("profile-notify-always").checked = false;
        document.getElementById("profile-include-in-digest").checked = true;
        
        // Clear digest schedules
        for (let i = 1; i <= 3; i++) {
            document.getElementById(`interest-digest-schedule-${i}-type`).value = "";
            document.getElementById(`interest-digest-schedule-${i}-top-n`).value = 10 * i;
            document.getElementById(`interest-digest-schedule-${i}-min-score`).value = 6.0 - i;
        }
        
        document.getElementById("interest-digest-mode").value = "dm";
        document.getElementById("interest-digest-target-channel").value = "";
        document.getElementById("btn-delete-interest-profile")?.classList.add("d-none");
        
        renderInterestProfiles(filteredInterestProfiles);
    }
    
    function filterInterestProfiles(searchTerm) {
        if (!searchTerm || searchTerm.trim() === "") {
            filteredInterestProfiles = [...allInterestProfiles];
        } else {
            const lowerSearch = searchTerm.toLowerCase();
            filteredInterestProfiles = allInterestProfiles.filter(profile => {
                const name = (profile.name || "").toLowerCase();
                const description = (profile.description || "").toLowerCase();
                return name.includes(lowerSearch) || description.includes(lowerSearch);
            });
        }
        renderInterestProfiles(filteredInterestProfiles);
    }
    
    function extractInterestDigestSchedules() {
        const schedules = [];
        for (let i = 1; i <= 3; i++) {
            const type = document.getElementById(`interest-digest-schedule-${i}-type`).value;
            if (!type) continue;
            
            const schedule = {
                schedule_type: type,
                top_n: parseInt(document.getElementById(`interest-digest-schedule-${i}-top-n`).value) || 10,
                min_score: parseFloat(document.getElementById(`interest-digest-schedule-${i}-min-score`).value) || 5.0
            };
            
            if (type === 'daily') {
                schedule.daily_hour = parseInt(document.getElementById(`interest-digest-schedule-${i}-daily-hour`).value) || 8;
            } else if (type === 'weekly') {
                schedule.weekly_day = parseInt(document.getElementById(`interest-digest-schedule-${i}-weekly-day`).value) || 0;
                schedule.weekly_hour = parseInt(document.getElementById(`interest-digest-schedule-${i}-weekly-hour`).value) || 8;
            }
            
            schedules.push(schedule);
        }
        return schedules;
    }
    
    function populateInterestDigestSchedules(schedules) {
        // Clear all first
        for (let i = 1; i <= 3; i++) {
            document.getElementById(`interest-digest-schedule-${i}-type`).value = "";
            document.getElementById(`interest-digest-schedule-${i}-top-n`).value = 10 * i;
            document.getElementById(`interest-digest-schedule-${i}-min-score`).value = 6.0 - i;
        }
        
        // Populate provided schedules
        schedules.forEach((schedule, index) => {
            if (index >= 3) return;
            const i = index + 1;
            document.getElementById(`interest-digest-schedule-${i}-type`).value = schedule.schedule_type || "";
            document.getElementById(`interest-digest-schedule-${i}-top-n`).value = schedule.top_n || 10;
            document.getElementById(`interest-digest-schedule-${i}-min-score`).value = schedule.min_score || 5.0;
            
            if (schedule.schedule_type === 'daily') {
                document.getElementById(`interest-digest-schedule-${i}-daily-hour`).value = schedule.daily_hour || 8;
            } else if (schedule.schedule_type === 'weekly') {
                document.getElementById(`interest-digest-schedule-${i}-weekly-day`).value = schedule.weekly_day || 0;
                document.getElementById(`interest-digest-schedule-${i}-weekly-hour`).value = schedule.weekly_hour || 8;
            }
        });
    }
    
    async function backtestInterestProfile() {
        const profileId = document.getElementById("interest-profile-id").value;
        if (!profileId) {
            showToast("Please select a profile first", "warning");
            return;
        }
        
        showToast("Backtest functionality coming soon", "info");
    }

    // Legacy functions kept for backwards compatibility
    
    async function loadInterestProfile(profileName) {
        // Legacy function - redirect to new ID-based function
        const profile = allInterestProfiles.find(p => p.name === profileName);
        if (profile) {
            await selectInterestProfile(profile.id);
        }
    }

    async function bulkToggleInterestProfiles(enabled) {
        const profileName = document.getElementById("original-name").value || document.getElementById("topic-name").value;
        if (!profileName) {
            showToast("Please select or save a profile first", "warning");
            return;
        }
        
        const modalEl = document.getElementById('backtestModal');
        const modal = new bootstrap.Modal(modalEl);
        
        // Apply glass backdrop effect
        const addGlassClass = () => {
            setTimeout(() => {
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop && !backdrop.classList.contains('glass-backdrop')) {
                    backdrop.classList.add('glass-backdrop');
                }
            }, 50);
        };
        
        modalEl.addEventListener('shown.bs.modal', addGlassClass, { once: true });
        modalEl.addEventListener('show.bs.modal', addGlassClass, { once: true });
        
        modal.show();
        
        document.getElementById('backtest-loading').classList.remove('d-none');
        document.getElementById('backtest-results').classList.add('d-none');
        document.getElementById('backtest-error').classList.add('d-none');
        
        try {
            const response = await fetch(interestProfileEndpoints.backtest, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    name: profileName,
                    hours_back: 24,
                    max_messages: 100
                })
            });
            
            if (!response.ok) throw new Error("Backtest failed");
            const data = await response.json();
            
            // Display results (same as Alert Profiles)
            document.getElementById('backtest-loading').classList.add('d-none');
            document.getElementById('backtest-results').classList.remove('d-none');
            
            // Statistics
            document.getElementById('stat-total-messages').textContent = data.stats.total_messages || 0;
            document.getElementById('stat-matched').textContent = data.stats.matched_messages || 0;
            document.getElementById('stat-match-rate').textContent = (data.stats.match_rate || 0).toFixed(1) + '%';
            document.getElementById('stat-avg-score').textContent = (data.stats.avg_score || data.stats.average_score || 0).toFixed(2);
            
            // Recommendations
            const recsList = document.getElementById('recommendations-list');
            if (data.recommendations && data.recommendations.length > 0) {
                recsList.innerHTML = data.recommendations.map(r => `<li>${escapeHtml(r)}</li>`).join('');
            } else {
                recsList.innerHTML = '<li>Profile is working well!</li>';
            }
            
            // Matches table
            const tbody = document.getElementById('backtest-matches-tbody');
            if (data.matches && data.matches.length > 0) {
                tbody.innerHTML = data.matches.map(match => `
                    <tr>
                        <td>${escapeHtml(match.chat_title || 'Unknown')}</td>
                        <td>${match.message_id}</td>
                        <td><span class="badge bg-primary">${match.score.toFixed(2)}</span></td>
                        <td><small>${escapeHtml((match.triggers || []).join(', '))}</small></td>
                        <td>${match.would_alert ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
                        <td><small>${escapeHtml((match.text_preview || '').substring(0, 100))}</small></td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No matches found</td></tr>';
            }
        } catch (error) {
            console.error("Backtest failed:", error);
            document.getElementById('backtest-loading').classList.add('d-none');
            document.getElementById('backtest-error').textContent = `Backtest failed: ${error.message}`;
            document.getElementById('backtest-error').classList.remove('d-none');
        }
    }
    
    async function bulkToggleInterestProfiles(enabled) {
        if (!confirm(`Are you sure you want to ${enabled ? 'enable' : 'disable'} all interest profiles?`)) {
            return;
        }
        
        const profiles = Array.from(document.querySelectorAll('.profile-toggle'));
        let successCount = 0;
        let failCount = 0;
        
        for (const toggle of profiles) {
            const profileName = toggle.dataset.profile;
            try {
                const response = await fetch(interestProfileEndpoints.toggle, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: profileName, enabled })
                });
                
                if (response.ok) {
                    successCount++;
                    toggle.checked = enabled;
                } else {
                    failCount++;
                }
            } catch (error) {
                failCount++;
                console.error(`Failed to toggle profile ${profileName}:`, error);
            }
        }
        
        showToast(
            `${successCount} profiles ${enabled ? 'enabled' : 'disabled'}${failCount > 0 ? `, ${failCount} failed` : ''}`, 
            failCount > 0 ? 'warning' : 'success'
        );
        
        // Reload page to reflect changes
        setTimeout(() => window.location.reload(), 1000);
    }
    
    function exportAllInterestProfiles() {
        // Trigger existing export button
        const exportBtn = document.getElementById('btn-export-profiles');
        if (exportBtn) {
            exportBtn.click();
        }
    }
    
    async function loadInterestProfile(profileName) {
        try {
            const response = await fetch(`${interestProfileEndpoints.load}?name=${encodeURIComponent(profileName)}`);
            if (!response.ok) {
                throw new Error("Failed to load profile");
            }
            const data = await response.json();
            
            // Set form mode to edit
            document.getElementById("profile-mode").value = "edit";
            document.getElementById("original-name").value = profileName;
            currentProfile = profileName;
            
            // Populate form fields
            document.getElementById("topic-name").value = data.name || profileName;
            document.getElementById("topic-description").value = data.description || "";
            document.getElementById("positive-samples").value = (data.positive_samples || []).join("\n");
            document.getElementById("negative-samples").value = (data.negative_samples || []).join("\n");
            
            // Advanced fields
            document.getElementById("similarity-threshold").value = data.threshold || 0.42;
            document.getElementById("profile-weight").value = data.weight || 1.0;
            document.getElementById("profile-enabled").value = data.enabled !== false ? "true" : "false";
            document.getElementById("profile-priority").value = data.priority || "normal";
            document.getElementById("profile-keywords").value = (data.keywords || []).join(", ");
            document.getElementById("profile-channels").value = (data.channels || []).join(", ");
            document.getElementById("profile-tags").value = (data.tags || []).join(", ");
            document.getElementById("profile-notify-always").checked = data.notify_always || false;
            document.getElementById("profile-include-in-digest").checked = data.include_digest !== false;
            
            // Populate digest configuration if exists (Interest Profiles use 'interest-' prefix)
            if (data.digest_config) {
                populateDigestConfigInForm(data.digest_config, 'interest-');
            } else {
                populateDigestConfigInForm(null, 'interest-');
            }
            
            // Update UI
            document.getElementById("save-btn-text").textContent = "Update Profile";
            document.getElementById("btn-delete-profile").classList.remove("d-none");
            
            // Highlight active profile card
            document.querySelectorAll(".profile-card").forEach(card => {
                card.classList.remove("active");
            });
            const activeCard = document.querySelector(`.profile-card[data-profile="${profileName}"]`);
            if (activeCard) {
                activeCard.classList.add("active");
            }
            
            // Scroll to form
            document.getElementById("profile-editor-heading").scrollIntoView({ behavior: "smooth", block: "start" });
            
            appendLog(`Loaded profile: ${profileName}`);
            showToast(`Editing: ${profileName}`, "info");
        } catch (error) {
            console.error("Failed to load profile:", error);
            showToast("Failed to load profile", "error");
        }
    }

    // Save profile (create or update)
    async function saveProfile(event) {
        event.preventDefault();
        
        const submitBtn = document.getElementById("btn-save-profile");
        const submitText = document.getElementById("save-btn-text");
        
        // Guard against duplicate submissions
        if (submitBtn.disabled) {
            return;
        }
        
        const mode = document.getElementById("profile-mode").value;
        const topicName = document.getElementById("topic-name").value.trim();
        
        if (!topicName) {
            showToast("Topic name is required", "warning");
            return;
        }
        
        const profileData = {
            name: topicName,
            description: document.getElementById("topic-description").value.trim(),
            positive_samples: document.getElementById("positive-samples").value
                .split("\n")
                .map(s => s.trim())
                .filter(s => s),
            negative_samples: document.getElementById("negative-samples").value
                .split("\n")
                .map(s => s.trim())
                .filter(s => s),
            threshold: parseFloat(document.getElementById("similarity-threshold").value) || 0.42,
            weight: parseFloat(document.getElementById("profile-weight").value) || 1.0,
            enabled: document.getElementById("profile-enabled").value === "true",
            priority: document.getElementById("profile-priority").value,
            keywords: document.getElementById("profile-keywords").value
                .split(",")
                .map(s => s.trim())
                .filter(s => s),
            channels: document.getElementById("profile-channels").value
                .split(",")
                .map(s => s.trim())
                .filter(s => s),
            tags: document.getElementById("profile-tags").value
                .split(",")
                .map(s => s.trim())
                .filter(s => s),
            notify_always: document.getElementById("profile-notify-always").checked,
            include_digest: document.getElementById("profile-include-in-digest").checked
        };
        
        // Extract digest configuration from form (Interest Profiles use 'interest-' prefix)
        const digestConfig = extractDigestConfigFromForm('interest-');
        if (digestConfig && digestConfig.schedules && digestConfig.schedules.length > 0) {
            profileData.digest_config = digestConfig;
        }
        
        if (mode === "edit") {
            profileData.original_name = document.getElementById("original-name").value;
        }
        
        // Disable button and show loading state
        submitBtn.disabled = true;
        const originalText = submitText.textContent;
        submitText.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
        
        try {
            const response = await fetch(interestProfileEndpoints.save, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(profileData)
            });
            
            if (!response.ok) {
                throw new Error("Failed to save profile");
            }
            
            await response.json();
            appendLog(`Profile saved: ${topicName}`);
            showToast(mode === "edit" ? "Profile updated" : "Profile created", "success");
            
            // Re-enable button
            submitBtn.disabled = false;
            submitText.textContent = originalText;
            
            // Reload the profiles list instead of the entire page
            setTimeout(() => {
                loadProfiles();
                if (mode !== "edit") {
                    resetForm();
                }
            }, 1000);
        } catch (error) {
            console.error("Failed to save profile:", error);
            showToast("Failed to save profile", "error");
        } finally {
            // Always re-enable button in error path
            submitBtn.disabled = false;
            submitText.textContent = originalText;
        }
    }

    // Delete profile
    async function deleteProfile() {
        const profileName = document.getElementById("original-name").value;
        
        if (!profileName) {
            showToast("No profile selected", "warning");
            return;
        }
        
        if (!confirm(`Are you sure you want to delete the profile "${profileName}"?`)) {
            return;
        }
        
        try {
            const response = await fetch(interestProfileEndpoints.delete, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: profileName })
            });
            
            if (!response.ok) {
                throw new Error("Failed to delete profile");
            }
            
            appendLog(`Profile deleted: ${profileName}`);
            showToast("Profile deleted", "success");
            
            // Reload page
            setTimeout(() => window.location.reload(), 1000);
        } catch (error) {
            console.error("Failed to delete profile:", error);
            showToast("Failed to delete profile", "error");
        }
    }

    // Reset form to create mode
    function resetForm() {
        document.getElementById("profile-form").reset();
        document.getElementById("profile-mode").value = "create";
        document.getElementById("original-name").value = "";
        document.getElementById("save-btn-text").textContent = "Save Profile";
        document.getElementById("btn-delete-profile").classList.add("d-none");
        currentInterestProfile = null;
        
        // Remove active state from cards
        document.querySelectorAll(".profile-card").forEach(card => {
            card.classList.remove("active");
        });
        
        // Reset advanced fields to defaults
        document.getElementById("similarity-threshold").value = 0.42;
        document.getElementById("profile-weight").value = 1.0;
        document.getElementById("profile-enabled").value = "true";
        document.getElementById("profile-priority").value = "normal";
        document.getElementById("profile-notify-always").checked = false;
        document.getElementById("profile-include-in-digest").checked = true;
        
        // Clear digest configuration fields (Interest Profiles use 'interest-' prefix)
        populateDigestConfigInForm(null, 'interest-');
        
        appendLog("Form reset to create new profile");
    }

    async function runSimilarityTest() {
        const sample = document.getElementById("test-phrase").value.trim();
        if (!sample) {
            showToast("Enter a phrase to test", "warning");
            return;
        }
        
        const selectEl = document.getElementById("profile-select");
        if (!selectEl) {
            console.error("Profile select element not found");
            showToast("Profile selector unavailable", "error");
            return;
        }
        
        const interest = selectEl.value?.trim();
        if (!interest) {
            showToast("Select an interest profile", "warning");
            return;
        }
        
        try {
            const response = await fetch(interestProfileEndpoints.test, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sample, interest }),
            });
            if (!response.ok) {
                throw new Error("Test failed");
            }
            const payload = await response.json();
            if (typeof payload !== "object" || payload === null) {
                console.warn("Unexpected similarity payload", payload);
                throw new Error("Malformed response");
            }
            const score = Number(payload.score);
            if (!Number.isFinite(score)) {
                console.warn("Similarity score missing or invalid", payload);
                throw new Error("Invalid score");
            }
            
            if (score < 0 || score > 1) {
                console.warn(
                    `Similarity score out of range [0,1]: ${score} for sample "${sample}" against interest "${interest}"`
                );
            }
            
            const clamped = Math.max(0, Math.min(score, 1));
            const formatted = clamped.toFixed(2);
            const resultEl = document.getElementById("test-result");
            if (resultEl) {
                resultEl.textContent = `Score: ${formatted}`;
            }
            appendLog(`Similarity test for "${sample}" ‚Üí ${formatted}`);
        } catch (error) {
            console.error(error);
            showToast("Unable to compute similarity", "error");
        }
    }

    function appendLog(message) {
        const log = document.getElementById("profile-log");
        if (!log) return;
        
        const entry = document.createElement("div");
        entry.className = "log-entry";
        const time = document.createElement("span");
        time.className = "log-time";
        time.textContent = new Date().toLocaleTimeString();

        const spacer = document.createTextNode(" ");

        const msg = document.createElement("span");
        msg.className = "log-message";
        msg.textContent = String(message ?? "");

        entry.appendChild(time);
        entry.appendChild(spacer);
        entry.appendChild(msg);
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    }

    // ============= UTILITY FUNCTIONS =============
    
    function parseCSV(str) {
        return str.split(",").map(s => s.trim()).filter(s => s);
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    async function bulkToggleAlertProfiles(enabled) {
        if (!confirm(`Are you sure you want to ${enabled ? 'enable' : 'disable'} all profiles?`)) {
            return;
        }
        
        // Create AbortController with timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        try {
            // Build array of fetch promises
            const togglePromises = allAlertProfiles.map(profile =>
                fetch(alertProfileEndpoints.toggle, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: profile.id, enabled }),
                    signal: controller.signal
                })
                .then(response => ({ profile, response, success: response.ok }))
                .catch(error => ({ profile, error, success: false }))
            );
            
            // Wait for all requests to complete
            const results = await Promise.allSettled(togglePromises);
            
            // Process results and count successes/failures
            let successCount = 0;
            let failCount = 0;
            
            results.forEach(result => {
                if (result.status === 'fulfilled') {
                    const { profile, success, error } = result.value;
                    if (success) {
                        successCount++;
                    } else {
                        failCount++;
                        console.error(`Failed to toggle profile ${profile.id}:`, error || 'Request failed');
                    }
                } else {
                    // Promise was rejected
                    failCount++;
                    console.error('Toggle request failed:', result.reason);
                }
            });
            
            // Show consolidated toast
            showToast(
                `${successCount} profiles ${enabled ? 'enabled' : 'disabled'}${failCount > 0 ? `, ${failCount} failed` : ''}`, 
                failCount > 0 ? 'warning' : 'success'
            );
            
        } catch (error) {
            console.error('Bulk toggle operation failed:', error);
            showToast('Bulk toggle operation failed', 'error');
        } finally {
            clearTimeout(timeoutId);
        }
        
        // Reload profiles after all requests complete
        await loadAlertProfiles();
    }
    
    function exportAllAlertProfiles() {
        const dataStr = JSON.stringify(allAlertProfiles, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `alert-profiles-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showToast(`Exported ${allAlertProfiles.length} profiles`, 'success');
    }

    // ============= INITIALIZATION =============
    
    document.addEventListener("DOMContentLoaded", () => {
        // Restore active tab from localStorage
        const savedTab = localStorage.getItem('profiles-active-tab');
        if (savedTab) {
            const tabTrigger = document.querySelector(`button[data-bs-target="${savedTab}"]`);
            if (tabTrigger) {
                const tab = new bootstrap.Tab(tabTrigger);
                tab.show();
            }
        }
        
        // Save active tab to localStorage on tab change
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tabButton => {
            tabButton.addEventListener('shown.bs.tab', (event) => {
                const targetTab = event.target.getAttribute('data-bs-target');
                localStorage.setItem('profiles-active-tab', targetTab);
            });
        });
        
        // Load alert profiles on page load
        loadAlertProfiles();
        
        // Alert Profile handlers
        document.getElementById("alert-profile-form")?.addEventListener("submit", saveAlertProfile);
        document.getElementById("btn-new-alert-profile")?.addEventListener("click", newAlertProfile);
        document.getElementById("btn-reset-alert-profile")?.addEventListener("click", resetAlertProfileForm);
        document.getElementById("btn-delete-alert-profile")?.addEventListener("click", deleteAlertProfile);
        document.getElementById("btn-backtest-alert-profile")?.addEventListener("click", backtestAlertProfile);
        
        // Search functionality
        const searchInput = document.getElementById("alert-profiles-search");
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener("input", (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterAlertProfiles(e.target.value);
                }, 300);
            });
        }
        
        // Bulk actions dropdown
        const bulkActionsBtn = document.getElementById("btn-alert-bulk-actions");
        if (bulkActionsBtn) {
            // Create dropdown once during initialization
            let dropdown = document.querySelector(".alert-bulk-dropdown");
            if (!dropdown) {
                dropdown = document.createElement("div");
                dropdown.className = "alert-bulk-dropdown";
                dropdown.innerHTML = `
                    <button class="alert-bulk-dropdown-item" data-action="enable-all">Enable All</button>
                    <button class="alert-bulk-dropdown-item" data-action="disable-all">Disable All</button>
                    <button class="alert-bulk-dropdown-item" data-action="export-all">Export All</button>
                `;
                bulkActionsBtn.parentElement.style.position = "relative";
                bulkActionsBtn.parentElement.appendChild(dropdown);
                
                // Add click handlers to dropdown items
                dropdown.querySelectorAll(".alert-bulk-dropdown-item").forEach(item => {
                    item.addEventListener("click", async (e) => {
                        e.stopPropagation();
                        const action = item.dataset.action;
                        dropdown.classList.remove("show");
                        
                        if (action === "enable-all") {
                            await bulkToggleAlertProfiles(true);
                        } else if (action === "disable-all") {
                            await bulkToggleAlertProfiles(false);
                        } else if (action === "export-all") {
                            exportAllAlertProfiles();
                        }
                    });
                });
            }
            
            // Button click handler - just toggle dropdown
            bulkActionsBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                dropdown.classList.toggle("show");
            });
            
            // Document-level click handler (registered once during initialization)
            const closeDropdownHandler = (e) => {
                const dropdown = document.querySelector(".alert-bulk-dropdown");
                if (dropdown && dropdown.classList.contains("show")) {
                    // Only close if clicking outside both the dropdown and the button
                    if (!dropdown.contains(e.target) && !bulkActionsBtn.contains(e.target)) {
                        dropdown.classList.remove("show");
                    }
                }
            };
            
            document.addEventListener("click", closeDropdownHandler);
        }
        
        // Interest Profile handlers
        loadInterestProfiles(); // Load on page load
        
        document.getElementById("interest-profile-form")?.addEventListener("submit", saveInterestProfile);
        document.getElementById("btn-new-interest-profile")?.addEventListener("click", resetInterestProfileForm);
        document.getElementById("btn-reset-interest-profile")?.addEventListener("click", resetInterestProfileForm);
        document.getElementById("btn-delete-interest-profile")?.addEventListener("click", deleteInterestProfile);
        document.getElementById("btn-run-test")?.addEventListener("click", runSimilarityTest);
        document.getElementById("btn-backtest-interest-profile")?.addEventListener("click", backtestInterestProfile);
        
        // Interest Profile search
        
        // Global Profile weight sliders - update displayed values
        const weightSliders = [
            { id: 'weight-keywords', displayId: 'weight-keywords-value' },
            { id: 'weight-action', displayId: 'weight-action-value' },
            { id: 'weight-urgency', displayId: 'weight-urgency-value' },
            { id: 'weight-security', displayId: 'weight-security-value' },
            { id: 'weight-release', displayId: 'weight-release-value' },
            { id: 'weight-decision', displayId: 'weight-decision-value' }
        ];
        
        weightSliders.forEach(({ id, displayId }) => {
            const slider = document.getElementById(id);
            const display = document.getElementById(displayId);
            if (slider && display) {
                slider.addEventListener('input', (e) => {
                    display.textContent = e.target.value;
                });
            }
        });
        
        // Load global profiles on page load
        loadGlobalProfiles();
        
        // Global Profile bulk actions dropdown
        const globalBulkActionsBtn = document.getElementById("btn-global-bulk-actions");
        if (globalBulkActionsBtn) {
            let globalDropdown = document.querySelector(".global-bulk-dropdown");
            if (!globalDropdown) {
                globalDropdown = document.createElement("div");
                globalDropdown.className = "alert-bulk-dropdown global-bulk-dropdown";
                globalDropdown.innerHTML = `
                    <button class="alert-bulk-dropdown-item" data-action="enable-all">Enable All</button>
                    <button class="alert-bulk-dropdown-item" data-action="disable-all">Disable All</button>
                    <button class="alert-bulk-dropdown-item" data-action="export-all">Export All</button>
                `;
                globalBulkActionsBtn.parentElement.style.position = "relative";
                globalBulkActionsBtn.parentElement.appendChild(globalDropdown);
                
                globalDropdown.querySelectorAll(".alert-bulk-dropdown-item").forEach(item => {
                    item.addEventListener("click", async (e) => {
                        e.stopPropagation();
                        const action = item.dataset.action;
                        globalDropdown.classList.remove("show");
                        
                        if (action === "enable-all") {
                            await bulkToggleGlobalProfiles(true);
                        } else if (action === "disable-all") {
                            await bulkToggleGlobalProfiles(false);
                        } else if (action === "export-all") {
                            exportAllGlobalProfiles();
                        }
                    });
                });
            }
            
            globalBulkActionsBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                globalDropdown.classList.toggle("show");
            });
            
            document.addEventListener("click", (e) => {
                if (globalDropdown.classList.contains("show")) {
                    if (!globalDropdown.contains(e.target) && !globalBulkActionsBtn.contains(e.target)) {
                        globalDropdown.classList.remove("show");
                    }
                }
            });
        }
        
        // Interest Profile handlers
        loadInterestProfiles(); // Load on page load
        
        document.getElementById("interest-profile-form")?.addEventListener("submit", saveInterestProfile);
        document.getElementById("btn-new-interest-profile")?.addEventListener("click", resetInterestProfileForm);
        document.getElementById("btn-reset-interest-profile")?.addEventListener("click", resetInterestProfileForm);
        document.getElementById("btn-delete-interest-profile")?.addEventListener("click", deleteInterestProfile);
        document.getElementById("btn-run-test")?.addEventListener("click", runSimilarityTest);
        document.getElementById("btn-backtest-interest-profile")?.addEventListener("click", backtestInterestProfile);
        
        // Interest Profile search
        const interestSearchInput = document.getElementById("interest-profiles-search");
        if (interestSearchInput) {
            let interestSearchTimeout;
            interestSearchInput.addEventListener("input", (e) => {
                clearTimeout(interestSearchTimeout);
                interestSearchTimeout = setTimeout(() => {
                    filterInterestProfiles(e.target.value);
                }, 300);
            });
        }
        
        // Interest Profile bulk actions dropdown
        const interestBulkActionsBtn = document.getElementById("btn-interest-bulk-actions");
        if (interestBulkActionsBtn) {
            let interestDropdown = document.querySelector(".interest-bulk-dropdown");
            if (!interestDropdown) {
                interestDropdown = document.createElement("div");
                interestDropdown.className = "alert-bulk-dropdown interest-bulk-dropdown";
                interestDropdown.innerHTML = `
                    <button class="alert-bulk-dropdown-item" data-action="enable-all">Enable All</button>
                    <button class="alert-bulk-dropdown-item" data-action="disable-all">Disable All</button>
                    <button class="alert-bulk-dropdown-item" data-action="export-all">Export All</button>
                `;
                interestBulkActionsBtn.parentElement.style.position = "relative";
                interestBulkActionsBtn.parentElement.appendChild(interestDropdown);
                
                interestDropdown.querySelectorAll(".alert-bulk-dropdown-item").forEach(item => {
                    item.addEventListener("click", async (e) => {
                        e.stopPropagation();
                        const action = item.dataset.action;
                        interestDropdown.classList.remove("show");
                        
                        if (action === "enable-all") {
                            await bulkToggleInterestProfiles(true);
                        } else if (action === "disable-all") {
                            await bulkToggleInterestProfiles(false);
                        } else if (action === "export-all") {
                            exportAllInterestProfiles();
                        }
                    });
                });
            }
            
            interestBulkActionsBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                interestDropdown.classList.toggle("show");
            });
            
            document.addEventListener("click", (e) => {
                if (interestDropdown.classList.contains("show")) {
                    if (!interestDropdown.contains(e.target) && !interestBulkActionsBtn.contains(e.target)) {
                        interestDropdown.classList.remove("show");
                    }
                }
            });
        }
        
        // Advanced section toggle icon rotation
        const advancedCollapse = document.getElementById("advanced-config");
        const collapseIcon = document.getElementById("collapse-icon");
        
        if (advancedCollapse && collapseIcon) {
            if (advancedCollapse.classList.contains("show")) {
                collapseIcon.style.transform = "rotate(90deg)";
                collapseIcon.style.transition = "transform 0.2s ease";
            }
            
            advancedCollapse.addEventListener("show.bs.collapse", () => {
                collapseIcon.style.transform = "rotate(90deg)";
                collapseIcon.style.transition = "transform 0.2s ease";
            });
            
            advancedCollapse.addEventListener("hide.bs.collapse", () => {
                collapseIcon.style.transform = "";
                collapseIcon.style.transition = "transform 0.2s ease";
            });
        }
        
        // Schedule section toggle icon rotation (for all schedule chevrons)
        document.querySelectorAll('[data-bs-toggle="collapse"][data-bs-target^="#alert-schedule-"], [data-bs-toggle="collapse"][data-bs-target^="#global-schedule-"], [data-bs-toggle="collapse"][data-bs-target^="#interest-schedule-"]').forEach(button => {
            const chevron = button.querySelector('.schedule-chevron');
            const targetId = button.getAttribute('data-bs-target');
            const targetElement = document.querySelector(targetId);
            
            if (chevron && targetElement) {
                // Set initial state
                if (targetElement.classList.contains('show')) {
                    chevron.style.transform = 'rotate(90deg)';
                }
                chevron.style.transition = 'transform 0.2s ease';
                
                // Listen for collapse events
                targetElement.addEventListener('show.bs.collapse', () => {
                    chevron.style.transform = 'rotate(90deg)';
                });
                
                targetElement.addEventListener('hide.bs.collapse', () => {
                    chevron.style.transform = '';
                });
            }
        });
        
        // Export handler
        document.getElementById("btn-export-profiles")?.addEventListener("click", async () => {
            try {
                appendLog("Exporting interests...");
                const response = await fetch(interestProfileEndpoints.export);
                if (!response.ok) {
                    throw new Error("Export failed");
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `interests_${new Date().toISOString().replace(/[:.]/g, '-')}.yml`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                appendLog("Interests exported successfully");
                showToast("Interests exported", "success");
            } catch (error) {
                console.error(error);
                appendLog("Export failed");
                showToast("Export failed. Check console for details.", "error");
            }
        });
        
        // Import handler placeholder
        document.getElementById("btn-import-profiles")?.addEventListener("click", () => {
            showToast("Import not yet implemented", "info");
        });
    });
    
    // ============= DIGEST SCHEDULE UI HANDLERS (Phase 5) =============
    
    // Guard to prevent duplicate event listener registration
    let digestHandlersInitialized = false;
    
    /**
     * Setup digest schedule type change handlers
     * Shows/hides schedule-specific fields (daily_hour, weekly_day, etc.)
     */
    /**
     * Setup digest schedule handlers for a specific profile type
     * @param {string} prefix - Element ID prefix ('alert-', 'interest-', or '' for global)
     */
    function setupDigestScheduleHandlers(prefix = '') {
        for (let i = 1; i <= 3; i++) {
            const scheduleSelect = document.getElementById(`${prefix}digest-schedule-${i}-type`);
            if (!scheduleSelect) continue;
            
            scheduleSelect.addEventListener('change', function() {
                toggleScheduleSpecificFields(i, this.value, prefix);
            });
        }
        
        // Initialize visibility on page load
        for (let i = 1; i <= 3; i++) {
            const scheduleSelect = document.getElementById(`${prefix}digest-schedule-${i}-type`);
            if (scheduleSelect) {
                toggleScheduleSpecificFields(i, scheduleSelect.value, prefix);
            }
        }
    }
    
    /**
     * Toggle visibility of schedule-specific fields
     * @param {number} scheduleNum - Schedule number (1-3)
     * @param {string} scheduleType - Schedule type ('daily', 'weekly', etc.)
     * @param {string} prefix - Element ID prefix ('alert-', 'interest-', or '' for global)
     */
    function toggleScheduleSpecificFields(scheduleNum, scheduleType, prefix = '') {
        const dailySettings = document.getElementById(`${prefix}digest-schedule-${scheduleNum}-daily-settings`);
        const weeklyDaySettings = document.getElementById(`${prefix}digest-schedule-${scheduleNum}-weekly-settings`);
        const weeklyHourSettings = document.getElementById(`${prefix}digest-schedule-${scheduleNum}-weekly-hour-settings`);
        
        // Hide all first
        if (dailySettings) dailySettings.classList.add('d-none');
        if (weeklyDaySettings) weeklyDaySettings.classList.add('d-none');
        if (weeklyHourSettings) weeklyHourSettings.classList.add('d-none');
        
        // Show relevant fields based on schedule type
        if (scheduleType === 'daily' && dailySettings) {
            dailySettings.classList.remove('d-none');
        } else if (scheduleType === 'weekly') {
            if (weeklyDaySettings) weeklyDaySettings.classList.remove('d-none');
            if (weeklyHourSettings) weeklyHourSettings.classList.remove('d-none');
        }
    }
    
    /**
     * Extract digest configuration from form fields
     * @param {string} prefix - Element ID prefix ('alert-', 'interest-', or '' for global)
     * @returns {Object} Digest configuration with schedules and delivery settings
     */
    function extractDigestConfigFromForm(prefix = '') {
        const schedules = [];
        
        // Process all 3 possible schedules
        for (let i = 1; i <= 3; i++) {
            const scheduleType = document.getElementById(`${prefix}digest-schedule-${i}-type`)?.value;
            if (!scheduleType) continue; // Skip if no schedule selected
            
            const schedule = {
                schedule: scheduleType,
                enabled: true,
            };
            
            // Optional overrides
            const topN = document.getElementById(`${prefix}digest-schedule-${i}-top-n`)?.value;
            const minScore = document.getElementById(`${prefix}digest-schedule-${i}-min-score`)?.value;
            
            if (topN) schedule.top_n = parseInt(topN, 10);
            if (minScore) schedule.min_score = parseFloat(minScore);
            
            // Schedule-specific settings
            if (scheduleType === 'daily') {
                const dailyHour = document.getElementById(`${prefix}digest-schedule-${i}-daily-hour`)?.value;
                if (dailyHour) schedule.daily_hour = parseInt(dailyHour, 10);
            } else if (scheduleType === 'weekly') {
                const weeklyDay = document.getElementById(`${prefix}digest-schedule-${i}-weekly-day`)?.value;
                const weeklyHour = document.getElementById(`${prefix}digest-schedule-${i}-weekly-hour`)?.value;
                if (weeklyDay) schedule.weekly_day = parseInt(weeklyDay, 10);
                if (weeklyHour) schedule.weekly_hour = parseInt(weeklyHour, 10);
            }
            
            schedules.push(schedule);
        }
        
        // Delivery settings
        const mode = document.getElementById(`${prefix}digest-mode`)?.value || 'dm';
        const targetChannel = document.getElementById(`${prefix}digest-target-channel`)?.value || '';
        
        return {
            schedules: schedules,
            mode: mode,
            target_channel: targetChannel || null
        };
    }
    
    /**
     * Populate form fields from digest configuration
     * @param {Object} digestConfig - Digest configuration object
     * @param {string} prefix - Element ID prefix ('alert-', 'interest-', or '' for global)
     */
    function populateDigestConfigInForm(digestConfig, prefix = '') {
        if (!digestConfig) {
            // Clear all digest fields
            for (let i = 1; i <= 3; i++) {
                const typeSelect = document.getElementById(`${prefix}digest-schedule-${i}-type`);
                if (typeSelect) typeSelect.value = '';
                toggleScheduleSpecificFields(i, '', prefix);
            }
            const modeSelect = document.getElementById(`${prefix}digest-mode`);
            const targetChannelInput = document.getElementById(`${prefix}digest-target-channel`);
            if (modeSelect) modeSelect.value = 'dm';
            if (targetChannelInput) targetChannelInput.value = '';
            return;
        }
        
        // Populate schedules (up to 3)
        const schedules = digestConfig.schedules || [];
        for (let i = 0; i < 3; i++) {
            const schedNum = i + 1;
            const schedule = schedules[i];
            
            if (schedule) {
                // Set schedule type
                const typeSelect = document.getElementById(`${prefix}digest-schedule-${schedNum}-type`);
                if (typeSelect) typeSelect.value = schedule.schedule || '';
                
                // Set optional overrides
                const topNInput = document.getElementById(`${prefix}digest-schedule-${schedNum}-top-n`);
                const minScoreInput = document.getElementById(`${prefix}digest-schedule-${schedNum}-min-score`);
                
                if (topNInput) topNInput.value = schedule.top_n || '';
                if (minScoreInput) minScoreInput.value = schedule.min_score || '';
                
                // Set schedule-specific fields
                if (schedule.schedule === 'daily') {
                    const dailyHourInput = document.getElementById(`${prefix}digest-schedule-${schedNum}-daily-hour`);
                    if (dailyHourInput) dailyHourInput.value = schedule.daily_hour || 8;
                } else if (schedule.schedule === 'weekly') {
                    const weeklyDaySelect = document.getElementById(`${prefix}digest-schedule-${schedNum}-weekly-day`);
                    const weeklyHourInput = document.getElementById(`${prefix}digest-schedule-${schedNum}-weekly-hour`);
                    
                    if (weeklyDaySelect) weeklyDaySelect.value = schedule.weekly_day || 0;
                    if (weeklyHourInput) weeklyHourInput.value = schedule.weekly_hour || 8;
                }
                
                // Show/hide relevant fields
                toggleScheduleSpecificFields(schedNum, schedule.schedule || '', prefix);
            } else {
                // Clear schedule
                const typeSelect = document.getElementById(`${prefix}digest-schedule-${schedNum}-type`);
                if (typeSelect) typeSelect.value = '';
                toggleScheduleSpecificFields(schedNum, '', prefix);
            }
        }
        
        // Populate delivery settings
        const modeSelect = document.getElementById(`${prefix}digest-mode`);
        const targetChannelInput = document.getElementById(`${prefix}digest-target-channel`);
        
        if (modeSelect) modeSelect.value = digestConfig.mode || 'dm';
        if (targetChannelInput) targetChannelInput.value = digestConfig.target_channel || '';
    }
    
    // Initialize digest schedule handlers on page load for all profile types
    document.addEventListener('DOMContentLoaded', () => {
        setupDigestScheduleHandlers('');          // Global Profiles (no prefix)
        setupDigestScheduleHandlers('alert-');    // Alert Profiles
        setupDigestScheduleHandlers('interest-'); // Interest Profiles
        
        // Add validation for digest target channel
        const globalProfileForm = document.getElementById('global-profile-form');
        if (globalProfileForm) {
            globalProfileForm.addEventListener('submit', function(event) {
                const digestMode = document.getElementById('digest-mode');
                const digestTargetChannel = document.getElementById('digest-target-channel');
                
                if (digestMode && digestTargetChannel) {
                    const mode = digestMode.value;
                    const target = digestTargetChannel.value.trim();
                    
                    // Validate that target channel is provided when mode is "channel" or "both"
                    if ((mode === 'channel' || mode === 'both') && !target) {
                        event.preventDefault();
                        
                        // Set custom validity message
                        digestTargetChannel.setCustomValidity('Target channel is required when delivery mode is "Channel Only" or "Both DM & Channel"');
                        digestTargetChannel.reportValidity();
                        
                        // Also show toast for better visibility
                        if (typeof showToast === 'function') {
                            showToast('Target channel is required for the selected delivery mode', 'error');
                        }
                        
                        // Focus the input field
                        digestTargetChannel.focus();
                        
                        return false;
                    } else {
                        // Clear any previous custom validity
                        digestTargetChannel.setCustomValidity('');
                    }
                }
            });
            
            // Clear custom validity on input to allow resubmission
            const digestTargetChannel = document.getElementById('digest-target-channel');
            if (digestTargetChannel) {
                digestTargetChannel.addEventListener('input', function() {
                    this.setCustomValidity('');
                });
            }
        }
        
        // Fetch and populate monitored channels and users for profile restrictions
        fetchMonitoredEntities();
        
        // Set up entity selection modal handlers
        setupEntitySelectionModal();
    });
    
    // Global cache for monitored channels and users
    let monitoredChannels = [];
    let monitoredUsers = [];
    let entitiesFetched = false;
    
    // Track which profile type is being edited (for modal context)
    let currentProfileTypeForModal = null;  // 'alert' or 'interest'
    
    // Selected entities for each profile type
    let selectedChannelsInterest = [];
    let selectedUsersInterest = [];
    let selectedChannelsAlert = [];
    let selectedUsersAlert = [];
    
    /**
     * Fetch monitored channels and users from the API
     */
    async function fetchMonitoredEntities() {
        try {
            // Fetch channels
            const channelsResponse = await fetch('/api/config/channels');
            if (channelsResponse.ok) {
                const channelsData = await channelsResponse.json();
                monitoredChannels = channelsData.channels || [];
                console.log('Loaded', monitoredChannels.length, 'monitored channels');
            } else {
                console.error('Failed to fetch channels:', channelsResponse.statusText);
            }
            
            // Fetch users
            const usersResponse = await fetch('/api/config/users');
            if (usersResponse.ok) {
                const usersData = await usersResponse.json();
                monitoredUsers = usersData.users || [];
                console.log('Loaded', monitoredUsers.length, 'monitored users');
            } else {
                console.error('Failed to fetch users:', usersResponse.statusText);
            }
            
            entitiesFetched = true;
        } catch (error) {
            console.error('Error fetching monitored entities:', error);
            entitiesFetched = false;
        }
    }
    
    /**
     * Set up the entity selection modal handlers
     */
    function setupEntitySelectionModal() {
        const modal = document.getElementById('selectEntitiesModal');
        if (!modal) return;
        
        // When modal is shown, populate it based on which button was clicked
        modal.addEventListener('show.bs.modal', async function(event) {
            const button = event.relatedTarget;
            if (button) {
                // Determine which profile type triggered the modal
                if (button.id === 'btn-select-entities-alert') {
                    currentProfileTypeForModal = 'alert';
                } else if (button.id === 'btn-select-entities-interest') {
                    currentProfileTypeForModal = 'interest';
                }
            }
            
            // Show loading state
            const channelsLoading = document.getElementById('modal-channels-loading');
            const usersLoading = document.getElementById('modal-users-loading');
            if (channelsLoading) channelsLoading.classList.remove('d-none');
            if (usersLoading) usersLoading.classList.remove('d-none');
            
            // Fetch entities if not already loaded
            if (!entitiesFetched) {
                await fetchMonitoredEntities();
            }
            
            // Populate modal with current selections
            populateModalEntities();
        });
        
        // Handle Apply Selection button
        document.getElementById('btn-apply-entity-selection')?.addEventListener('click', function() {
            applyModalSelection();
            const modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) {
                modalInstance.hide();
            }
        });
        
        // Handle Select All buttons
        document.getElementById('btn-select-all-modal-channels')?.addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('#modal-channels-checkboxes input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
        });
        
        document.getElementById('btn-select-all-modal-users')?.addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('#modal-users-checkboxes input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
        });
        
        // Handle search filtering
        document.getElementById('modal-channels-search')?.addEventListener('input', function(e) {
            filterModalList('modal-channels-checkboxes', e.target.value);
        });
        
        document.getElementById('modal-users-search')?.addEventListener('input', function(e) {
            filterModalList('modal-users-checkboxes', e.target.value);
        });
    }
    
    /**
     * Populate the modal with channels and users, pre-selecting current choices
     */
    function populateModalEntities() {
        const currentChannels = currentProfileTypeForModal === 'alert' ? selectedChannelsAlert : selectedChannelsInterest;
        const currentUsers = currentProfileTypeForModal === 'alert' ? selectedUsersAlert : selectedUsersInterest;
        
        // Populate channels
        const channelsContainer = document.getElementById('modal-channels-checkboxes');
        const channelsLoading = document.getElementById('modal-channels-loading');
        const channelsList = document.getElementById('modal-channels-list');
        const channelsError = document.getElementById('modal-channels-error');
        
        if (monitoredChannels.length === 0) {
            channelsLoading.classList.add('d-none');
            channelsList.classList.add('d-none');
            channelsError.classList.remove('d-none');
            channelsError.textContent = 'No monitored channels configured. Please add channels in Configuration first.';
        } else {
            channelsLoading.classList.add('d-none');
            channelsList.classList.remove('d-none');
            channelsError.classList.add('d-none');
            
            channelsContainer.innerHTML = monitoredChannels.map(channel => {
                const isChecked = currentChannels.includes(channel.id);
                const displayName = channel.name || channel.title || channel.username || `Channel ${channel.id}`;
                const initials = displayName.split(' ').map(w => w[0]).slice(0, 2).join('').toUpperCase();
                const isChat = channel.id < 0;
                const prefix = isChat ? "chat" : "user";
                const avatarUrl = `/api/avatar/${prefix}/${Math.abs(channel.id)}`;
                const bgColor = channel.type === 'channel' ? '#0d6efd' : channel.type === 'supergroup' ? '#0dcaf0' : '#6c757d';
                
                return `
                    <label class="list-group-item list-group-item-action d-flex align-items-center py-2 gap-2" data-entity-name="${displayName.toLowerCase()}" style="cursor: pointer;">
                        <input class="form-check-input" type="checkbox" value="${channel.id}" ${isChecked ? 'checked' : ''} style="flex-shrink: 0;">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 32px; height: 32px; flex-shrink: 0; font-size: 0.75rem; font-weight: 600; color: white; background-color: ${bgColor}; position: relative; overflow: hidden;">
                            <img src="${avatarUrl}" alt="${escapeHtml(displayName)}" 
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                                 onerror="this.style.display='none'; const initials = '${initials}'; this.parentElement.querySelector('span').textContent = initials || '?';">
                            <span style="position: relative; z-index: 1;"></span>
                        </div>
                        <div class="flex-grow-1" style="min-width: 0;">
                            <div class="fw-semibold text-truncate">${escapeHtml(displayName)}</div>
                            <small class="text-muted">ID: ${channel.id}</small>
                        </div>
                    </label>
                `;
            }).join('');
        }
        
        document.getElementById('channels-count-badge').textContent = monitoredChannels.length;
        
        // Populate users
        const usersContainer = document.getElementById('modal-users-checkboxes');
        const usersLoading = document.getElementById('modal-users-loading');
        const usersList = document.getElementById('modal-users-list');
        const usersError = document.getElementById('modal-users-error');
        
        if (monitoredUsers.length === 0) {
            usersLoading.classList.add('d-none');
            usersList.classList.add('d-none');
            usersError.classList.remove('d-none');
            usersError.textContent = 'No monitored users configured. Please add users in Configuration first.';
        } else {
            usersLoading.classList.add('d-none');
            usersList.classList.remove('d-none');
            usersError.classList.add('d-none');
            
            usersContainer.innerHTML = monitoredUsers.map(user => {
                const isChecked = currentUsers.includes(user.id);
                const displayName = [user.first_name, user.last_name].filter(Boolean).join(' ').trim() 
                    || user.name 
                    || user.username 
                    || `User ${user.id}`;
                const initials = displayName.split(' ').map(w => w[0]).slice(0, 2).join('').toUpperCase();
                const avatarUrl = `/api/avatar/user/${user.id}`;
                
                return `
                    <label class="list-group-item list-group-item-action d-flex align-items-center py-2 gap-2" data-entity-name="${displayName.toLowerCase()}" style="cursor: pointer;">
                        <input class="form-check-input" type="checkbox" value="${user.id}" ${isChecked ? 'checked' : ''} style="flex-shrink: 0;">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 32px; height: 32px; flex-shrink: 0; font-size: 0.75rem; font-weight: 600; color: white; background-color: #6f42c1; position: relative; overflow: hidden;">
                            <img src="${avatarUrl}" alt="${escapeHtml(displayName)}" 
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                                 onerror="this.style.display='none'; const initials = '${initials}'; this.parentElement.querySelector('span').textContent = initials || '?';">
                            <span style="position: relative; z-index: 1;"></span>
                        </div>
                        <div class="flex-grow-1" style="min-width: 0;">
                            <div class="fw-semibold text-truncate">${escapeHtml(displayName)}</div>
                            <small class="text-muted">ID: ${user.id}${user.username ? ' ‚Ä¢ @' + user.username : ''}</small>
                        </div>
                    </label>
                `;
            }).join('');
        }
        
        document.getElementById('users-count-badge').textContent = monitoredUsers.length;
    }
    
    /**
     * Apply the modal selection to the current profile
     */
    function applyModalSelection() {
        // Get selected channels
        const selectedChannelIds = Array.from(
            document.querySelectorAll('#modal-channels-checkboxes input[type="checkbox"]:checked')
        ).map(cb => parseInt(cb.value, 10));
        
        // Get selected users
        const selectedUserIds = Array.from(
            document.querySelectorAll('#modal-users-checkboxes input[type="checkbox"]:checked')
        ).map(cb => parseInt(cb.value, 10));
        
        // Update the appropriate profile's selections
        if (currentProfileTypeForModal === 'alert') {
            selectedChannelsAlert = selectedChannelIds;
            selectedUsersAlert = selectedUserIds;
            updateEntityBadges('alert', selectedChannelIds, selectedUserIds);
        } else if (currentProfileTypeForModal === 'interest') {
            selectedChannelsInterest = selectedChannelIds;
            selectedUsersInterest = selectedUserIds;
            updateEntityBadges('interest', selectedChannelIds, selectedUserIds);
        }
    }
    
    /**
     * Update the badge display for selected entities
     */
    function updateEntityBadges(profileType, channelIds, userIds) {
        const badgesContainer = document.getElementById(`entities-badges-${profileType}`);
        const placeholder = document.getElementById(`entities-placeholder-${profileType}`);
        
        if (!badgesContainer || !placeholder) return;
        
        const badges = [];
        
        // Add channel badges
        channelIds.forEach(id => {
            const channel = monitoredChannels.find(c => c.id === id);
            if (channel) {
                const displayName = channel.name || channel.title || channel.username || `Channel ${id}`;
                const initials = displayName.split(' ').map(w => w[0]).slice(0, 2).join('').toUpperCase();
                const isChat = id < 0;
                const prefix = isChat ? "chat" : "user";
                const avatarUrl = `/api/avatar/${prefix}/${Math.abs(id)}`;
                badges.push(`
                    <span class="badge bg-primary d-inline-flex align-items-center gap-2 py-2 px-2" style="font-size: 0.875rem; max-width: 250px;" title="${escapeHtml(displayName)}">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 20px; height: 20px; font-size: 0.65rem; font-weight: 600; color: white; background-color: #0d6efd; position: relative; overflow: hidden; flex-shrink: 0;">
                            <img src="${avatarUrl}" alt="${escapeHtml(displayName)}" 
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                                 onerror="this.style.display='none'; this.parentElement.style.backgroundColor='#0d6efd'; const initials = '${initials}'; this.nextElementSibling.textContent = initials || '?';">
                            <span style="position: relative; z-index: 1;"></span>
                        </div>
                        <span class="text-truncate" style="min-width: 0;">${escapeHtml(displayName)}</span>
                        <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.65rem; flex-shrink: 0;" 
                                onclick="removeEntity('${profileType}', 'channel', ${id})" aria-label="Remove"></button>
                    </span>
                `);
            }
        });
        
        // Add user badges
        userIds.forEach(id => {
            const user = monitoredUsers.find(u => u.id === id);
            if (user) {
                const displayName = [user.first_name, user.last_name].filter(Boolean).join(' ').trim() 
                    || user.name 
                    || user.username 
                    || `User ${id}`;
                const initials = displayName.split(' ').map(w => w[0]).slice(0, 2).join('').toUpperCase();
                const avatarUrl = `/api/avatar/user/${id}`;
                badges.push(`
                    <span class="badge bg-success d-inline-flex align-items-center gap-2 py-2 px-2" style="font-size: 0.875rem; max-width: 250px;" title="${escapeHtml(displayName)}">
                        <div class="rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 20px; height: 20px; font-size: 0.65rem; font-weight: 600; color: white; background-color: #6f42c1; position: relative; overflow: hidden; flex-shrink: 0;">
                            <img src="${avatarUrl}" alt="${escapeHtml(displayName)}" 
                                 style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                                 onerror="this.style.display='none'; this.parentElement.style.backgroundColor='#6f42c1'; const initials = '${initials}'; this.nextElementSibling.textContent = initials || '?';">
                            <span style="position: relative; z-index: 1;"></span>
                        </div>
                        <span class="text-truncate" style="min-width: 0;">${escapeHtml(displayName)}</span>
                        <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.65rem; flex-shrink: 0;" 
                                onclick="removeEntity('${profileType}', 'user', ${id})" aria-label="Remove"></button>
                    </span>
                `);
            }
        });
        
        if (badges.length > 0) {
            placeholder.classList.add('d-none');
            badgesContainer.innerHTML = badges.join('');
            badgesContainer.classList.remove('d-none');
        } else {
            placeholder.classList.remove('d-none');
            badgesContainer.innerHTML = '';
            badgesContainer.classList.add('d-none');
        }
    }
    
    /**
     * Remove a specific entity from selection
     */
    function removeEntity(profileType, entityType, entityId) {
        if (profileType === 'alert') {
            if (entityType === 'channel') {
                selectedChannelsAlert = selectedChannelsAlert.filter(id => id !== entityId);
            } else {
                selectedUsersAlert = selectedUsersAlert.filter(id => id !== entityId);
            }
            updateEntityBadges('alert', selectedChannelsAlert, selectedUsersAlert);
        } else if (profileType === 'interest') {
            if (entityType === 'channel') {
                selectedChannelsInterest = selectedChannelsInterest.filter(id => id !== entityId);
            } else {
                selectedUsersInterest = selectedUsersInterest.filter(id => id !== entityId);
            }
            updateEntityBadges('interest', selectedChannelsInterest, selectedUsersInterest);
        }
    }
    
    /**
     * Filter modal list items by search text
     */
    function filterModalList(containerId, searchText) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const items = container.querySelectorAll('.list-group-item');
        const lowerSearch = searchText.toLowerCase();
        
        items.forEach(item => {
            const entityName = item.getAttribute('data-entity-name') || '';
            if (entityName.includes(lowerSearch)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    /**
     * Get selected entity IDs for saving (from current selections)
     * @param {string} profileType - 'alert' or 'interest'
     * @param {string} entityType - 'channels' or 'users'
     * @returns {Array<number>} Array of selected numeric IDs
     */
    function getSelectedEntityIds(profileType, entityType) {
        if (profileType === 'alert') {
            return entityType === 'channels' ? selectedChannelsAlert : selectedUsersAlert;
        } else if (profileType === 'interest') {
            return entityType === 'channels' ? selectedChannelsInterest : selectedUsersInterest;
        }
        return [];
    }
    
    /**
     * Set selected options for a profile type when loading
     * @param {string} profileType - 'alert' or 'interest'
     * @param {Array<number>} channelIds - Array of numeric channel IDs
     * @param {Array<number>} userIds - Array of numeric user IDs
     */
    function setSelectedEntityIds(profileType, channelIds, userIds) {
        const channels = Array.isArray(channelIds) ? channelIds : [];
        const users = Array.isArray(userIds) ? userIds : [];
        
        if (profileType === 'alert') {
            selectedChannelsAlert = channels;
            selectedUsersAlert = users;
            updateEntityBadges('alert', channels, users);
        } else if (profileType === 'interest') {
            selectedChannelsInterest = channels;
            selectedUsersInterest = users;
            updateEntityBadges('interest', channels, users);
        }
    }
</script>

<!-- Digest Schedule Editor Component -->
<script src="{{ url_for('static', filename='js/components/digest_editor.js') }}"></script>

{% endblock %}
